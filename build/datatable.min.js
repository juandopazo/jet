/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datatable",function(b){var i=b.Lang,r=b.Array;if(!jet.DataTable)jet.DataTable={};if(!i.isNumber(jet.DataTable.ids))jet.DataTable.ids=0;var s=function(){s.superclass.constructor.apply(this,arguments);var g=this.addAttrs({recordSet:{value:new b.RecordSet},columnDefinitions:{required:true,validator:i.isArray},className:{writeOnce:true,value:"dt"}}),l=jet.DataTable.ids++,m=g.get("recordSet"),p=g.get("classPrefix"),o=g.get("className"),d=p+o+"-",n=d+l+"rec",u=d+l+"th-",v=b("<table/>").attr("id",
d+l),w=b("<thead/>").appendTo(v).append(b("<tr/>")),j=b("<tbody/>").addClass(d+"data").appendTo(v),q,x=function(a,e){var f=a.attr("id").split("-").pop(),c=a.hasClass(d+"desc"),h=c?"desc":"asc",k=c?"asc":"desc";if(!e){c=h;h=k;k=c}w.find("th").removeClass(d+h,d+k);a.addClass(d+h).removeClass(d+k);m.sortBy(f,h);q=f;h=m.getRecords();c=h.length;var z,A;k=d+(c%2===0?"even":"odd");var t=d+(c%2===0?"odd":"even");b("#"+n+h[c-1].getId()).addClass(c%2===0?t:k).removeClass(c%2===0?k:t);for(c=c-2;c>=0;c--){z=
b("#"+n+h[c].getId());A=b("#"+n+h[c+1].getId());z.addClass(c%2===0?k:t).removeClass(c%2===0?t:k).insertBefore(A)}j.find("."+d+"desc").removeClass(d+"desc");j.find("."+d+"col-"+f).addClass(d+"desc")},B=g.get("columnDefinitions");r.each(B,function(a,e){var f=b("<th/>").append(b("<div/>").addClass(d+"liner").append(b("<span/>").addClass(d+"label").html(a.label||a.key)));f.attr("id",u+a.key);if(e===0)f.addClass(d+"first");else e==B.length-1&&f.addClass(d+"last");a.sortable&&f.addClass(d+"sortable").on("click",
function(c){c.stopPropagation();c.preventDefault();x(f)});w.first().append(f)});var C=function(a){i.isRecord(a)||(a=new b.Record(a));var e=b("<tr/>").attr("id",n+a.getId());r.each(g.get("columnDefinitions"),function(f){var c=a.get(f.key),h=b("<td/>").addClass(p+o+"-col-"+f.key);h.append(b("<div/>").addClass(d+"liner").html(f.formatter?f.formatter(c,a.getData(),h):c)).appendTo(e)});e.addClass(j.children().length%2===0?d+"even":d+"odd").appendTo(j)};this.set("tbody",j).set("thead",w);this.addRow=function(a){C(a);
q&&x(b("#"+u+q));return g};this.addRows=function(a){if(i.isArray(a))r.each(a,function(e){i.isRecord(e)||new b.Record(e)});else if(i.isRecordSet(a))a=a.getRecords();r.each(a,C);q&&x(b("#"+u+q),true)};this.getFirstTr=function(){return j.children().eq(0)};this.getNextTr=function(a){if(i.isRecord(a))a=a.getId();if(i.isNumber(a))a=j.find("#"+n+a);return a.next()};this.getFirstTd=function(a){if(i.isRecord(a))a=a.getId();if(i.isNumber(a))a=j.find("#"+n+a);return a.children().eq(0)};this.getNextTd=function(a){if(i.isRecord(a))a=
a.getId();if(i.isNumber(a))a=j.find("#"+n+a).children(a-1);return a.next()};this.onDataReturnReplaceRows=function(a,e){j.children().remove();g.addRows(e);m.replace(e)};this.onDataReturnAddRows=function(a,e){g.addRows(e);m.push(e)};this.on("render",function(){g.onDataReturnAddRows(null,m);g.get("boundingBox").addClass(p+o).append(v)})};b.extend(s,b.Widget);var y=function(){y.superclass.constructor.apply(this,arguments);var g=this.on("afterRender",function(){var l=g.get("boundingBox"),m=b("<table/>"),
p=g.get("tbody"),o=g.get("thead");console.log(o.parent()[0].offsetWidth);l=b("<div/>").appendTo(l).css("overflowY","auto").height(300).width(o.width());m.append(p.detach()).appendTo(l)})};b.extend(y,s);b.add({DataTable:s,ScrollableDataTable:y})});
