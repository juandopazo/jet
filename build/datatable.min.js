/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datatable",function(b){var k=b.Lang,s=b.Array;if(!jet.DataTable)jet.DataTable={};if(!k.isNumber(jet.DataTable.ids))jet.DataTable.ids=0;var x=function(){x.superclass.constructor.apply(this,arguments);this.addAttrs({value:{required:true,writeOnce:true},td:{required:true,writeOnce:true},record:{required:true,writeOnce:true}})};b.extend(x,b.Base);var t=function(){t.superclass.constructor.apply(this,arguments);var f=this.addAttrs({cells:{required:true,writeOnce:true}});this.getFirstTd=function(){return f.get("cells")[0].get("td")};
this.getNextTd=function(m){var i=f.get("cells"),n=i.length,h;for(h=0;h<n;h++)if(i[h].get("td")==m)break;return h<n-2?i[++h].get("td"):null};this.getFirstCell=function(){return f.get("cells")[0]};this.getNextCell=function(m){var i=f.get("cells"),n=i.length,h;for(h=0;h<n;h++)if(i[h]==m)break;return h<n-2?i[++h]:null}};b.extend(t,b.Base);var u=function(){u.superclass.constructor.apply(this,arguments);var f=this.addAttrs({recordSet:{value:new b.RecordSet},columnDefinitions:{required:true,validator:k.isArray},
className:{writeOnce:true,value:"dt"}}),m=jet.DataTable.ids++,i=f.get("recordSet"),n=f.get("classPrefix"),h=f.get("className"),e=n+h+"-",p=e+m+"rec",y=e+m+"th-",z=b("<table/>").attr("id",e+m),A=b("<thead/>").appendTo(z).append(b("<tr/>")),o=b("<tbody/>").addClass(e+"data").appendTo(z),r,B=function(a,g){var d=a.attr("id").split("-").pop(),c=a.hasClass(e+"desc"),j=c?"desc":"asc",l=c?"asc":"desc";if(!g){c=j;j=l;l=c}A.find("th").removeClass(e+j,e+l);a.addClass(e+j).removeClass(e+l);i.sortBy(d,j);r=d;
j=i.getRecords();c=j.length;var v,w;l=e+(c%2===0?"even":"odd");var q=e+(c%2===0?"odd":"even");b("#"+p+j[c-1].getId()).addClass(c%2===0?q:l).removeClass(c%2===0?l:q);for(c=c-2;c>=0;c--){v=b("#"+p+j[c].getId());w=b("#"+p+j[c+1].getId());v.addClass(c%2===0?l:q).removeClass(c%2===0?q:l).insertBefore(w)}o.find("."+e+"desc").removeClass(e+"desc");o.find("."+e+"col-"+d).addClass(e+"desc")},D=f.get("columnDefinitions");s.each(D,function(a,g){var d=b("<th/>").append(b("<div/>").addClass(e+"liner").append(b("<span/>").addClass(e+
"label").html(a.label||a.key)));d.attr("id",y+a.key);if(g===0)d.addClass(e+"first");else g==D.length-1&&d.addClass(e+"last");a.sortable&&d.addClass(e+"sortable").on("click",function(c){c.stopPropagation();c.preventDefault();B(d)});A.first().append(d)});var E=function(a){k.isRecord(a)||(a=new b.Record(a));var g=b("<tr/>").attr("id",p+a.getId());s.each(f.get("columnDefinitions"),function(d){var c=a.get(d.key),j=b("<td/>").addClass(n+h+"-col-"+d.key);j.append(b("<div/>").addClass(e+"liner").html(d.formatter?
d.formatter(c,a.getData(),j):c)).appendTo(g)});g.addClass(o.children().length%2===0?e+"even":e+"odd").appendTo(o)};this.set("tbody",o).set("thead",A);this.addRow=function(a){E(a);r&&B(b("#"+y+r));return f};this.addRows=function(a){if(k.isArray(a))s.each(a,function(g){k.isRecord(g)||new b.Record(g)});else if(k.isRecordSet(a))a=a.getRecords();s.each(a,E);r&&B(b("#"+y+r),true)};this.getColumn=function(a){var g=[],d,c=i.getRecords(),j=c.length,l=f.get("columnDefinitions"),v=o.children(),w=k.isNumber(a)?
l[a].key:a,q=a;if(!k.isNumber(a))for(d=0;d<l.length;d++)if(l[d].key==a){q=d;break}for(d=0;d<j;d++)g[g.length]=new x({record:c[d],td:v.eq(d).children().eq(q),value:c[d].get(w)});return new t({cells:g})};this.getFirstTr=function(){return o.children().eq(0)};this.getNextTr=function(a){if(k.isRecord(a))a=a.getId();if(k.isNumber(a))a=o.find("#"+p+a);return a.next()};this.getFirstTd=function(a){if(k.isRecord(a))a=a.getId();if(k.isNumber(a))a=o.find("#"+p+a);return a.children().eq(0)};this.getNextTd=function(a){if(k.isRecord(a))a=
a.getId();if(k.isNumber(a))a=o.find("#"+p+a).children(a-1);return a.next()};this.onDataReturnReplaceRows=function(a,g){o.children().remove();f.addRows(g);i.replace(g)};this.onDataReturnAddRows=function(a,g){f.addRows(g);i.push(g)};this.on("render",function(){f.onDataReturnAddRows(null,i);f.get("boundingBox").addClass(n+h).append(z)})};b.extend(u,b.Widget);var C=function(){C.superclass.constructor.apply(this,arguments);var f=this.on("afterRender",function(){var m=f.get("boundingBox"),i=b("<table/>"),
n=f.get("tbody"),h=f.get("thead");m=b("<div/>").appendTo(m).css("overflowY","auto").height(300).width(h.width());i.append(n.detach()).appendTo(m)})};b.extend(C,u);b.add({DataTable:u,ScrollableDataTable:C,Column:t})});
