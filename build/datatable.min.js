/**
 * @module datatable
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("datatable",function(d){var q=d.Array,o=d.Base,r=d.Widget,p=d.Record,v=d.RecordSet,w=o.create("cell",o,[],{ATTRS:{value:{required:true,writeOnce:true},td:{required:true,writeOnce:true},record:{required:true,writeOnce:true}}}),s=o.create("column",o,[],{ATTRS:{cells:{required:true,writeOnce:true}}},{getFirstTd:function(){return this.get("cells")[0].get("td")},getNextTd:function(a){var b=this.get("cells"),c=b.length,f;for(f=0;f<c;f++)if(b[f].get("td")==a)break;return f<c-2?b[++f].get("td"):null},
getFirstCell:function(){return this.get("cells")[0]},getNextCell:function(a){var b=this.get("cells"),c=b.length,f;for(f=0;f<c;f++)if(b[f]==a)break;return f<c-2?b[++f]:null}}),n=d.Lang;r=o.create("dt",r,[],{ATTRS:{recordSet:{},columnDefinitions:{required:true,validator:n.isArray},thead:{value:"<thead/>",setter:d},tbody:{value:"<tbody/>",setter:d},recordIdPrefix:{readOnly:true,getter:function(){return this.getClassName(this._uid+"rec")}}}},{CONTENT_TEMPLATE:"<table/>",initializer:function(){this.set("thead",
this.get("thead"));this.set("tbody",this.get("tbody"));this.get("recordSet")||this.set("recordSet",new d.RecordSet)},renderUI:function(){var a=this.get("contentBox");a._nodes[0].setAttribute("cellspacing","0px");var b=this.get("thead"),c=this.get("tbody");this._setupTableHeaders();b.appendTo(a);c.addClass(this.getClassName("data")).appendTo(a)},syncUI:function(){this.onDataReturnAddRows({target:this,type:"update",data:this.get("recordSet")})},_onThClick:function(a){a.stopPropagation();a.preventDefault();
a=a.target;for(var b=this.get("thead").first()._nodes[0];a.parentNode!=b;)a=a.parentNode;this._sort(d(a))},_setupTableHeaders:function(){var a=this.get("columnDefinitions"),b=d.bind(this.getClassName,this),c=b("liner"),f=b("label"),h=b("sortable"),e=this._uid,g=this,j=this.get("thead"),l=d("<tr/>").addClass(b("first"),b("last")).appendTo(j);q.each(a,function(k,m){var i=d("<span/>").addClass(f).html(k.label||k.key);i=d("<div/>").addClass(c).append(i);i=d("<th/>").append(i);i.attr("id",b(e,"th",k.key));
if(m===0)i.addClass(b("first"));else m==a.length-1&&i.addClass(b("last"));i.addClass(b("col",k.key));k.sortable&&g._handlers.push(i.addClass(h).on("click",g._onThClick,g));n.isNumber(k.width)&&i.width(k.width);l.append(i)})},_sort:function(a,b){var c=d.bind(this.getClassName,this),f=a.attr("id").split("-").pop(),h=c("desc"),e=a.hasClass(h),g=e?"desc":"asc",j=e?"asc":"desc",l=this.get("thead"),k=this.get("tbody"),m=this.get("recordSet");this.get("sortedBy");var i=this.get("recordIdPrefix");if(!b){e=
g;g=j;j=e}l.find("th").removeClass(c(g),c(j));a.addClass(c(g)).removeClass(c(j));m.sortBy(f,g);m=m.getRecords();g=m.length;var t,u;j=c(g%2===0?"even":"odd");l=c(g%2===0?"odd":"even");d("#"+i+m[g-1].getId()).addClass(g%2===0?l:j).removeClass(g%2===0?j:l);for(e=g-2;e>=0;e--){t=k.find("#"+i+m[e].getId());u=k.find("#"+i+m[e+1].getId());t.insertBefore(u)}i=k.children();for(e=0;e<g;e++)i.item(e).addClass(e%2===0?j:l).removeClass(e%2===0?l:j);k.find("."+h).removeClass(h);k.find("."+c("col",f)).addClass(h)},
_addRow:function(a){p.hasInstance(a)||(a=new d.Record(a));var b=this.get("recordIdPrefix"),c=d("<tr/>").attr("id",b+a.getId()),f=d.bind(this.getClassName,this);b=this.get("tbody");q.each(this.get("columnDefinitions"),function(h){var e=a.get(h.key),g=d("<td/>").addClass(f("col",h.key));h=h.formatter?h.formatter(e,a.getData(),g):e;e=d("<div/>").addClass(f("liner"));n.isString(h)?e.html(h):e.append(h);g.append(e).appendTo(c)});c.addClass(f(b.children().size()%2===0?"even":"odd")).appendTo(b)},addRow:function(a){if(this.fire("addRow",
a)){this._addRow(a);(a=this.get("sortedBy"))&&this._sort(d("#"+this.getClassName(this._uid,"th",a)));this.fire("afterAddRow")}return this},addRows:function(a){if(this.fire("addRows",{rows:a})){if(n.isArray(a))q.each(a,function(c){p.hasInstance(c)||new d.Record(c)});else if(v.hasInstance(a))a=a.getRecords();q.each(a,this._addRow,this);var b=this.get("sortedBy");b&&this._sort(d("#"+this.getClassName(this._uid,"th",b)),true);this.fire("afterAddRows",{rows:a})}return this},getColumn:function(a){var b=
[],c,f=this.get("recordSet").getRecords(),h=f.length,e=this.get("columnDefinitions"),g=this.get("tbody").children(),j=n.isNumber(a)?e[a].key:a,l=a;if(!n.isNumber(a))for(c=0;c<e.length;c++)if(e[c].key==a){l=c;break}for(c=0;c<h;c++)b[b.length]=new w({record:f[c],td:g.item(c).children().item(l),value:f[c].get(j)});return new s({cells:b})},getFirstTr:function(){return this.get("tbody").children().item(0)},getNextTr:function(a){if(p.hasInstance(a))a=a.getId();if(n.isNumber(a))a=this.get("tbody").find("#"+
this.get("recordIdPrefix")+a);return a.next()},getFirstTd:function(a){if(p.hasInstance(a))a=a.getId();if(n.isNumber(a))a=this.get("tbody").find("#"+this.get("recordIdPrefix")+a);return a.children().item(0)},getNextTd:function(a){if(p.hasInstance(a))a=a.getId();if(n.isNumber(a))a=this.get("tbody").find("#"+this.get("recordIdPrefix")+a).children(a-1);return a.next()},onDataReturnReplaceRows:function(a){this.get("tbody").children().remove();this.get("recordSet").replace(a.data);this.addRows(a.data)},
onDataReturnAddRows:function(a){this.get("recordSet").push(a.data);this.addRows(a.data)}});d.ScrollingDataTable=o.create("dt",r,[],{ATTRS:{tbodyContainer:{value:"<div/>",setter:d},autoScroll:{value:false},autoScrollStatus:{value:false}}},{initializer:function(){this.set("tbodyContainer",this.get("tbodyContainer"))},_autoScrollBefore:function(){var a=this.get("tbodyContainer");this.set("autoScrollStatus",a._nodes[0].scrollTop+a.height()==a._nodes[0].scrollHeight)},_autoScrollAfter:function(){var a=
this.get("tbodyContainer");if(this.get("autoScroll")&&this.get("autoScrollStatus"))a._nodes[0].scrollTop=a._nodes[0].scrollHeight},_syncColumnWidths:function(){var a=this.get("thead").first().children();if(!this._firstTr||!this._firstTr._nodes[0]||!this._firstTr._nodes[0].parentNode)this._firstTr=this.getFirstTr();this._firstTr.children().each(function(b,c){d(b).width(a.item(c).width())})},_sdtAfterRender:function(){var a=this.get("height"),b=this.get("tbodyContainer");a&&b.height(a-this.get("thead").height());
this._contentTable.append(this.get("tbody").detach()).appendTo(b);this._syncColumnWidths()},renderUI:function(a){(this._contentTable=d("<table/>").addClass(this.getClassName("content")))._nodes[0].setAttribute("cellspacing","0");this.get("tbodyContainer").addClass(this.getClassName("table","body")).appendTo(a).css("overflowY","auto");this.after("render",this._sdtAfterRender)},bindUI:function(){this.after("addRow",this._syncColumnWidths);this.after("addRows",this._syncColumnWidths);this.on("addRow",
this._autoScrollBefore);this.after("addRow",this._autoScrollAfter);this.on("addRows",this._autoScrollBefore);this.after("addRows",this._autoScrollAfter);this._handlers.push(d(d.config.win).on("resize",this._syncColumnWidths,this))}});d.add({DataTable:r,Column:s})});
