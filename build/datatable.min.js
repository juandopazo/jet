/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datatable",function(d){var i=d.Lang,o=d.Array;if(!jet.DataTable)jet.DataTable={};if(!i.isNumber(jet.DataTable.ids))jet.DataTable.ids=0;var q=function(){q.superclass.constructor.apply(this,arguments);var e=this.addAttrs({dataSource:{required:true},columnDefinitions:{required:true,validator:i.isArray},className:{writeOnce:true,value:"dt"}}),r=jet.DataTable.ids++,m=e.get("dataSource").get("recordSet"),s=e.get("classPrefix"),t=e.get("className"),c=s+t+"-",l=c+r+"rec",u=c+r+"th-",v=d("<table/>").attr("id",
c+r),x=d("<thead/>").appendTo(v),j=d("<tbody/>").addClass(c+"data").appendTo(v),n,w=function(a,f){var g=a.attr("id").split("-").pop(),b=a.hasClass(c+"desc"),h=b?"desc":"asc",k=b?"asc":"desc";if(!f){b=h;h=k;k=b}x.find("th").removeClass(c+h,c+k);a.addClass(c+h).removeClass(c+k);m.sortBy(g,h);n=g;h=m.getRecords();b=h.length;var y,z;k=c+(b%2===0?"even":"odd");var p=c+(b%2===0?"odd":"even");d("#"+l+h[b-1].getId()).addClass(b%2===0?p:k).removeClass(b%2===0?k:p);for(b=b-2;b>=0;b--){y=d("#"+l+h[b].getId());
z=d("#"+l+h[b+1].getId());y.addClass(b%2===0?k:p).removeClass(b%2===0?p:k).insertBefore(z)}j.find("."+c+"desc").removeClass(c+"desc");j.find("."+c+"col-"+g).addClass(c+"desc")},A=e.get("columnDefinitions");o.each(A,function(a,f){var g=d("<th/>").append(d("<div/>").addClass(c+"liner").append(d("<span/>").addClass(c+"label").html(a.label||a.key)));g.attr("id",u+a.key);if(f===0)g.addClass(c+"first");else f==A.length-1&&g.addClass(c+"last");a.sortable&&g.addClass(c+"sortable").on("click",function(b){b.stopPropagation();
b.preventDefault();w(g)});x.append(g)});var B=function(a){i.isRecord(a)||(a=new d.Record(a));var f=d("<tr/>").attr("id",l+a.getId());o.each(e.get("columnDefinitions"),function(g){var b=a.get(g.key),h=d("<td/>").addClass(s+t+"-col-"+g.key);h.append(d("<div/>").addClass(c+"liner").html(g.formatter?g.formatter(b,a.getData(),h):b)).appendTo(f)});f.addClass(j.children().length%2===0?c+"even":c+"odd").appendTo(j)};e.addRow=function(a){B(a);n&&w(d("#"+u+n));return e};e.addRows=function(a){if(i.isArray(a))o.each(a,
function(f){i.isRecord(f)||new d.Record(f)});else if(i.isRecordSet(a))a=a.getRecords();o.each(a,B);n&&w(d("#"+u+n),true)};e.getFirstTr=function(){return j.children().eq(0)};e.getNextTr=function(a){if(i.isRecord(a))a=a.getId();if(i.isNumber(a))a=j.find("#"+l+a);return a.next()};e.getFirstTd=function(a){if(i.isRecord(a))a=a.getId();if(i.isNumber(a))a=j.find("#"+l+a);return a.children().eq(0)};e.getNextTd=function(a){if(i.isRecord(a))a=a.getId();if(i.isNumber(a))a=j.find("#"+l+a).children(a-1);return a.next()};
e.onDataReturnReplaceRows=function(a,f){j.children().remove();e.addRows(f);m.replace(f)};e.onDataReturnAddRows=function(a,f){e.addRows(f);m.push(f)};e.on("render",function(){e.onDataReturnAddRows(null,m);e.get("boundingBox").addClass(s+t).append(v)})};d.extend(q,d.Widget);d.add({DataTable:q})});
