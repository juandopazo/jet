/**
 * @module base
 * @requires node
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("base",function(e){function v(a,b,c,d){var f=this;this.type=a;this.target=b;this.preventDefault=function(){c&&c()};m.each(d||{},function(i,g){h.isValue(f[i])||(f[i]=g)})}var m=e.Hash,h=e.Lang,j=e.Array,s=Array.prototype.slice,n=e.Class;e.EventTarget=n.create("EventTarget",null,{initializer:function(){this._events={}},on:function(a,b,c){var d=this._events,f=false;d[a]||(d[a]=[]);if(a.indexOf("~ONCE~")>-1){f=true;a=a.substr(6)}if(h.isObject(b))d[a].push({fn:b,o:c||this,once:f});return this},
once:function(a,b,c){return this.on("~ONCE~"*a,b,c)},after:function(a,b,c){return this.on("after"+a.charAt(0).toUpperCase()+a.substr(1),b,c)},unbind:function(a,b){if(a)j.remove(b,this._events[a]||[]);else this._events={};return this},fire:function(a,b){var c=this._events,d=c[a]||[],f=true;if(c["*"])d=d.concat(c["*"]);var i=d.length,g,k=new v(a,this,function(){f=false},b);for(c=0;c<i;c++){g=d[c].fn;if(h.isFunction(g))g.call(d[c].o,k);else if(h.isObject(g)&&g.handleEvent)g.handleEvent.call(d[c].o||
g,k);if(d[c].once){j.remove(d,d[c]);c--}}return f}});e.Attribute=n.create("Attribute",e.EventTarget,{initializer:function(a){this._state=a||{};this._stateConf={};n.walk(this,function(b){b.ATTRS&&this.addAttrs(b.ATTRS)})},addAttr:function(a,b){this._stateConf[a]=b;var c=this._state,d=h.isValue(c[a]);b.readOnly&&d&&delete c[a];if(h.isString(b.setter))b.setter=this[b.setter];if(h.isString(b.getter))b.getter=this[b.getter];if(d&&b.setter)c[a]=b.setter.call(this,c[a]);return this},_set:function(a,b){var c=
this._stateConf,d=this._state,f=c[a]=c[a]||{},i=d[a],g;if(!f.readOnly){if(!f.validator||f.validator.call(this,b)){if(f.setter)b=f.setter.call(this,b);if(!h.isValue(d[a])&&f.value)d[a]=i=f.value;g={newVal:b,prevVal:i};if(b!==i&&this.fire(a+"Change",g)){d[a]=b;this.fire("after"+h.capitalize(a)+"Change",g)}}if(f.writeOnce&&!f.readOnly)c[a].readOnly=true}return this},get:function(a){var b=this._stateConf,c=this._state;b[a]=b[a]||{};var d=b[a];if(d.writeOnce&&!d.readOnly)b[a].readOnly=true;if(!h.isValue(c[a]))c[a]=
d.value;return d.getter?d.getter.call(this,c[a],a):c[a]},set:function(a,b){h.isObject(a)?m.each(a,this._set,this):this._set(a,b);return this},unset:function(a){delete this._state[a];return this},addAttrs:function(a){m.each(a,this.addAttr,this);return this},getAttrs:function(){var a={},b=this;m.each(this._state,function(c){a[c]=b.get(c)});return a}});e.Base=n.create("Base",e.Attribute,{initializer:function(a){function b(c,d){this.on(c,h.isString(d)?this[d]:d)}a=a||{};n.walk(this,function(c){j.each(c.EXTS,
function(d){m.each(d.EVENTS,b,this)},this);m.each(c.EVENTS,b,this)});m.each(a.on,b,this)}},{ATTRS:{on:{writeOnce:true,getter:function(a){return a||{}}}},create:function(a,b,c,d,f){return n.create(a,b||e.Base,f,d).mixin(c||[])}});e.Utility=e.Base.create("utility",e.Base,[],{CSS_PREFIX:"jet",ATTRS:{cssPrefix:{getter:function(a){return a||e.Utility.CSS_PREFIX},writeOnce:true}}},{initializer:function(){this._handlers=[e(this.get("win")).on(t,this.destroy,this)]},destroy:function(){this.fire(u)&&j.each(this._handlers,
function(a){a.detach()})},getClassName:function(){return[this.get(p),this.constructor.NAME].concat(s.call(arguments)).join("-")}});var p="classPrefix",t="unload",u="destroy";if(!jet.Widget)jet.Widget={};if(!h.isNumber(jet.Widget._uid))jet.Widget._uid=-1;if(!jet.Widget._instances)jet.Widget._instances={};e.Widget=e.Base.create("widget",e.Base,[],{CSS_PREFIX:"jet",NAME:"widget",DOM_EVENTS:{click:1,keypress:1,mousedown:1,mouseup:1,mouseover:1,mouseout:1},ATTRS:{srcNode:{value:e(e.context.body),setter:e},
classPrefix:{writeOnce:true,getter:function(a){return a||e.Widget.CSS_PREFIX}},rendered:{value:false},boundingBox:{setter:e},contentBox:{setter:e},width:{validator:h.isNumber},height:{validator:h.isNumber},id:{},visible:{value:true,validator:h.isBoolean},disabled:{value:false,validator:h.isBoolean}},HTML_PARSER:{contentBox:function(){var a=this.get("boundingBox");if(a&&this.CONTENT_TEMPLATE)return a.first()}},getByNode:function(a){a=e(a)._nodes[0];for(var b=a.ownerDocument.documentElement;a&&a!=b;){if(a.id&&
jet.Widget._instances[a.id])return jet.Widget._instances[a.id];a=a.parentNode}return null}},{BOUNDING_TEMPLATE:"<div/>",CONTENT_TEMPLATE:"<div/>",_domEventProxy:function(a){this.fire(a.type,{domEvent:a})},show:function(){return this.set("visible",true)},hide:function(){return this.set("visible",false)},enable:function(){return this.set("enabled",true)},disable:function(){return this.set("enabled",false)},focus:function(){return this.set("focused",true)},blur:function(){return this.set("focused",false)},
render:function(a){if(!this.get("rendered")){var b=this,c=this.get("boundingBox"),d=this.get("contentBox"),f=this.get("srcNode"),i,g=this.get(p),k=n.getClasses(this);m.each(e.Widget.DOM_EVENTS,function(l,o){o&&b._handlers.push(c.on(l,b._domEventProxy,b))});if(a){f=a;b.set("srcNode",a)}if(this.constructor==e.Widget)k=[e.Widget];else k.splice(0,4);j.each(["width","height"],function(l){var o=b.get(l);h.isNumber(o)&&c[l](o);b.after(l+"Change",function(q){newVal=h.isNumber(q.newVal)?q.newVal:"";b.get("boundingBox")[l](q.newVal)})});
j.each(k,function(l){i=[g,l.NAME].join("-");c.addClass(i);d.addClass([i,"content"].join("-"))});c._nodes[0]!=d._nodes[0]&&c.append(d.css("visibility","inherit"));c.attr("id")||c.attr("id",this.get("id"));this._toggleVisibility({newVal:this.get("visible")});this._toggleDisabled({newVal:this.get("disabled")});if(this.fire("render")){j.each(["renderUI","bindUI","syncUI"],function(l){j.each(k,function(o){o.prototype.hasOwnProperty(l)&&o.prototype[l].call(b,c,d)})});c.inDoc()||c.appendTo(f);this.set("rendered",
true).focus();setTimeout(function(){b.fire("afterRender")},0)}}return this},destroy:function(){if(this.fire(u)){n.walk(this,function(a){a.prototype.hasOwnProperty("destructor")&&a.prototype.destructor.call(this)});j.each(this._handlers,function(a){a.detach&&a.detach()});this.get("boundingBox").remove(true)}},_parseHTML:function(){var a=this,b=this.get("boundingBox");b._nodes[0]&&b.inDoc()&&j.each(this._classes,function(c){m.each(c.HTML_PARSER||{},function(d,f){var i=f.call(a,b);if(h.isValue(i)&&(!(i instanceof
e.NodeList)||i._nodes[0]))a.set(d,i)})})},_toggleVisibility:function(a){this.get("boundingBox").toggleClass(this.getClassName("hidden"),!a.newVal)},_toggleDisabled:function(a){this.get("boundingBox").toggleClass(this.getClassName("disabled"),a.newVal)},_widgetIdChange:function(a){this.get("boundingBox").attr("id",a.newVal);jet.Widget._instances[a.newVal]=this;delete jet.Widget._instances[a.prevVal]},initializer:function(){this._handlers=[e(e.config.win).on(t,this.destroy,this)];this._uid=++jet.Widget._uid;
var a=this.get("id");if(!a){a=this.getClassName(this._uid);this.set("id",a)}this.after("idChange",this._widgetIdChange);jet.Widget._instances[a]=this;this.get("boundingBox")||this.set("boundingBox",this.BOUNDING_TEMPLATE);this.get("contentBox")||this.set("contentBox",this.CONTENT_TEMPLATE||this.get("boundingBox"));this.after("visibleChange",this._toggleVisibility);this.after("disabledChange",this._toggleDisabled);this._parseHTML()},getClassName:function(){return[this.get(p),this.constructor.NAME].concat(s.call(arguments)).join("-")}});
var r=e.Mouse=e.Base.create("mouse",e.Utility,[],{ATTRS:{frequency:{value:20},tracking:{value:false,validator:h.isBoolean},capturing:{value:false,validator:h.isBoolean},shields:{readOnly:true,getter:"_buildShim"},shim:{value:false,validator:h.isBoolean},prevX:{value:0},prevY:{value:0}}},{_buildShim:function(){if(!r.shim){var a=this.get("pageSize");r.shim=e("<iframe/>").attr({frameborder:"0",src:"javascript:;"}).css({opacity:0,position:"absolute",top:"0px",left:"0px",width:a.width,height:a.height,
border:0,zIndex:2E7}).appendTo(e.config.doc.body).hide()}return r.shim},_onTrackingChange:function(a){var b=this;if(a.newVal){if(!this.get("capturing")){this.get("shim")&&this.shim.show();this.interval=setInterval(function(){var c=b.get("clientX"),d=b.get("clientY");if(b.get("prevX")!=c||b.get("prevY")!=d){b.fire("mousemove",{clientX:c,clientY:d});b.set({prevX:c,prevY:d})}},this.get("frequency"));this.set("capturing",true)}}else{this.shim.hide();clearInterval(this.interval);this.set("capturing",false)}},
_onSelectStart:function(a){this.get("capturing")&&a.preventDefault()},_onMouseMove:function(a){this.set({clientX:a.clientX,clientY:a.clientY})},_onMouseUp:function(){this.set("tracking",false).fire("mouseup",{clientX:this.get("clientX"),clientY:this.get("clientY")})},initializer:function(){this.set("pageSize",e.DOM.pageSize());var a=this.shim=this._buildShim();this.after("trackingChange",this._onTrackingChange);var b=e(a._nodes[0].contentWindow.document);b.find("body").css({margin:0,padding:0});b.on("mousemove",
this._onMouseMove,this);b.on("mouseup",this._onMouseUp,this);b=e(e.config.doc);b.on("selectstart",this._onSelectStart,this);b.on("mousemove",this._onMouseMove,this);b.on("mouseup",this._onMouseUp,this);this.on("destroy",a.unbindAll,a)},down:function(){return this.set("tracking",true)},up:function(){return this.set("tracking",false)}});(function(){var a=new e.EventTarget,b,c,d,f=e.config.win,i=function(){var g=e.DOM.scrollLeft(),k=e.DOM.scrollTop();if(g!=c||k!=d)a.fire("scroll",{scrollLeft:g,scrollTop:k});
else{clearInterval(b);b=null}c=g;d=k};e(e.config.win).on("scroll",function(){b||(b=setInterval(i,50))});j.each(["on","once","fire"],function(g){e[g]=e.bind(a[g],a)});j.each(["load","unload"],function(g){e(f).on(g,function(){a.fire(g)})});e(f).on("resize",function(){a.fire("resize")})})()});
