/**
 * @module base
 * @requires node
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("base",function(d){function r(){this._events={}}function n(a){n.superclass.constructor.apply(this,arguments);this._state=a?d.clone(a):{};this._attrs={};for(var b=[],c=this.constructor;c!==n;){b.unshift(c);c=c.superclass&&c.superclass.constructor}this._classes=b;k.each(b,function(e){e.ATTRS&&this.addAttrs(e.ATTRS)},this)}function p(a){a=arguments[0]=a||{};p.superclass.constructor.call(this,a);this.name=this.constructor.NAME;var b=this,c=arguments,e=this._classes,g;g=this.get("on");var f=function(i,
j){this.on(i,h.isString(j)?this[j]:j)};this._handlers=[d(d.config.win).on(u,this.destroy,this)];l.each(g,f,this);for(g=0;g<e.length;g++){e[g].EVENTS&&l.each(e[g].EVENTS,f,this);k.each(e[g].EXTS||[],function(i){i.apply(b,c);l.each(i.EVENTS||{},function(j,o){b.on(j,o)})});e[g][q].hasOwnProperty("initializer")&&e[g][q].initializer.call(this,a)}}var l=d.Object,h=d.Lang,k=d.Array,t=Array.prototype.slice,v=d.extend,q="prototype";d.EventFacade=function(a,b,c,e){this.type=a;this.target=b;this.preventDefault=
function(){c&&c()};this.halt=function(){this.preventDefault()};l.each(e||{},function(g,f){h.isValue(self[g])||(this[g]=f)},this)};d.mix(r.prototype,{_attach:function(a,b){b.o=b.o||this;var c=this._events;c[a]||(c[a]=[]);h.isObject(b.fn)&&c[a].push(b);return this},_on:function(a,b,c,e){h.isObject(a)?l.each(a,function(g,f){this._attach(g,{fn:f,o:b,once:e})},this):this._attach(a,{fn:b,o:c,once:e});return this},on:function(a,b,c){return this._on(a,b,c)},once:function(a,b,c){return this._on(a,b,c,true)},
after:function(a,b,c){return this.on("after"+a.charAt(0).toUpperCase()+a.substr(1),b,c)},unbind:function(a,b){var c=this._events[a]||[],e,g=0;if(a&&b)for(;g<c.length;)if(c[g].fn==b)c.splice(g,1);else g++;else if(a)this._events[a]=[];else for(e in this._events)if(this._events.hasOwnProperty(e))this._events[e]=[];return this},fire:function(a,b){for(var c=this._events[a]=this._events[a]||[],e=true,g=new d.EventFacade(a,this,function(){e=false},b),f=0;f<c.length;){h.isFunction(c[f].fn)&&c[f].fn.call(c[f].o,
g);if(!c[f]||c[f].once)c.splice(f,1);else f++}return e}});d.EventTarget=r;d.extend(n,r,{addAttr:function(a,b){this._attrs[a]=b;var c=this._state,e=h.isValue(c[a]);b.readOnly&&e&&delete c[a];if(h.isString(b.setter))b.setter=this[b.setter];if(h.isString(b.getter))b.getter=this[b.getter];if(e&&b.setter)c[a]=b.setter.call(this,c[a]);return this},_set:function(a,b,c){var e=this._attrs,g=this._state,f=e[a]=e[a]||{},i=g[a],j;if(!f.readOnly){if(!f.validator||f.validator.call(this,b)){if(f.setter)b=f.setter.call(this,
b);if(!h.isValue(g[a])&&f.value)g[a]=i=f.value;j={newVal:b,prevVal:i,attrName:a};h.isObject(c)&&d.mix(j,c);if(b!==i&&this.fire(a+"Change",j)){g[a]=b;this.fire("after"+h.capitalize(a)+"Change",j)}}if(f.writeOnce&&!f.readOnly)e[a].readOnly=true}return this},get:function(a){var b=this._attrs,c=this._state;b[a]=b[a]||{};var e=b[a];if(e.writeOnce&&!e.readOnly)b[a].readOnly=true;h.isValue(c[a])||(c[a]=e.valueFn?e.valueFn():e.value);return e.getter?e.getter.call(this,c[a],a):c[a]},set:function(a,b,c){h.isObject(a)?
l.each(a,function(e,g){this._set(e,g,c)},this):this._set(a,b,c);return this},unset:function(a){delete this._state[a];return this},addAttrs:function(a){l.each(a,this.addAttr,this);return this},getAttrs:function(){var a={},b=this;l.each(this._state,function(c){a[c]=b.get(c)});return a}});d.Attribute=n;d.extend(p,n,{destroy:function(){if(this.fire(w)){k.each(this._classes,function(a){a.prototype.hasOwnProperty("destructor")&&a.prototype.destructor.call(this)},this);k.each(this._handlers,function(a){a.detach&&
a.detach()});this.unbind()}}},{ATTRS:{on:{getter:function(a){return a||{}}}},create:function(a,b,c,e,g){function f(){f.superclass.constructor.apply(this,arguments)}c=c||[];v(f,b||p,g,e||{});d.mix(f,{NAME:a,EXTS:c},true);k.each(c,function(i){d.mix(f[q],i[q]);l.each(i,function(j,o){if(f[j])h.isObject(f[j])&&h.isObject(o)&&d.mix(f[j],o);else f[j]=o})});return f}});d.Base=p;d.Utility=d.Base.create("utility",d.Base,[],{CSS_PREFIX:"jet",ATTRS:{cssPrefix:{getter:function(a){return a||d.Utility.CSS_PREFIX},
writeOnce:true}}},{getClassName:function(){return[this.get(s),this.constructor.NAME].concat(t.call(arguments)).join("-")}});var s="classPrefix",u="unload",w="destroy",m=jet.namespace("Widget._instances");d.Widget=d.Base.create("widget",d.Base,[],{CSS_PREFIX:"jet",NAME:"widget",DOM_EVENTS:{click:1,keypress:1,mousedown:1,mouseup:1,mouseover:1,mouseout:1},ATTRS:{srcNode:{value:d(d.context.body),setter:d},classPrefix:{writeOnce:true,getter:function(a){return a||d.Widget.CSS_PREFIX}},rendered:{value:false},
boundingBox:{setter:d},contentBox:{setter:d},width:{validator:h.isNumber},height:{validator:h.isNumber},id:{},visible:{value:true,validator:h.isBoolean},disabled:{value:false,validator:h.isBoolean}},HTML_PARSER:{contentBox:function(){var a=this.get("boundingBox");if(a&&this.CONTENT_TEMPLATE)return a.first()}},getByNode:function(a){a=d(a).getDOMNode();for(var b=a.ownerDocument.documentElement;a&&a!=b;){if(a.id&&m[a.id])return m[a.id];a=a.parentNode}return null}},{BOUNDING_TEMPLATE:"<div/>",CONTENT_TEMPLATE:"<div/>",
_domEventProxy:function(a){this.fire(a.type,{domEvent:a,currentTarget:d.Widget.getByNode(a.target)})},show:function(){return this.set("visible",true)},hide:function(){return this.set("visible",false)},enable:function(){return this.set("enabled",true)},disable:function(){return this.set("enabled",false)},focus:function(){return this.set("focused",true)},blur:function(){return this.set("focused",false)},_renderUI:function(a,b,c){var e=this.get(s),g;k.each(c,function(f){g=[e,f.NAME].join("-");a.addClass(g);
b.addClass([g,"content"].join("-"))});a.getDOMNode()!==b.getDOMNode()&&a.append(b.css("visibility","inherit"));a.attr("id",this.get("id"));a.inDoc()||a.appendTo(this.get("srcNode"))},_bindUI:function(a){var b=this;l.each(d.Widget.DOM_EVENTS,function(c,e){e&&b._handlers.push(a.on(c,b._domEventProxy,b))})},_syncUI:function(a){k.each(["width","height"],function(b){var c=this.get(b);h.isValue(c)&&a[b](c)},this);this._toggleVisibility({newVal:this.get("visible")});this._toggleDisabled({newVal:this.get("disabled")})},
renderer:function(){var a=this.get("boundingBox"),b=this.get("contentBox"),c=this,e=this._classes;e=this.constructor===d.Widget?[d.Widget]:e.slice(2);k.each(["renderUI","bindUI","syncUI"],function(g){c.fire(g);c["_"+g](a,b,e);k.each(e,function(f){f.prototype.hasOwnProperty(g)&&f.prototype[g].call(c,a,b)});c.fire("after"+h.capitalize(g))})},render:function(a){if(!this.get("rendered")){a&&this.set("srcNode",a);if(this.fire("render")){this.renderer();this.set("rendered",true).focus();setTimeout(d.bind(this.fire,
this,"afterRender"),0)}}return this},destructor:function(){delete m[this.get("id")];this.get("boundingBox").remove(true)},_parseHTML:function(){var a=this,b=this.get("boundingBox");b.getDOMNode()&&b.inDoc()&&k.each(this._classes,function(c){l.each(c.HTML_PARSER||{},function(e,g){var f=g.call(a,b);if(h.isValue(f)&&(!(f instanceof d.NodeList)||f.getDOMNode()))a.set(e,f)})})},_toggleVisibility:function(a){this.get("boundingBox").toggleClass(this.getClassName("hidden"),!a.newVal)},_toggleDisabled:function(a){this.get("boundingBox").toggleClass(this.getClassName("disabled"),
a.newVal)},_widgetIdChange:function(a){this.get("boundingBox").attr("id",a.newVal);m[a.newVal]=this;delete m[a.prevVal]},initializer:function(){this._uid=d.guid();var a=this,b=this.get("id");if(!b){b=this._uid;this.set("id",b)}this.after("idChange",this._widgetIdChange);m[b]=this;this.get("boundingBox")||this.set("boundingBox",this.BOUNDING_TEMPLATE);this.get("contentBox")||this.set("contentBox",this.CONTENT_TEMPLATE||this.get("boundingBox"));this.after("visibleChange",this._toggleVisibility);this.after("disabledChange",
this._toggleDisabled);k.each(["width","height"],function(c){a.after(c+"Change",function(e){a.get("boundingBox")[c](e.newVal)})});this._parseHTML()},getClassName:function(){return[this.get(s),this.constructor.NAME].concat(t.call(arguments)).join("-")}});d.Mouse=d.Base.create("mouse",d.Utility,[],{ATTRS:{frequency:{value:20},tracking:{value:false,validator:h.isBoolean},capturing:{value:false,validator:h.isBoolean},shields:{readOnly:true,getter:"_buildShim"},shim:{value:false,validator:h.isBoolean},
prevX:{value:0},prevY:{value:0}}},{_buildShim:function(){if(!d.Mouse.shim){var a=this.get("pageSize");d.Mouse.shim=d("<iframe/>").attr({frameborder:"0",src:"javascript:"+(d.UA.ie?"false;":";")}).css({opacity:0,position:"absolute",top:"0px",left:"0px",width:a.width,height:a.height,border:0,zIndex:2E7}).appendTo(d.config.doc.body).hide()}return d.Mouse.shim},_onTrackingChange:function(a){var b=this;if(a.newVal){if(!this.get("capturing")){this.get("shim")&&this.shim.show();this.interval=setInterval(function(){var c=
b.get("clientX"),e=b.get("clientY");if(b.get("prevX")!=c||b.get("prevY")!=e){b.fire("mousemove",{clientX:c,clientY:e});b.set({prevX:c,prevY:e})}},this.get("frequency"));this.set("capturing",true)}}else{this.shim.hide();clearInterval(this.interval);this.set("capturing",false)}},_onSelectStart:function(a){this.get("capturing")&&a.preventDefault()},_onMouseMove:function(a){this.set({clientX:a.clientX,clientY:a.clientY})},_onMouseUp:function(){this.set("tracking",false).fire("mouseup",{clientX:this.get("clientX"),
clientY:this.get("clientY")})},initializer:function(){this.set("pageSize",d.DOM.pageSize());var a=this.shim=this._buildShim();this.after("trackingChange",this._onTrackingChange);var b=d(a.getDOMNode().contentWindow.document);b.find("body").css({margin:0,padding:0});b.on("mousemove",this._onMouseMove,this);b.on("mouseup",this._onMouseUp,this);b=d(d.config.doc);b.on("selectstart",this._onSelectStart,this);b.on("mousemove",this._onMouseMove,this);b.on("mouseup",this._onMouseUp,this);this.on("destroy",
a.unbindAll,a)},down:function(){return this.set("tracking",true)},up:function(){return this.set("tracking",false)}});(function(){var a=new d.EventTarget,b,c,e,g=d.config.win,f=function(){var i=d.DOM.scrollLeft(),j=d.DOM.scrollTop();if(i!=c||j!=e)a.fire("scroll",{scrollLeft:i,scrollTop:j});else{clearInterval(b);b=null}c=i;e=j};d(d.config.win).on("scroll",function(){b||(b=setInterval(f,50))});k.each(["on","once","fire","unbind"],function(i){d[i]=d.bind(a[i],a)});k.each(["load","unload"],function(i){d(g).on(i,
function(){a.fire(i)})});d(g).on("resize",function(){a.fire("resize")})})()});
