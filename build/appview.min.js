/**
 * @module appview
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("appview",function(d){d.FanLoader=d.Base.create("fanloader",d.Widget,[],{ATTRS:{loading:{value:false},blades:{value:12,writeOnce:true},radius:{value:20},duration:{value:1E3}}},{CONTENT_TEMPLATE:null,_uiLoadingChange:function(a){this.get("boundingBox").toggleClass("loading",a.newVal)},renderUI:function(a){a.css("-webkit-transform","scale("+this.get("radius")/40+")");var b,c=this.get("blades"),e=360/c,f=this.get("duration");for(b=0;b<c;b++)d("<b/>").css({"-webkit-transform":"rotate("+e*b+"deg)",
"-webkit-animation-duration":f+"ms","-webkit-animation-delay":f*b/c+"ms"}).appendTo(a)},bindUI:function(){this.after("loadingChange",this._uiLoadingChange)},start:function(){return this.set("loading",true)},stop:function(){return this.set("loading",false)}});var i=d.Lang,k=d.Hash,h=d.Base,j=function(a){a=a.split("/");return{name:a[1],method:a[2],args:a.slice(3)}};if(!jet.controllers){jet.controllers={};d(d.config.win).on("hashchange",function(){var a=j(d.config.win.location.hash),b=jet.controllers[a.name];
b&&b[a.method]&&b[a.method].apply(b,a.args)})}d.Controller=h.create("controller",h,[],{ATTRS:{name:{required:true,validator:i.isString},methods:{value:{}}}},{initializer:function(){var a=this.get("name"),b=j(d.config.win.location.hash);k.each(this.get("methods"),function(c,e){myself[c]=e});jet.controllers[a]=this;b.name==a&&myself[b.method]&&myself[b.method].apply(myself,b.args)}});d.Scrollable=h.create("scrollable",d.Utility,[],{ATTRS:{node:{required:true,setter:d},scrollTop:{getter:function(){var a=
getComputedStyle(this.get(NODE)[0]).webkitTransform.split(",").pop();return-parseInt(a.substr(0,a.length-1),10)}},scrolling:{value:true}}},{_returnToPosition:function(){var a=getComputedStyle(node[0]).webkitTransform.split(",").pop(),b=window.innerHeight-node.height()-110,c=false;a=parseInt(a.substr(0,a.length-1),10);if(a>0){a=0;c=true}else if(a<b){a=b;c=true}c&&this.get("node").css({"-webkit-transition-duration":"600ms","-webkit-transition-timing-function":"ease-out",transform:"translate3d(0px, "+
a+"px, 0px)"})},_scrollTouchStart:function(a){if(this.get("scrolling")){a=a.touches[0].pageY;var b=getComputedStyle(node[0]).webkitTransform.split(",").pop();this.set({y1:a,start:a,time1:(new Date).getTime()});b=parseInt(b.substr(0,b.length-1),10);if(!isNaN(b)){this.get("node").css("transform","translate3d(0px, "+b+"px, 0px)");this.set("current",b)}}},_scrollTouchMove:function(a){if(this.get("scrolling")){var b=this.get("y2"),c=this.get("time2");i.isNumber(b)&&this.set("y1",b);b=a.touches[0].pageY;
this.set("y2",b);i.isNumber(c)&&this.set("time1",c);this.set("time2",Date.now());node.css({"-webkit-transition-duration":"0ms","-webkit-transition-timing-function":"linear",transform:"translate3d(0px, "+(this.get("current")+b-this.get("start"))+"px, 0px)"})}},_scrollTouchEnd:function(){if(this.get("scrolling")){var a=this.get("y2")-this.get("y1"),b=a/(1.5*(this.get("time2")-this.get("time1")));if(b<1)b=Math.pow(b,2)*a/Math.abs(a);a=this.get("node");var c=500,e=this.get("current")-this.get("start")+
b*c,f=a.height(),g=0;if(e<screen.height-f-200)g=screen.height-f-200;else if(e>100)g=100;c*=2;if(i.isNumber(g)){c=c*g/e;e=g}if(Math.abs(b)>0.1){this.set("flick",true);a.css({"-webkit-transition-duration":c+"ms","-webkit-transition-timing-function":i.isNumber(g)?"linear":"ease-out",transform:"translate3d(0px, "+e+"px, 0px)"})}else this._returnToPosition()}},_scrollTransitionEnd:function(){if(this.get("scrolling"))if(this.get("flick")){this.set("flick",false);this._returnToPosition()}else this.fire("scroll:end")},
initializer:function(){var a=this.get("node");this._handlers.push(a.on("touchstart",this._scrollTouchStart,this),a.on("touchmove",this._scrollTouchMove,this),a.on("touchend",this._scrollTouchEnd,this),a.on("webkitTransitionEnd",this._scrollTransitionEnd,this))},scrollTo:function(a,b,c){b=b||0;c=c||"linear";this.get(NODE).css({"-webkit-transition-duration":b+"ms","-webkit-transition-timing-function":c,transform:"translate3d(0px, "+a+"px, 0px)"});return this}});d.Page=h.create("page",d.Module,[d.WidgetChild],
{ATTRS:{navHolder:{required:true},nav:{readOnly:true,getter:function(){return nav}},titleNode:{value:"<h1/>",setter:d},titleContent:{value:""},back:{},forward:{},loading:{value:false},scrollable:{value:true},loadScreen:{value:"<div/>",setter:d},loadingText:{value:"Cargando...",writeOnce:true},children:{}}},{_uiToggleLoadscreen:function(a){var b=this.get("loadScreen"),c=this.loader;if(a.newVal){b.show();c.start()}else{b.hide();c.stop()}},initializer:function(a){a.children||this.set("children",[]);
this.set("titleNode",this.get("titleNode"));this.set("loadScreen",this.get("loadScreen"));this.scrollable=new d.Scrollable({node:this.get("boundingBox"),scrolling:this.get("scrollable")});this.loader=new d.FanLoader},renderUI:function(a){a=this.get("loadScreen").addClass(this.getClassName("loadscreen")).appendTo(a);var b=this.get("back"),c=this.get("forward"),e=this.get("nav");this.loader.render(a);d("<span/>").html(this.get("loadingText")).appendTo(a);this._uiToggleLoadscreen({newVal:this.get("loading")});
if(b){b=new d.Button(b);b.render(e)}e.addClass(this.getClassName("nav")).append(title);if(c){c=new d.Button(c);c.render(e)}this.get("navHolder").append(e)},bindUI:function(){this.after("scrollableChange",function(a){this.scrollable.set("scrolling",a.newVal)});this.after("loadingChange",this._uiToggleLoadscreen)},syncUI:function(){this.get("loadScreen").css("height",window.innerHeight-this.get("nav").parent().offset().height+"px")},appendChild:function(a){this.get("children").push(a);return this},
removeChild:function(a){A.remove(this.get("children"),a);return this}});A.each(["In","Out"],function(a){d.Page.prototype["fade"+a]=function(b){b=b||250;var c=this.get("navHolder").height(),e=this.get("boundingBox").css({zIndex:3,position:"relative",height:window.innerHeight-c+PX,overflow:"hidden",transition:"none",opacity:"0.0",transform:"scale(0.2)",background:"#fff"}),f=d("<div/>").addClass("modal").css({top:c+PX,height:window.innerHeight-c+PX}).appendTo(e.parent());setTimeout(function(){e.css({transition:"-webkit-transform "+
b+"ms linear, opacity "+b+"ms ease-out",opacity:"1.0",transform:"scale(1.0)"});setTimeout(function(){f.remove();e.css({zIndex:1,height:"auto",overflow:"visible"}).find("*").css(VISIBILITY,"visible")},b)},10);e.find("*").css(VISIBILITY,"hidden");return this}});A.each(["Left","Right","Front"],function(a){d.Page.prototype["slide"+a]=function(){var b=this,c=this.get("nav"),e=false,f=function(l){if(!e&&l.propertyName=="-webkit-transform"){b.fire("slideEnd");e=true}},g={transform:"translate3d("+(a=="Left"?
-1:a=="Right"?1:0)*c.width()+"px, 0px, 0px)"};c.find("*").on("webkitTransitionEnd",f).css(g).css({opacity:a=="Front"?"1.0":"0.0"});this.get("boundingBox").on("webkitTransitionEnd",f).css(g);this.fire("slide"+a);return this}});d.PageView=h.create("pageview",d.Widget,[d.WidgetParent],{ATTRS:{navHolder:{required:true},defaultChildType:{value:"Page"}}},{initializer:function(){this.on("addChild",function(a){a.child.navHolder=a.child.navHolder||this.get("navHolder")})}});d.AppView=h.create("appview",d.Module,
[],{ATTRS:{nav:{value:"<div/>",setter:d},preventScroll:{value:true}}},{_uiPreventScroll:function(a){this.get("preventScroll")&&a.preventDefault()},initializer:function(){this.set("nav",this.get("nav"))},renderUI:function(){this.get("headerNode").append(this.get("nav"))},bindUI:function(){d(d.config.doc).on("touchmove",this._uiPreventScroll,this)}})});
