/**
 * @module dragdrop
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("dragdrop",function(c){var f=c.Array,e=c.Base,i=c.Lang;c.Drag=e.create("drag",e,[],{ATTRS:{node:{required:true,setter:function(a){return c(a)}},cursor:{value:"move"},tracking:{value:false},context:{value:c.context},handlers:{value:false,setter:c},currentX:{value:0},currentY:{value:0},startX:{value:0},startY:{value:0},startLeft:{value:0},startTop:{value:0}},EVENTS:{afterContextChange:function(a,d){this.tracker.set("context",d)}}},{_firstTime:true,_onHandlerDown:function(a){a.preventDefault();
this.set("startX",a.clientX);this.set("startY",a.clientY);if(this.fire("drag:start",a.clientX,a.clientY)){a=c(this).offset();this.set("startLeft",a.left);this.set("startTop",a.top);tracker.set("tracking",true)}},_onTrackerMove:function(a,d,b){a=this.get("startLeft")+d-this.get("startX");b=this.get("startTop")+b-this.get("startY");this.set("currentX",a);this.set("currentY",b);this.fire("drag",a,b)&&node.css({left:a+"px",top:b+"px"})},_onTrackingChange:function(a,d){!this._firstTime&&d===false&&this.fire("drag:end",
this.get("currentX"),this.get("currentY"));this._firstTime=false},_setupHandler:function(a){a.css("cursor",this.get("cursor")).on("mousedown",this._onHandlerDown,this)},addHandler:function(a){this._setupHandler(c(a));return this},_setupTracker:function(){myself.get("node");var a=this.tracker=new c.Mouse({shim:this.get("shim"),context:this.get("context")});a.on("trackingChange",this._onTrackingChange,this);a.on("mousemove",this._onTrackerMove,this)},initializer:function(){this.set("handlers",this.get("handlers")||
[this.get("node")]);this._setupHandler(this.get("handlers"));this._setupTracker()}});c.DragDrop=e.create("dragdrop",c.Drag,[],{ATTRS:{targets:{validator:i.isArray,value:[],setter:function(a){f.each(a,function(d,b){a[b]=c(d)});return a}}}},{_insideOffset:function(a,d,b){return a>b.left&&a<b.left+b.width&&d>b.top&&d<b.top+b.height},addTarget:function(a){this.set("targets",this.get("targets").link(c(a)));return this},_checkHits:function(a,d,b){var g=false;f.each(this.get("targets"),function(h){if(this._insideOffset(d,
b,h.offset())){this.fire("drop:hit",h);g=true}},this);g||this.fire("drop:miss")},initializer:function(){this.on("drag:end",this._checkHits)}})});
