/**
 * @module dragdrop
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("dragdrop",function(b){var e=b.Array,f=b.Lang,g=b.Drag=b.Base.create("drag",b.Base,[],{ATTRS:{node:{required:true,setter:b},cursor:{value:"move"},tracking:{value:false},handlers:{setter:b},startX:{value:0},startY:{value:0},startLeft:{value:0},startTop:{value:0},currentX:{value:0},currentY:{value:0}}},{initializer:function(){var a=this.mouse=new b.Mouse({shim:this.get("shim"),on:{trackingChange:b.bind(this._onMouseStatusChange,this),mousemove:b.bind(this._onMouseMove,this)}}),c=this.get("handlers");
c?this._setupHandler(c):this._setupHandler(this.get("node"));a.firstTime=true},_onMouseMove:function(a){var c=this.get("startLeft")+a.clientX-this.get("startX");a=this.get("startTop")+a.clientY-this.get("startY");this.set({currentX:c,currentY:a});this.fire("drag",{x:c,y:a})&&this.get("node").css({left:c+"px",top:a+"px"})},_onMouseStatusChange:function(a){!this.mouse.firstTime&&a.newVal===false&&this.fire("drag:end",{x:this.get("currentX"),y:this.get("currentY")});this.mouse.firstTime=false},_onHandlerMouseDown:function(a){a.preventDefault();
this.set({startX:a.clientX,startY:a.clientY});if(this.fire("drag:start",{x:a.clientX,y:a.clientY})){a=b(a.target).offset();this.set({startLeft:a.left,startTop:a.top});this.mouse.down()}},_setupHandler:function(a){a.css("cursor",this.get("cursor")).on("mousedown",this._onHandlerMouseDown,this)},addHandler:function(a){this._setupHandler(b(a));return this}});b.DragDrop=b.Base.create("dragdrop",g,[],{ATTRS:{targets:{validator:f.isArray,setter:function(a){e.each(a,function(c,d){a[d]=b(c)});return a}}}},
{initializer:function(){this.after("drag:end",this._ddOnDragEnd)},_ddOnDragEnd:function(a){var c=false;e.each(this.get("targets"),function(d){if(this._insideOffset(a.clientX,a.clientY,d.offset())){this.fire("drop:hit",{ddtarget:d});c=true}},this);c||this.fire("drop:miss")},_insideOffset:function(a,c,d){return a>d.left&&a<d.left+d.width&&c>d.top&&c<d.top+d.height},addTarget:function(a){this.get("targets").push(b(a));return this}})});
