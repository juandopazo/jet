/**
 * @module history
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("history",function(d){var f=d.UA,w=d.Lang,E=d.Array,F=d.Hash,B=d.config.doc.body,G={border:"0",margin:"0",padding:"0"},v={left:"-1000px",top:"-1000px",width:"1px",height:"1px",position:"absolute"},x=jet.namespace("History");if(!x.iframe)x.iframe=new d.EventTarget;var q=function(){var j,r=function(b){return b},l,g={},e=false,m,p=function(b){return w.isString(b)},n=function(b){if(!p(b)&&j)throw new Error("Please provide a valid key for window.historyStorage. Invalid key = "+b+".");},k=function(){if(!e){var b=
m.value;if(b!==""&&b!==null){g=d.JSON.stringify(b);e=true}}};return{setup:function(b){b=b||{};j=!!b.debugMode;l=b.encodeURI?encodeURIComponent:r;b=j?G:v;var h=j?{width:"800px",height:"80px",border:"1px solid black"}:v;m=d('<form><textarea id="jet-storage-field"></textarea></form>').attr("id","jet-storage-form").css(b).first().css(h)[0];f.opera&&m.focus();return this},put:function(b,h){var s=l(b);n(s);this.hasKey(b)&&this.remove(b);g[s]=h;k();m.value=d.JSON.stringify(g);return this},get:function(b){b=
l(b);n(b);k();b=g[b];if(b===undefined)b=null;return b},remove:function(b){b=l(b);n(b);k();delete g[b];k();m.value=d.JSON.stringify(g);return this},reset:function(){m.value="";g={};return this},hasKey:function(b){b=l(b);n(b);k();return!w.isUndefined(g[b])},isValidKey:p}}(),y=function(){y.superclass.constructor.apply(this,arguments);var j,r=function(a){return a},l=r,g=r,e=this.addAttrs({firstLoad:{readOnly:true,value:j},baseTitle:{validator:function(a){a=a.indexOf("@@@")>=0;if(!a&&e.get("debugMode"))throw new Error("Programmer error: options.baseTitle must contain the replacement parameter '@@@' to be useful.");
return a}},blankURL:{setter:function(a){return a.substr(-1)!="?"?a+"?":a},value:"blank.html?"},encodeURI:{setter:function(a){l=a?encodeURIComponent:r;g=a?decodeURIComponent:r},value:false}}),m=document.title,p=200,n=0,k,b,h,s,t,H=function(a){p=400;var c=e.get("debugMode")?{width:"800px",height:"80px",border:"1px solid black"}:v;b=d("<iframe/>").css(c).attr({frameborder:"0",id:"jet-history-frame",src:e.get("blankURL")+a}).appendTo(B)[0]},C=function(){var a=window.location.href,c=a.indexOf("#");return c>=
0?a.substr(c+1):""},z=function(a){return a===null||a===undefined?null:a===""?"":a.length==1&&a.charAt(0)=="#"?"":a.length>1&&a.charAt(0)=="#"?a.substring(1):a},A=function(a){a=z(g(a));var c=q.get(a),i={};E.each(a.split("&"),function(o){o=o.split("=");i[o[0]]=o[1]});e.changeTitle(c).fire("change",i,c)},I=function(){if(!f.ie&&h)h=false;else if(!(!f.ie&&t)){var a=C();if(a!=k){t=true;var c;if(c=f.ie){if(c=f.ie<8){c=String(b.contentWindow.document.location.search);if(c.length==1&&c.charAt(0)=="?")c="";
else if(c.length>=2&&c.charAt(0)=="?")c=c.substring(1);c=c!=a}c=c}if(c)b.src=e.get("blankURL")+a;else if(f.ie)return;k=a;t=false;A(a)}}},J=function(){d(d.config.win).on("hashchange",function(){A(d.config.win.location.hash)})};x.iframe.on("load",function(a,c){if(h)h=false;else{var i=String(c.search);if(i.charAt(0)=="?")i=i.length==1?"":i.substring(1);window.location.hash=i;A(i)}});this.initialize=function(){m=document.title;if(f.ie)if(q.hasKey("DhtmlHistory_pageLoaded")){s=true;j=false}else{s=false;
j=true;q.put("DhtmlHistory_pageLoaded",true)}return e};this.changeTitle=function(a){a=a&&a.newTitle?e.get("baseTitle").replace("@@@",a.newTitle):m;if(document.title==a)return e;document.title=a;if(f.ie)b.contentWindow.document.title=a;if(!f.ie&&!f.opera){a=g(document.location.hash);if(a!==""){a=l(z(a));document.location.hash=a}}return e};this.go=function(a,c){var i=[];if(w.isHash(a)){F.each(a,function(u,K){i.push(u+"="+K)});a=i.join("&")}var o=l(z(a));window.setTimeout(function(){if(n>0)n-=p;if(document.getElementById(o)&&
e.get("debugMode")){var u="Exception: History locations can not have the same value as _any_ IDs that might be in the document,";u+=" due to a bug in IE; please ask the developer to choose a history location that does not match any HTML";u+=" IDs in this document. The following ID is already taken and cannot be a location: "+a;throw new Error(u);}q.put(a,c);t=h=true;k=o;window.location.hash=o;if(f.ie)b.src=e.get("blankURL")+o;t=false;e.changeTitle(c)},n);n+=p;return e};q.setup({debugMode:e.get("debugMode")});
var D=C();k=D;if("onhashchange"in d.config.win)J();else{if(f.opera){p=400;d("<img/>").style(v).attr("src","javascript:location.href='javascript:dhtmlHistory.checkLocation();';").appendTo(B)}f.ie&&H(D);d(d.config.win).on("unload",function(){j=null});if(f.ie)h=true;else if(q.hasKey("DhtmlHistory_pageLoaded")){j=h=false;s=true}else{j=h=true;q.put("DhtmlHistory_pageLoaded",true)}setInterval(I,100)}};d.extend(y,d.Base);d.History=y});
