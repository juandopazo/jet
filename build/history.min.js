/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("history",function(d){var f=d.UA,y=d.Lang,C=d.Array,z=d.context.body,D={border:"0",margin:"0",padding:"0"},u={left:"-1000px",top:"-1000px",width:"1px",height:"1px",position:"absolute"};if(!jet.History)jet.History={};if(!jet.History.iframe)jet.History.iframe=new d.EventTarget;var q=function(){var j,r=function(b){return b},l,h={},e=false,m,p=function(b){return y.isString(b)},n=function(b){if(!p(b)&&j)throw new Error("Please provide a valid key for window.historyStorage. Invalid key = "+b+
".");},k=function(){if(!e){var b=m.value;if(b!==""&&b!==null){h=d.JSON.stringify(b);e=true}}};return{setup:function(b){b=b||{};j=!!b.debugMode;l=b.encodeURI?encodeURIComponent:r;b=j?D:u;var i=j?{width:"800px",height:"80px",border:"1px solid black"}:u;m=d('<form><textarea id="jet-storage-field"></textarea></form>').attr("id","jet-storage-form").css(b).first().css(i)[0];f.opera&&m.focus();return this},put:function(b,i){var s=l(b);n(s);this.hasKey(b)&&this.remove(b);h[s]=i;k();m.value=d.JSON.stringify(h);
return this},get:function(b){b=l(b);n(b);k();b=h[b];if(b===undefined)b=null;return b},remove:function(b){b=l(b);n(b);k();delete h[b];k();m.value=d.JSON.stringify(h);return this},reset:function(){m.value="";h={};return this},hasKey:function(b){b=l(b);n(b);k();return!y.isUndefined(h[b])},isValidKey:p}}(),v=function(){v.superclass.constructor.apply(this,arguments);var j,r=function(a){return a},l=r,h=r,e=this.addAttrs({firstLoad:{readOnly:true,value:j},baseTitle:{validator:function(a){a=a.indexOf("@@@")>=
0;if(!a&&e.get("debugMode"))throw new Error("Programmer error: options.baseTitle must contain the replacement parameter '@@@' to be useful.");return a}},blankURL:{setter:function(a){return a.substr(-1)!="?"?a+"?":a},value:"blank.html?"},encodeURI:{setter:function(a){l=a?encodeURIComponent:r;h=a?decodeURIComponent:r},value:false}}),m=document.title,p=200,n=0,k,b,i,s,t,E=function(a){p=400;var c=e.get("debugMode")?{width:"800px",height:"80px",border:"1px solid black"}:u;b=d("<iframe/>").css(c).attr({frameborder:"0",
id:"jet-history-frame",src:e.get("blankURL")+a}).appendTo(z)[0]},A=function(){var a=window.location.href,c=a.indexOf("#");return c>=0?a.substr(c+1):""},x=function(a){a=w(h(a));var c=q.get(a),g={};C.each(a.split("&"),function(o){o=o.split("=");g[o[0]]=o[1]});e.changeTitle(c).fire("change",g,c)},F=function(){if(!f.ie&&i)i=false;else if(!(!f.ie&&t)){var a=A();if(a!=k){t=true;var c;if(c=f.ie){if(c=f.ie<8){c=String(b.contentWindow.document.location.search);if(c.length==1&&c.charAt(0)=="?")c="";else if(c.length>=
2&&c.charAt(0)=="?")c=c.substring(1);c=c!=a}c=c}if(c)b.src=e.get("blankURL")+a;else if(f.ie)return;k=a;t=false;x(a)}}},w=function(a){return a===null||a===undefined?null:a===""?"":a.length==1&&a.charAt(0)=="#"?"":a.length>1&&a.charAt(0)=="#"?a.substring(1):a},G=function(){d(d.win).on("hashchange",function(){x(d.win.location.hash)})};jet.History.iframe.on("load",function(a,c){if(i)i=false;else{var g=String(c.search);if(g.charAt(0)=="?")g=g.length==1?"":g.substring(1);window.location.hash=g;x(g)}});
this.initialize=function(){m=document.title;if(f.ie)if(q.hasKey("DhtmlHistory_pageLoaded")){s=true;j=false}else{s=false;j=true;q.put("DhtmlHistory_pageLoaded",true)}return e};this.changeTitle=function(a){a=a&&a.newTitle?e.get("baseTitle").replace("@@@",a.newTitle):m;if(document.title==a)return e;document.title=a;if(f.ie)b.contentWindow.document.title=a;if(!f.ie&&!f.opera){a=h(document.location.hash);if(a!==""){a=l(w(a));document.location.hash=a}}return e};this.add=function(a,c){var g=l(w(a));window.setTimeout(function(){if(n>
0)n-=p;if(document.getElementById(g)&&e.get("debugMode")){var o="Exception: History locations can not have the same value as _any_ IDs that might be in the document,";o+=" due to a bug in IE; please ask the developer to choose a history location that does not match any HTML";o+=" IDs in this document. The following ID is already taken and cannot be a location: "+a;throw new Error(o);}q.put(a,c);t=i=true;k=g;window.location.hash=g;if(f.ie)b.src=e.get("blankURL")+g;t=false;e.changeTitle(c)},n);n+=p;
return e};q.setup({debugMode:e.get("debugMode")});var B=A();k=B;if("onhashchange"in d.win)G();else{if(f.opera){p=400;d("<img/>").style(u).attr("src","javascript:location.href='javascript:dhtmlHistory.checkLocation();';").appendTo(z)}f.ie&&E(B);d(d.win).on("unload",function(){j=null});if(f.ie)i=true;else if(q.hasKey("DhtmlHistory_pageLoaded")){j=i=false;s=true}else{j=i=true;q.put("DhtmlHistory_pageLoaded",true)}setInterval(F,100)}};d.extend(v,d.Base);d.History=v});
