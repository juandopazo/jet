/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("history",function(e){var f=e.UA,y=e.Lang,D=e.Array,t=e.context.body,w=f.opera,E={border:"0",margin:"0",padding:"0"},v={left:"-1000px",top:"-1000px",width:"1px",height:"1px",position:"absolute"},p=function(){var h,r=function(b){return b},k,g={},d=false,l,o=function(b){return y.isString(b)},m=function(b){if(!o(b)&&h)throw new Error("Please provide a valid key for window.historyStorage. Invalid key = "+b+".");},i=function(){if(!d){var b=l.value;if(b!==""&&b!==null){g=e.JSON.stringify(b);d=
true}}};return{setup:function(b){b=b||{};h=!!b.debugMode;k=b.encodeURI?encodeURIComponent:r;b=h?E:v;var j=h?{width:"800px",height:"80px",border:"1px solid black"}:v;l=e('<form><textarea id="jet-storage-field"></textarea></form>').attr("id","jet-storage-form").css(b).first().css(j)[0];w&&l.focus();return this},put:function(b,j){var s=k(b);m(s);this.hasKey(b)&&this.remove(b);g[s]=j;i();l.value=e.JSON.stringify(g);return this},get:function(b){b=k(b);m(b);i();b=g[b];if(b===undefined)b=null;return b},
remove:function(b){b=k(b);m(b);i();delete g[b];i();l.value=e.JSON.stringify(g);return this},reset:function(){l.value="";g={}},hasKey:function(b){b=k(b);m(b);i();return!y.isUndefined(g[b])},isValidKey:o}}(),x=function(){x.superclass.constructor.apply(this,arguments);var h,r=function(a){return a},k=r,g=r,d=this.addAttrs({firstLoad:{readOnly:true,value:h},baseTitle:{validator:function(a){a=a.indexOf("@@@")>=0;if(!a&&d.get("debugMode"))throw new Error("Programmer error: options.baseTitle must contain the replacement parameter '@@@' to be useful.");
return a}},blankURL:{setter:function(a){return a.substr(-1)!="?"?a+"?":a},value:"blank.html?"},encodeURI:{setter:function(a){k=a?encodeURIComponent:r;g=a?decodeURIComponent:r},value:false}}),l=document.title,o=200,m=0,i,b,j,s,u,F=function(a){o=400;var c=d.get("debugMode")?{width:"800px",height:"80px",border:"1px solid black"}:v;b=e("<iframe/>").css(c).attr({frameborder:"0",id:"jet-history-frame",src:d.get("blankURL")+a}).appendTo(t)[0]},z=function(){var a=window.location.href,c=a.indexOf("#");return c>=
0?a.substr(c+1):""},A=function(a){a=g(a);var c=p.get(a),q={};D.each(a.split("&"),function(n){n=n.split("=");q[n[0]]=n[1]});d.changeTitle(c).fire("change",q,c)},B=function(a){return a===null||a===undefined?null:a===""?"":a.length==1&&a.charAt(0)=="#"?"":a.length>1&&a.charAt(0)=="#"?a.substring(1):a},G=function(){var a=new e.EventTarget;t.onhashchange&&a.on("hashchange",t.onhashchange);t.onhashchange=function(){a.fire("hashchange",window.location.hash)};a.on("hashchange",A)};d.initialize=function(){l=
document.title;if(f.ie)if(p.hasKey("DhtmlHistory_pageLoaded")){s=true;h=false}else{s=false;h=true;p.put("DhtmlHistory_pageLoaded",true)}return d};d.changeTitle=function(a){a=a&&a.newTitle?d.get("baseTitle").replace("@@@",a.newTitle):l;if(document.title==a)return d;document.title=a;if(f.ie)b.contentWindow.document.title=a;if(!f.ie&&!w){a=g(document.location.hash);if(a!==""){a=k(B(a));document.location.hash=a}}return d};d.add=function(a,c){var q=k(B(a));window.setTimeout(function(){if(m>0)m-=o;if(document.getElementById(q)&&
d.get("debugMode")){var n="Exception: History locations can not have the same value as _any_ IDs that might be in the document,";n+=" due to a bug in IE; please ask the developer to choose a history location that does not match any HTML";n+=" IDs in this document. The following ID is already taken and cannot be a location: "+a;throw new Error(n);}p.put(a,c);u=j=true;i=q;window.location.hash=q;if(f.ie)b.src=d.get("blankURL")+q;u=false;d.changeTitle(c)},m);m+=o;return d};p.setup({debugMode:d.get("debugMode")});
if(w){o=400;e("<img/>").style(v).attr("src","javascript:location.href='javascript:dhtmlHistory.checkLocation();';").appendTo(t)}var C=z();i=C;if(f.ie&&f.ie<8)F(C);else f.ie>=8&&G();e(e.win).on("unload",function(){h=null});if(f.ie)j=true;else if(p.hasKey("DhtmlHistory_pageLoaded")){h=j=false;s=true}else{h=j=true;p.put("DhtmlHistory_pageLoaded",true)}setInterval(function(){if(!f.ie&&j)j=false;else if(!(!f.ie&&u)){var a=z();if(a!=i){u=true;var c;if(c=f.ie){if(c=f.ie<8){c=String(b.contentWindow.document.location.search);
if(c.length==1&&c.charAt(0)=="?")c="";else if(c.length>=2&&c.charAt(0)=="?")c=c.substring(1);c=c!=a}c=c}if(c)b.src=d.get("blankURL")+a;else if(f.ie)return;i=a;u=false;A(a)}}},100)};e.extend(x,e.Base);e.History=x});
