jet().add("history",function(e){var g=e.UA,x=e.Lang,C=e.Array,y=e.context.body,v=g.opera,D={border:"0",margin:"0",padding:"0"},u={left:"-1000px",top:"-1000px",width:"1px",height:"1px",position:"absolute"},p=function(){var h,r=function(b){return b},k,f={},d=false,l,o=function(b){return x.isString(b)},m=function(b){if(!o(b)&&h)throw new Error("Please provide a valid key for window.historyStorage. Invalid key = "+b+".");},i=function(){if(!d){var b=l.value;if(b!==""&&b!==null){f=e.JSON.stringify(b);d=
true}}};return{setup:function(b){b=b||{};h=!!b.debugMode;k=b.encodeURI?encodeURIComponent:r;b=h?D:u;var j=h?{width:"800px",height:"80px",border:"1px solid black"}:u;l=e('<form><textarea id="jet-storage-field"></textarea></form>').attr("id","jet-storage-form").css(b).first().css(j)[0];v&&l.focus();return this},put:function(b,j){var s=k(b);m(s);this.hasKey(b)&&this.remove(b);f[s]=j;i();l.value=e.JSON.stringify(f);return this},get:function(b){b=k(b);m(b);i();b=f[b];if(b===undefined)b=null;return b},
remove:function(b){b=k(b);m(b);i();delete f[b];i();l.value=e.JSON.stringify(f);return this},reset:function(){l.value="";f={}},hasKey:function(b){b=k(b);m(b);i();return!x.isUndefined(f[b])},isValidKey:o}}(),w=function(){w.superclass.constructor.apply(this,arguments);var h,r=function(a){return a},k=r,f=r,d=this.addAttrs({firstLoad:{readOnly:true,value:h},baseTitle:{validator:function(a){a=a.indexOf("@@@")>=0;if(!a&&d.get("debugMode"))throw new Error("Programmer error: options.baseTitle must contain the replacement parameter '@@@' to be useful.");
return a}},blankURL:{setter:function(a){return a.substr(-1)!="?"?a+"?":a},value:"blank.html?"},encodeURI:{setter:function(a){k=a?encodeURIComponent:r;f=a?decodeURIComponent:r},value:false}}),l=document.title,o=200,m=0,i,b,j,s,t,E=function(a){o=400;var c=d.get("debugMode")?{width:"800px",height:"80px",border:"1px solid black"}:u;b=e("<iframe/>").css(c).attr({frameborder:"0",id:"jet-history-frame",src:d.get("blankURL")+a}).appendTo(y)[0]},z=function(){var a=window.location.href,c=a.indexOf("#");return c>=
0?a.substr(c+1):""},F=function(a){a=f(a);var c=p.get(a),q={};C.each(a.split("&"),function(n){n=n.split("=");q[n[0]]=n[1]});d.changeTitle(c).fire("change",q,c)},A=function(a){return a===null||a===undefined?null:a===""?"":a.length==1&&a.charAt(0)=="#"?"":a.length>1&&a.charAt(0)=="#"?a.substring(1):a};d.initialize=function(){l=document.title;if(g.ie)if(p.hasKey("DhtmlHistory_pageLoaded")){s=true;h=false}else{s=false;h=true;p.put("DhtmlHistory_pageLoaded",true)}return d};d.changeTitle=function(a){a=a&&
a.newTitle?d.get("baseTitle").replace("@@@",a.newTitle):l;if(document.title==a)return d;document.title=a;if(g.ie)b.contentWindow.document.title=a;if(!g.ie&&!v){a=f(document.location.hash);if(a!==""){a=k(A(a));document.location.hash=a}}return d};d.add=function(a,c){var q=k(A(a));window.setTimeout(function(){if(m>0)m-=o;if(document.getElementById(q)&&d.get("debugMode")){var n="Exception: History locations can not have the same value as _any_ IDs that might be in the document,";n+=" due to a bug in IE; please ask the developer to choose a history location that does not match any HTML";
n+=" IDs in this document. The following ID is already taken and cannot be a location: "+a;throw new Error(n);}p.put(a,c);t=j=true;i=q;window.location.hash=q;if(g.ie)b.src=d.get("blankURL")+q;t=false;d.changeTitle(c)},m);m+=o;return d};p.setup({debugMode:d.get("debugMode")});if(v){o=400;e("<img/>").style(u).attr("src","javascript:location.href='javascript:dhtmlHistory.checkLocation();';").appendTo(y)}var B=z();i=B;g.ie&&E(B);e(e.win).on("unload",function(){h=null});if(g.ie)j=true;else if(p.hasKey("DhtmlHistory_pageLoaded")){h=
j=false;s=true}else{h=j=true;p.put("DhtmlHistory_pageLoaded",true)}setInterval(function(){if(!g.ie&&j)j=false;else if(!(!g.ie&&t)){var a=z();if(a!=i){t=true;var c;if(c=g.ie){c=String(b.contentWindow.document.location.search);if(c.length==1&&c.charAt(0)=="?")c="";else if(c.length>=2&&c.charAt(0)=="?")c=c.substring(1);c=c!=a}if(c)b.src=d.get("blankURL")+a;else if(g.ie)return;i=a;t=false;F(a)}}},100)};e.extend(w,e.Base);e.History=w});
