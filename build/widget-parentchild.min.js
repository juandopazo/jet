/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(d){function h(a){a=a||{};var b=this.get(i),c=b?[]:null;d.ArrayList.call(this);this._childrenContainer=this.get("contentBox");this.on("render",this._renderChildren);this.after("selectionChange",this._onSelectionChange);this.after("initializedChange",function(){this._addChildrenFromMarkup();this.add(a.children||[]);this.forEach(function(f){if(f.get(e))if(b)c.push(f);else c=f});c?this.set(j,c):this.set(l,0)})}function k(){this.after("selectedChange",this._childSelectedChange)}
var g=d.Lang,e="selected",l="selectedIndex",i="multiple",j="selection";d.mix(h,{ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));return g.isString(a)?d[a]:a}},defaultChildType:{value:"Widget"},children:{readOnly:true,getter:function(){return this._items}},selection:{value:null},multiple:{value:false,wriceOnce:true},selectedIndex:{validator:function(a){return g.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);b&&b.select&&b.select();return a},getter:function(){var a=
this.get(j);return a?a.get("index"):-1}}}});h.prototype={_addChildrenFromMarkup:function(){var a=[];this._childrenContainer.children().forEach(function(b){a.push({boundingBox:b})});this.add(a)},_onSelectionChange:function(a){if(this.get(i))this.forEach(function(b){b.set(e,d.Array.indexOf(a.newVal,b)>-1,{src:"_onSelectionChange"})});else a.prevVal&&a.prevVal.set(e,false,{src:"_onSelectionChange"})},_renderChildren:function(){var a=this._childrenContainer;this.forEach(function(b){b.render(a)})},_onChildSelect:function(a){if(a.src!==
"_onSelectionChange"){var b=null;if(this.get(i)){b=[];this.forEach(function(c){c.get(e)&&b.push(c)})}else if(a.newVal)b=a.target;this.set(j,b)}},_unHookChild:function(a){var b=a.target.get("index");this.splice(b,1);this.forEach(function(c,f){f>=b&&c.set("index",f)})},_add:function(a,b){var c=a.childType||this.get("childType");if(a&&this.fire("addChild",{child:a,index:b})){if(d.instanceOf(a,d.Widget))a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}this.splice(b,0,a);this.get("rendered")&&
a.render(this._childrenContainer);a.after("selectedChange",this._onChildSelect,this);a.on("destroy",this._unHookChild,this);this.fire("afterAddChild",{child:a,index:b})}return a},addChild:function(a,b){var c=this;g.isNumber(b)||(b=this.size());return g.isArray(a)?d.Array.map(a,function(f,m){return c._add(f,b+m)}):this._add(a,b)},add:function(a,b){this.addChild(a,b);return this},remove:function(a){if(g.isNumber(a))a=this.item(a);if(a&&this.fire("removeChild",{child:a})){a.destroy();this.fire("afterRemoveChild",
{child:a})}return this},first:function(){return this.item(0)},last:function(){return this.item(this.size()-1)},removeAll:function(){for(;this.size()>0;)this.remove(0);return this}};d.mix(h.prototype,d.ArrayList.prototype);d.mix(k,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,valueFn:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this.get("boundingBox");this.get(e)&&
a.addClass(this.getClassName(e))}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName(e))}}});k.prototype={_childSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName(e),a.newVal)},select:function(){return this.set(e,true)},unselect:function(){return this.set(e,false)},toggle:function(){return this.set(e,!this.get(e))},next:function(){return this.get("parent").get("children")[this.get("index")+1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-
1]||null}};d.add({WidgetParent:h,WidgetChild:k})});
