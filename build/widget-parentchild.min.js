/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(e){function h(){this.get(d)||this.set(d,[])}function i(){}var g=e.Lang,j=e.Array,l=e.Hash,k=e.Widget,d="children";e.mix(h,{NAME:"widget-parent",ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));return g.isString(a)?e[a]:a}},defaultChildType:{value:"WidgetChild"},children:{},selection:{value:null},multiple:{value:false,wriceOnce:true},atLeastOne:{value:false},selectedIndex:{validator:function(a){return g.isNumber(a)&&!!this.item(a)},setter:function(a){var b=
this.item(a);b&&b.select&&b.select();return a},getter:function(){var a=this.get("selection");return a?a.get("index"):-1}},childrenContainer:{setter:e,getter:function(a){return a||this.get("contentBox")}}},EVENTS:{render:function(){var a=this,b=this.get("multiple"),c=b?[]:null;this.each(this.add);l.each(k.DOM_EVENTS,function(f){a.on(f,a._domEventChildrenProxy)});this.each(function(f){if(f.get("selected"))if(b)c.push(f);else c=f});this.set("selection",c);c||this.set("selectedIndex",0)},afterSelectionChange:function(a,
b){b&&!this.get("multiple")&&this.each(function(c){c!=b&&g.isFunction(c.unselect)&&c.unselect()})}},HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().each(function(c){a=a||[];a.push({srcNode:b,boundingBox:c})});return a}}});h.prototype={_onChildSelect:function(a){var b=null;if(this.get("multiple")){b=[];this.each(function(c){c.get("selected")&&b.push(c)})}else if(a.newVal){b=a.target;this.each(function(c){c!=a.target&&c.get("selected")&&c.unselect()})}this.set("selection",
b)},_unHookChild:function(a){a=a.get("index");var b=this.get(d);b.splice(a,1);j.each(b,function(c,f){f>=a&&c.set("index",f)})},_domEventChildrenProxy:function(a){var b=k.getByNode(a.domEvent.target);b&&j.indexOf(this.get(d),b)>-1&&b.fire(a.type,{domEvent:a.domEvent})},add:function(a,b){var c=this.get("childType"),f=this,m=this.get(d);if(!g.isNumber(b))b=m.length;if(a&&this.fire("addChild",{child:a,index:b})){if(a instanceof c)a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}m[b]=a;a.render(this.get("childrenContainer"));
a.on("afterSelectedChange",e.bind(this._onChildSelect,this));a.on("destroy",function(n){f._unHookChild(n.target)});this.fire("afterAddChild",{child:a,index:b})}return this},item:function(a){return this.get(d)[a||0]},remove:function(a){if(g.isNumber(a))a=this.item(a);if(a&&this.fire("removeChild",{child:a})){var b=this.get(d);if(g.isNumber(a))a=b[a];this._unHookChild(a);a.destroy();this.fire("afterRemoveChild",{child:a})}return this},forEach:function(a,b){j.each(this.get(d),a,b||this);return this},
size:function(){return(this.get(d)||[]).length}};h.prototype.each=h.prototype.forEach;e.mix(i,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");l.each(k.DOM_EVENTS,function(c){b.unbind(c,a._domEventProxy)});this.get("selected")&&b.addClass(this.getClassName("selected"))},selectedChange:function(a){var b=
this.get("parent");!a.newVal&&b&&b.size()>1&&b.get("selection")==this&&!b.get("multiple")&&b.get("atLeastOne")&&a.preventDefault()},afterSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName("selected"),a.newVal)}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName("selected"))}}});i.prototype={select:function(){return this.set("selected",true)},unselect:function(){return this.set("selected",false)},toggle:function(){return this.set("selected",!this.get("selected"))},
next:function(){return this.get("parent").get(d)[this.get("index")+1]||null},previous:function(){return this.get("parent").get(d)[this.get("index")-1]||null}};e.add({WidgetParent:h,WidgetChild:i})});
