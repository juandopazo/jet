/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(d){function g(a){a=a||{};var b=this.get(i),c=b?[]:null;d.ArrayList.call(this);this.on("render",this._renderChildren);this.after("selectionChange",this._onSelectionChange);this.add(a.children||[]);this.forEach(function(f){if(f.get(e))if(b)c.push(f);else c=f});c?this.set(j,c):this.set(m,0)}function k(){this.after("selectedChange",this._childSelectedChange)}var h=d.Lang,l=d.Widget,e="selected",m="selectedIndex",i="multiple",j="selection";d.mix(g,{ATTRS:{childType:{getter:function(a){a||
(a=this.get("defaultChildType"));return h.isString(a)?d[a]:a}},defaultChildType:{value:"WidgetChild"},children:{readOnly:true,getter:function(){return this._items}},selection:{value:null},multiple:{value:false,wriceOnce:true},selectedIndex:{validator:function(a){return h.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);b&&b.select&&b.select();return a},getter:function(){var a=this.get(j);return a?a.get("index"):-1}},childrenContainer:{setter:d,getter:function(a){return a||this.get("contentBox")}}},
HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().forEach(function(c){a=a||[];a.push({srcNode:b,boundingBox:c})});return a}}});g.prototype={constructor:g,_onSelectionChange:function(a){if(this.get(i))this.forEach(function(b){b.set(e,d.Array.indexOf(a.newVal,b)>-1,{src:"_onSelectionChange"})});else a.prevVal&&a.prevVal.set(e,false,{src:"_onSelectionChange"})},_renderChildren:function(){var a=this,b=this.get("childrenContainer");d.Object.each(l.DOM_EVENTS,function(c){a.on(c,
a._domEventChildrenProxy)});this.forEach(function(c){c.render(b)});this.get("selection")||this.set(m,0)},_onChildSelect:function(a){if(a.src!=="_onSelectionChange"){var b=null;if(this.get(i)){b=[];this.forEach(function(c){c.get(e)&&b.push(c)})}else if(a.newVal)b=a.target;this.set(j,b)}},_unHookChild:function(a){var b=a.target.get("index");this.splice(b,1);this.forEach(function(c,f){f>=b&&c.set("index",f)})},_domEventChildrenProxy:function(a){var b=l.getByNode(a.domEvent.target);this.indexOf(b)>-1&&
b.fire(a.type,{domEvent:a.domEvent})},_add:function(a,b){var c=a.childType||this.get("childType");if(a&&this.fire("addChild",{child:a,index:b})){if(d.instanceOf(a,d.Widget))a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}this.splice(b,0,a);this.get("rendered")&&a.render(this.get("childrenContainer"));a.after("selectedChange",this._onChildSelect,this);a.on("destroy",this._unHookChild,this);this.fire("afterAddChild",{child:a,index:b})}return a},addChild:function(a,b){var c=this;h.isNumber(b)||
(b=this.size());return h.isArray(a)?d.Array.map(a,function(f,n){return c._add(f,b+n)}):this._add(a,b)},add:function(a,b){this.addChild(a,b);return this},remove:function(a){if(h.isNumber(a))a=this.item(a);if(a&&this.fire("removeChild",{child:a})){a.destroy();this.fire("afterRemoveChild",{child:a})}return this},first:function(){return this.item(0)},last:function(){return this.item(this.size()-1)},removeAll:function(){for(;this.size()>0;)this.remove(0);return this}};d.mix(g.prototype,d.ArrayList.prototype);
d.mix(k,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");d.Object.each(l.DOM_EVENTS,function(c){b.unbind(c,a._domEventProxy)});this.get(e)&&b.addClass(this.getClassName(e))}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName(e))}}});k.prototype={_childSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName(e),
a.newVal)},select:function(){return this.set(e,true)},unselect:function(){return this.set(e,false)},toggle:function(){return this.set(e,!this.get(e))},next:function(){return this.get("parent").get("children")[this.get("index")+1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-1]||null}};d.add({WidgetParent:g,WidgetChild:k})});
