/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(d){function g(){this._items=this._items||[];this.on("render",this._renderChildren);this.after("selectionChange",this._handleMultipleChildren)}function h(){}var e=d.Lang,i=d.Widget;d.mix(g,{NAME:"widget-parent",ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));return e.isString(a)?d[a]:a}},defaultChildType:{value:"WidgetChild"},children:{validator:e.isArray,setter:function(a){this._items=a},getter:function(){return this._items}},selection:{value:null},
multiple:{value:false,wriceOnce:true},atLeastOne:{value:false},selectedIndex:{validator:function(a){return e.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);b&&b.select&&b.select();return a},getter:function(){var a=this.get("selection");return a?a.get("index"):-1}},childrenContainer:{setter:d,getter:function(a){return a||this.get("contentBox")}}},EVENTS:{afterSelectionChange:function(a,b){b&&!this.get("multiple")&&this.forEach(function(c){c!=b&&e.isFunction(c.unselect)&&c.unselect()})}},
HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().forEach(function(c){a=a||[];a.push({srcNode:b,boundingBox:c})});return a}}});g.prototype={constructor:g,_renderChildren:function(){var a=this,b=this.get("multiple"),c=b?[]:null;this.forEach(this.add,this);d.Object.each(i.DOM_EVENTS,function(f){a.on(f,a._domEventChildrenProxy)});this.forEach(function(f){if(f.get("selected"))if(b)c.push(f);else c=f});this.set("selection",c);c||this.set("selectedIndex",0)},_onChildSelect:function(a){var b=
null;if(this.get("multiple")){b=[];this.forEach(function(c){c.get("selected")&&b.push(c)})}else if(a.newVal){b=a.target;this.forEach(function(c){c!=a.target&&c.get("selected")&&c.unselect()})}this.set("selection",b)},_unHookChild:function(a){a=a.get("index");this._items.splice(a,1);this.forEach(function(b,c){c>=a&&b.set("index",c)})},_domEventChildrenProxy:function(a){var b=i.getByNode(a.domEvent.target);this.indexOf(b)>-1&&b.fire(a.type,{domEvent:a.domEvent})},add:function(a,b){var c=this.get("childType"),
f=this,j=this._items;if(!e.isNumber(b))b=j.length;if(a&&this.fire("addChild",{child:a,index:b})){if(a instanceof c)a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}j[b]=a;a.render(this.get("childrenContainer"));a.on("afterSelectedChange",d.bind(this._onChildSelect,this));a.on("destroy",function(k){f._unHookChild(k.target)});this.fire("afterAddChild",{child:a,index:b})}return this},remove:function(a){if(e.isNumber(a))a=this.item(a);if(a&&this.fire("removeChild",{child:a})){var b=this._items;
if(e.isNumber(a))a=b[a];this._unHookChild(a);a.destroy();this.fire("afterRemoveChild",{child:a})}return this},item:function(a){return this._items[a||0]}};d.mix(g.prototype,d.ArrayList.prototype);d.mix(h,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");d.Object.each(i.DOM_EVENTS,function(c){b.unbind(c,
a._domEventProxy)});this.get("selected")&&b.addClass(this.getClassName("selected"))},selectedChange:function(a){var b=this.get("parent");!a.newVal&&b&&b.size()>1&&b.get("selection")==this&&!b.get("multiple")&&b.get("atLeastOne")&&a.preventDefault()},afterSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName("selected"),a.newVal)}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName("selected"))}}});h.prototype={select:function(){return this.set("selected",
true)},unselect:function(){return this.set("selected",false)},toggle:function(){return this.set("selected",!this.get("selected"))},next:function(){return this.get("parent").get("children")[this.get("index")+1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-1]||null}};d.add({WidgetParent:g,WidgetChild:h})});
