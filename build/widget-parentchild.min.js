/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(e){function g(){}function h(){}var f=e.Lang,i=e.Array,k=e.Hash,j=e.Widget;e.mix(g,{NAME:"widget-parent",ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));return f.isString(a)?e[a]:a}},defaultChildType:{value:"WidgetChild"},children:{value:[]},selection:{value:null},multiple:{value:false,wriceOnce:true},selectedIndex:{validator:function(a){return f.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);b&&b.select&&b.select();
return a},getter:function(){var a=this.get("selection");return a?a.get("index"):-1}},childrenContainer:{setter:e,getter:function(a){return a||this.get("contentBox")}}},EVENTS:{render:function(){var a=this,b=this.get("multiple"),c=b?[]:null;this.each(this.add);k.each(j.DOM_EVENTS,function(d){a.on(d,a._domEventChildrenProxy)});this.each(function(d){if(d.get("selected"))if(b)c.push(d);else c=d});this.set("selection",c);c||this.set("selectedIndex",0)},afterSelectionChange:function(a,b){b&&!this.get("multiple")&&
this.each(function(c){c!=b&&f.isFunction(c.unselect)&&c.unselect()})}},HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().each(function(){a=a||[];a.push({srcNode:b,boundingBox:this})});return a}}});g.prototype={_onChildSelect:function(a,b){var c=null;if(this.get("multiple")){c=[];this.each(function(d){d.get("selected")&&c.push(d)})}else if(b){c=a.target;this.each(function(d){d!=a.target&&d.get("selected")&&d.unselect()})}this.set("selection",c)},_unHookChild:function(a){a=
a.get("index");var b=this.get("children");b.splice(a,1);i.each(b,function(c,d){d>=a&&c.set("index",d)})},_domEventChildrenProxy:function(a,b){var c=j.getByNode(b.target);c&&i.indexOf(c,this.get("children"))>-1&&c.fire(a.type,b)},add:function(a,b){if(this.fire("addChild",a,b)){var c=this.get("childType"),d=this.get("children"),l=this;if(a instanceof c)a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}d[b]=a;a.render(this.get("childrenContainer"));a.on("afterSelectedChange",e.bind(this._onChildSelect,
this));a.on("destroy",function(m){l._unHookChild(m.target)});d[f.isNumber(b)?b:d.length]=a;this.fire("afterAddChild",a,b)}return this},item:function(a){return this.get("children")[a||0]},remove:function(a){if(this.fire("removeChild",a)){var b=this.get("children");if(f.isNumber(a))a=b[a];this._unHookChild(a);a.destroy();this.fire("afterRemoveChild",a)}return this},each:function(a,b){i.each(this.get("children"),a,b||this);return this}};e.mix(h,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},
parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");k.each(j.DOM_EVENTS,function(c){b.unbind(c,a._domEventProxy)});this.get("selected")&&b.addClass(this.getClassName("selected"))},afterSelectedChange:function(a,b){var c=this.getClassName("selected"),d=this.get("boundingBox");if(b){d.addClass(c);this.fire("select")}else d.removeClass(c)}},HTML_PARSER:{selected:function(){return this.get("boundingBox").hasClass(this.getClassName("selected"))}}});
h.prototype={select:function(){return this.set("selected",true)},unselect:function(){return this.set("selected",false)},toggle:function(){return this.set("selected",!this.get("selected"))},next:function(){return this.get("parent").get("children")[this.get("index")+1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-1]||null}};e.add({WidgetParent:g,WidgetChild:h})});
