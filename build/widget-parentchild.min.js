/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(d){function g(a){a=a||{};var b=this.get(i),c=b?[]:null;d.ArrayList.call(this);this.on("render",this._renderChildren);this.after("selectionChange",this._handleMultipleChildren);this.add(a.children||[]);this.forEach(function(f){if(f.get(e))if(b)c.push(f);else c=f});c?this.set(j,c):this.set(m,0)}function k(){}var h=d.Lang,l=d.Widget,e="selected",m="selectedIndex",i="multiple",j="selection";d.mix(g,{ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));
return h.isString(a)?d[a]:a}},defaultChildType:{value:"WidgetChild"},children:{readOnly:true,getter:function(){return this._items}},selection:{value:null},multiple:{value:false,wriceOnce:true},atLeastOne:{value:false},selectedIndex:{validator:function(a){return h.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);b&&b.select&&b.select();return a},getter:function(){var a=this.get(j);return a?a.get("index"):-1}},childrenContainer:{setter:d,getter:function(a){return a||this.get("contentBox")}}},
HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().forEach(function(c){a=a||[];a.push({srcNode:b,boundingBox:c})});return a}}});g.prototype={constructor:g,_handleMultipleChildren:function(a){this.get(i)||this.forEach(function(b){b!==a.newVal&&b.set(e,false)})},_renderChildren:function(){var a=this,b=this.get("childrenContainer");d.Object.each(l.DOM_EVENTS,function(c){a.on(c,a._domEventChildrenProxy)});this.forEach(function(c){c.render(b)});this.get("selection")||this.set(m,
0)},_onChildSelect:function(a){var b=null;if(this.get(i)){b=[];this.forEach(function(c){c.get(e)&&b.push(c)})}else if(a.newVal)b=a.target;else if(!a.prevVal&&this.get("atLastOne")){a.preventDefault();return}this.set(j,b)},_unHookChild:function(a){var b=a.target.get("index");this.splice(b,1);this.forEach(function(c,f){f>=b&&c.set("index",f)})},_domEventChildrenProxy:function(a){var b=l.getByNode(a.domEvent.target);this.indexOf(b)>-1&&b.fire(a.type,{domEvent:a.domEvent})},_add:function(a,b){var c=this.get("childType");
if(a&&this.fire("addChild",{child:a,index:b})){if(a instanceof c)a.set("parent",this);else{a.parent=this;a.index=b;a=new c(a)}this.splice(b,0,a);this.get("rendered")&&a.render(this.get("childrenContainer"));a.on("selectedChange",this._onChildSelect,this);a.on("destroy",this._unHookChild,this);this.fire("afterAddChild",{child:a,index:b})}},add:function(a,b){h.isNumber(b)||(b=this.size());h.isArray(a)?d.Array.forEach(a,function(c,f){this._add(c,b+f)},this):this._add(a,b);return this},remove:function(a){if(h.isNumber(a))a=
this.item(a);if(a&&this.fire("removeChild",{child:a})){a.destroy();this.fire("afterRemoveChild",{child:a})}return this},removeAll:function(){for(;this.size()>0;)this.remove(0);return this}};d.mix(g.prototype,d.ArrayList.prototype);d.mix(k,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");
d.Object.each(l.DOM_EVENTS,function(c){b.unbind(c,a._domEventProxy)});this.get(e)&&b.addClass(this.getClassName(e))},afterSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName(e),a.newVal)}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName(e))}}});k.prototype={select:function(){return this.set(e,true)},unselect:function(){return this.set(e,false)},toggle:function(){return this.set(e,!this.get(e))},next:function(){return this.get("parent").get("children")[this.get("index")+
1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-1]||null}};d.add({WidgetParent:g,WidgetChild:k})});
