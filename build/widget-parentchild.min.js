/**
 * @module widget-parentchild
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-parentchild",function(d){function g(){}function h(){}var f=d.Lang,i=d.Array,k=d.Hash,j=d.Widget;d.mix(g,{NAME:"widget-parent",ATTRS:{childType:{getter:function(a){a||(a=this.get("defaultChildType"));return f.isString(a)?d[a]:a}},defaultChildType:{value:"WidgetChild"},children:{value:[]},selection:{value:null},multiple:{value:false,wriceOnce:true},atLeastOne:{value:false},selectedIndex:{validator:function(a){return f.isNumber(a)&&!!this.item(a)},setter:function(a){var b=this.item(a);
b&&b.select&&b.select();return a},getter:function(){var a=this.get("selection");return a?a.get("index"):-1}},childrenContainer:{setter:d,getter:function(a){return a||this.get("contentBox")}}},EVENTS:{render:function(){var a=this,b=this.get("multiple"),c=b?[]:null;this.each(this.add);k.each(j.DOM_EVENTS,function(e){a.on(e,a._domEventChildrenProxy)});this.each(function(e){if(e.get("selected"))if(b)c.push(e);else c=e});this.set("selection",c);c||this.set("selectedIndex",0)},afterSelectionChange:function(a,
b){b&&!this.get("multiple")&&this.each(function(c){c!=b&&f.isFunction(c.unselect)&&c.unselect()})}},HTML_PARSER:{children:function(){var a,b=this.get("contentBox");b.children().each(function(c){a=a||[];a.push({srcNode:b,boundingBox:c})});return a}}});g.prototype={_onChildSelect:function(a){var b=null;if(this.get("multiple")){b=[];this.each(function(c){c.get("selected")&&b.push(c)})}else if(a.newVal){b=a.target;this.each(function(c){c!=a.target&&c.get("selected")&&c.unselect()})}this.set("selection",
b)},_unHookChild:function(a){a=a.get("index");var b=this.get("children");b.splice(a,1);i.each(b,function(c,e){e>=a&&c.set("index",e)})},_domEventChildrenProxy:function(a){var b=j.getByNode(a.domEvent.target);b&&i.indexOf(b,this.get("children"))>-1&&b.fire(a.type,{domEvent:a.domEvent})},add:function(a,b){var c=this.get("childType"),e=this,l=this.get("children");if(!f.isNumber(b))b=l.length;if(a&&this.fire("addChild",{child:a,index:b})){if(a instanceof c)a.set("parent",this);else{a.parent=this;a.index=
b;a=new c(a)}l[b]=a;a.render(this.get("childrenContainer"));a.on("afterSelectedChange",d.bind(this._onChildSelect,this));a.on("destroy",function(m){e._unHookChild(m.target)});this.fire("afterAddChild",{child:a,index:b})}return this},item:function(a){return this.get("children")[a||0]},remove:function(a){if(f.isNumber(a))a=this.item(a);if(a&&this.fire("removeChild",{child:a})){var b=this.get("children");if(f.isNumber(a))a=b[a];this._unHookChild(a);a.destroy();this.fire("afterRemoveChild",{child:a})}return this},
each:function(a,b){i.each(this.get("children"),a,b||this);return this},size:function(){return(this.get("children")||[]).length}};d.mix(h,{NAME:"widget-child",ATTRS:{selected:{value:false},index:{value:0},parent:{value:null},root:{readOnly:true,getter:function(){for(var a=this.get("parent");a.get("parent");)a=a.get("parent");return a}}},EVENTS:{render:function(){var a=this,b=this.get("boundingBox");k.each(j.DOM_EVENTS,function(c){b.unbind(c,a._domEventProxy)});this.get("selected")&&b.addClass(this.getClassName("selected"))},
selectedChange:function(a){var b=this.get("parent");!a.newVal&&b&&b.size()>1&&b.get("selection")==this&&!b.get("multiple")&&b.get("atLeastOne")&&a.preventDefault()},afterSelectedChange:function(a){this.get("boundingBox").toggleClass(this.getClassName("selected"),a.newVal)}},HTML_PARSER:{selected:function(a){return a.hasClass(this.getClassName("selected"))}}});h.prototype={select:function(){return this.set("selected",true)},unselect:function(){return this.set("selected",false)},toggle:function(){return this.set("selected",
!this.get("selected"))},next:function(){return this.get("parent").get("children")[this.get("index")+1]||null},previous:function(){return this.get("parent").get("children")[this.get("index")-1]||null}};d.add({WidgetParent:g,WidgetChild:h})});
