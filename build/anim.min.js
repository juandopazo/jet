/**
 * @module anim
 * @requires node, node-deferred;
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("anim",function(g){var j=g.Lang,r=g.Hash,m=g.Base,s=g.Array,n=function(a){return!j.isString(a)?a:a.substr(-2,a.length)=="px"?parseFloat(a.substr(0,a.length-2)):parseFloat(a)},o={linear:function(a,b,c,d){return(c-b)*a/d+b},easein:function(a,b,c,d,e){return c-(c-b)*Math.pow((c>=b?-1:1)*(a/d-1),e)},easeout:function(a,b,c,d,e){return b+(c-b)*Math.pow(a/d,e)},sling:function(a,b,c,d,e){b=[b,b+(c<b?1:-1)*e,c];a=a/d;d=b.length;c=[];for(e=0;e<d;++e)c[e]=b[e];for(b=1;b<d;++b)for(e=0;e<d-b;++e)c[e]=
(1-a)*c[e]+a*c[parseInt(e+1,10)];return c[0]}};if(!jet.TimeFrame){var t=function(){var a=[],b,c=false;return{fps:50,play:function(){var d=this;if(!c){b&&clearInterval(b);b=setInterval(function(){d.fire("enterFrame",{time:(new Date).getTime()})},Math.round(1E3/d.fps));c=true}return d},stop:function(){b&&clearInterval(b);c=false;return this},addTween:function(d){a[a.length]=d;return this},removeTween:function(d){s.remove(d,a);return a.length===0?this.stop():this}}}();jet.TimeFrame=g.mix(new g.EventTarget,
t)}m=m.create("tween",m,[],{ATTRS:{node:{setter:g},from:{attribute:false},to:{required:true},easing:{value:o.linear,setter:function(a){return j.isFunction(a)?a:o[a]}},easingStrength:{value:2,validator:function(a){return a>=0}},duration:{value:1E3,setter:function(a){return a=="fast"?500:a=="slow"?4E3:j.isNumber(a)?a:1E3}},playing:{value:false,validator:j.isBoolean},startTime:{value:0},previousTime:{value:0}}},{_enterFrame:function(a){a=a.time;if(this.get("playing")){this.get("startTime")||this.set("startTime",
a);var b=this,c=this.get("easing"),d=this.get("to"),e=this.get("from"),f=this.get("duration"),h=this.get("easingStrength"),p=this.get("node"),q=a-this.get("startTime")+this.get("previousTime");if(q<f)r.each(d,function(k,i){var l=c(q,e[k],i,f,h);if(i>e[k]&&l>i||i<e[k]&&l<i)l=i;if(b.fire("tween",{property:k,value:l}))p.css(k,l);else q=f});else{b.stop();setTimeout(function(){b.fire("end")},0)}}},play:function(){var a=this.get("node"),b=a.currentStyle(),c=this.get("from")||{},d=this.get("to"),e,f=jet.TimeFrame;
if(d.left||d.top)e=a.offset();r.each(d,function(h,p){d[h]=n(p);if(!c[h])switch(h){case "left":c[h]=e.left;break;case "top":c[h]=e.top;break;case "width":c[h]=a.attr("offsetWidth");break;case "height":c[h]=a.attr("offsetHeight");break;default:c[h]=j.isNumber(n(b[h]))?n(b[h]):0}});this.set("from",c);if(this.fire("start")){this.set("playing",true);f.on("enterFrame",this._enterFrame,this);f.addTween(this).play()}return this},stop:function(){this.set("playing",false);var a=jet.TimeFrame;a.removeTween(this);
a.unbind("enterFrame",this._enterFrame);this.set("previousTime",0);return this.set("startTime",0)},pause:function(){this.set("playing",false);var a=jet.TimeFrame;a.removeTween(this);a.unbind("enterFrame",this._enterFrame);return this.set("previousTime",(new Date).getTime()-this.get("startTime"))},reverse:function(){var a=this.get("from");return this.set("from",this.get("to")).set("to",a)},destructor:function(){this.stop()}});g.mix(g.NodeList.prototype,{animate:function(a,b,c,d){return this.defer(function(e){var f=
this.tw=new g.Tween({node:this,to:a,duration:b,easing:c});f.on("end",e.resolve,e);f.play()}).then(d)},fadeIn:function(a,b,c){return this.animate({opacity:1},a,b,c)},fadeOut:function(a,b,c){return this.animate({opacity:0},a,b,c)},fadeToggle:function(a,b,c){var d=[];this.forEach(function(e){e=g(e);d.push(this.defer(function(f){f=g.bind(f.resolve,f);e.css("opacity")==1?e.fadeOut(a,b,f):e.fadeIn(a,b,f)}))});return this.when(d).then(c)},slideDown:function(a,b,c){var d=this,e=this.css("overflow");return this.css("overflow",
"hidden").animate({height:this.oHeight},a,b,function(){d.css("overflow",e);c.call(d)})},slideUp:function(a,b,c){var d=this,e=d.css("overflow");return d.css("overflow","hidden").animate({height:0},a,b,function(){d.css("overflow",e);c.call(d)})},stop:function(){this.tw&&this.tw.stop();return this.reject()}});g.add({Tween:m,Easing:o})});
