/**
 * @module io
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(g){var l=g.win,p=g.Lang,w=g.Hash,s=!!l.ActiveXObject,x=!!l.XMLHttpRequest,k=function(a){return new l.ActiveXObject(a)},t=function(a){var b=[];w.each(a,function(e,c){b.push(e+"="+c)});return b.join("&")},q=function(a){var b;try{b=k("Msxml2.DOMDocument.6.0");q=function(d){return d=="xsl"?k("Msxml2.FreeThreadedDOMDocument.6.0"):k("Msxml2.DOMDocument.6.0")}}catch(e){try{b=k("Msxml2.DOMDocument.3.0");q=function(d){return d=="xsl"?k("Msxml2.FreeThreadedDOMDocument.3.0"):k("Msxml2.DOMDocument.3.0")}}catch(c){}}return q(a)},
o=function(){var a=location.host;if((location.protocol=="file:"||a=="localhost"||a=="127.0.0.1")&&s)o=function(){return k("Microsoft.XMLHTTP")};else if(x)o=function(){return new XMLHttpRequest};else if(s)o=function(){return k("Microsoft.XMLHTTP")};return o()},u=function(a,b,e){var c=null;if(a.responseXML)c=a.responseXML;else if(l.DOMParser){c=new l.DOMParser;c=c.parseFromString(a.responseText||a,"text/xml")}else if(s){c=q(b);c.async=false;c.loadXML(a.responseText||a);c.parseError.errorCode!==0&&e("Bad status",
c.parseError)}else e(0,{reason:"Can't find a suitable XML parser",srcText:a});return c},v=function(a,b,e){b=b||a.getResponseHeader("Content-type");switch(b){case "application/xml":case "xml":case "xsl":return u(a,b,e);case "json":try{return g.JSON.parse(a.responseText)}catch(c){g.error(c)}break;default:return a.responseText}};g.ajax=function(a){var b=o(),e=a.success,c=null,d=a.dataType,f=a.timeout||1E4,h=a.method||"GET",i=a.async||true,j=a.complete||function(){},y=function(){e&&e.apply(g,arguments);
j.apply(g,arguments)},m=function(z,A,B){a.error&&a.error(z,A,B);j.apply(g,arguments)},n=a.url;if(b){if(d&&(d==="xml"||d==="xsl")&&b.overrideMimeType)b.overrideMimeType("text/xml");if(n){if(n.substr(n.length-1)!="?")n+="?";if(a.data)n+=t(a.data);if(i===true)b.onreadystatechange=function(){if(b.readyState===4)if(b.status===404)m("File not found",b.status,b);else if(b.status===408)m("timeout",b.status,b);else b.status===200||b.responseText||b.responseXML?y(v(b,d,m),b):m("Bad status",b.status,b)};try{b.open(h,
n,i);b.send(null)}catch(C){m("Bad status",404,b)}if(i===false)c=v(b,d,m);else setTimeout(function(){if(b.readyState!==4){b.abort();m("timeout",408,b)}},f)}}return c||g};g.IO={utils:{parseXML:u}};if(!jet.IO)jet.IO={};if(!jet.IO.jsonpCallbacks)jet.IO.jsonpCallbacks=[];g.jsonp=function(a){a=a||{};var b=a.jsonCallbackParam||"p",e=jet.IO.jsonpCallbacks,c=e.length,d=false,f=a.url;if(f){e[c]=function(h){d=true;a.success&&a.success(h);a.complete&&a.complete(h)};if(f.substr(f.length-1)!="?")f+="?";if(!a.data)a.data=
{};a.data[b]="jet.IO.jsonpCallbacks["+c+"]";setTimeout(function(){g.Get.script(f+t(a.data))},0);setTimeout(function(){if(!d){var h={message:"Request failed",reason:"Timeout"};a.error&&a.error(h);a.complete&&a.complete(h)}},a.timeout||1E4)}};var r=function(a,b,e){e=e||{};if(l.XSLTProcessor)r=function(c,d,f){var h=new window.XSLTProcessor,i;h.importStylesheet(d);for(i in f)f.hasOwnProperty(i)&&h.setParameter(null,i,f[i]);return g(h.transformToFragment(c,g.context))};else if(l.ActiveXObject)r=function(c,
d,f){var h=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),i;h.stylesheet=d;d=h.createProcessor();d.input=c;for(i in f)f.hasOwnProperty(i)&&d.addParameter(i,f[i]);d.transform();return g(d.output)};return r(a,b,e)};g.IO.xsl=function(a){var b=a.xml,e=a.xsl,c=a.params,d,f,h=function(j){a.error&&a.error(j);a.complete&&a.complete(j)},i=function(){if(d&&f){var j=r(d,f,c);a.success&&a.success(j);a.complete&&a.complete(j)}};if(p.isString(b)||p.isString(e)){if(p.isString(b))g.ajax({url:b,dataType:"xml",
success:function(j){d=j;i()},error:h});else d=b;if(p.isString(e))g.ajax({url:e,dataType:"xsl",success:function(j){f=j;i()},error:h});else f=e}else{f=d=b;i()}}});
