/**
 * @module io
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(f){var m=f.win,o=f.Lang,w=f.Hash,s=!!m.ActiveXObject,k=function(a){return new m.ActiveXObject(a)},t=function(a){var b=[];w.each(a,function(e,c){b.push(e+"="+c)});return b.join("&")},p=function(a){var b;try{b=k("Msxml2.DOMDocument.6.0");p=function(d){return d=="xsl"?k("Msxml2.FreeThreadedDOMDocument.6.0"):k("Msxml2.DOMDocument.6.0")}}catch(e){try{b=k("Msxml2.DOMDocument.3.0");p=function(d){return d=="xsl"?k("Msxml2.FreeThreadedDOMDocument.3.0"):k("Msxml2.DOMDocument.3.0")}}catch(c){}}return p(a)},
r=function(){var a=location.host;r=s&&(!HAS_HXR||location.protocol=="file:"||a=="localhost"||a=="127.0.0.1")?function(){return k("Microsoft.XMLHTTP")}:function(){return new XMLHttpRequest};return r()},u=function(a,b,e){var c=null;if(a.responseXML)c=a.responseXML;else if(m.DOMParser){c=new m.DOMParser;c=c.parseFromString(a.responseText||a,"text/xml")}else if(s){c=p(b);c.async=false;c.loadXML(a.responseText||a);c.parseError.errorCode!==0&&e("Bad status",c.parseError)}else e(0,{reason:"Can't find a suitable XML parser",
srcText:a});return c},v=function(a,b,e){b=b||a.getResponseHeader("Content-type");switch(b){case "application/xml":case "xml":case "xsl":return u(a,b,e);case "json":try{return f.JSON.parse(a.responseText)}catch(c){f.error(c)}break;default:return a.responseText}};f.ajax=function(a){var b=r(),e=a.success,c=null,d=a.dataType,g=a.timeout||1E4,h=a.method||"GET",i=a.async||true,j=a.complete||function(){},x=function(){e&&e.apply(f,arguments);j.apply(f,arguments)},l=function(y,z,A){a.error&&a.error(y,z,A);
j.apply(f,arguments)},n=a.url;if(b){if(d&&(d==="xml"||d==="xsl")&&b.overrideMimeType)b.overrideMimeType("text/xml");if(n){if(n.substr(n.length-1)!="?")n+="?";if(a.data)n+=t(a.data);if(i===true)b.onreadystatechange=function(){if(b.readyState===4)if(b.status===404)l("File not found",b.status,b);else if(b.status===408)l("timeout",b.status,b);else b.status===200||b.responseText||b.responseXML?x(v(b,d,l),b):l("Bad status",b.status,b)};try{b.open(h,n,i);b.send(null)}catch(B){l("Bad status",404,b)}if(i===
false)c=v(b,d,l);else setTimeout(function(){if(b.readyState!==4){b.abort();l("timeout",408,b)}},g)}}return c||f};f.get=function(a,b){b=b||{};b.url=a;return f.ajax(b)};f.IO={utils:{parseXML:u}};if(!jet.IO)jet.IO={};if(!jet.IO.jsonpCallbacks)jet.IO.jsonpCallbacks=[];f.jsonp=function(a){a=a||{};var b=a.jsonCallbackParam||"p",e=jet.IO.jsonpCallbacks,c=e.length,d=false,g=a.url;if(g){e[c]=function(h){d=true;a.success&&a.success(h);a.complete&&a.complete(h)};if(g.substr(g.length-1)!="?")g+="?";if(!a.data)a.data=
{};a.data[b]="jet.IO.jsonpCallbacks["+c+"]";setTimeout(function(){f.Get.script(g+t(a.data))},0);setTimeout(function(){if(!d){var h={message:"Request failed",reason:"Timeout"};a.error&&a.error(h);a.complete&&a.complete(h)}},a.timeout||1E4)}};var q=function(a,b,e){e=e||{};if(m.XSLTProcessor)q=function(c,d,g){var h=new window.XSLTProcessor,i;h.importStylesheet(d);for(i in g)g.hasOwnProperty(i)&&h.setParameter(null,i,g[i]);return f(h.transformToFragment(c,f.context))};else if(m.ActiveXObject)q=function(c,
d,g){var h=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),i;h.stylesheet=d;d=h.createProcessor();d.input=c;for(i in g)g.hasOwnProperty(i)&&d.addParameter(i,g[i]);d.transform();return f(d.output)};return q(a,b,e)};f.IO.xsl=function(a){var b=a.xml,e=a.xsl,c=a.params,d,g,h=function(j){a.error&&a.error(j);a.complete&&a.complete(j)},i=function(){if(d&&g){var j=q(d,g,c);a.success&&a.success(j);a.complete&&a.complete(j)}};if(o.isString(b)||o.isString(e)){if(o.isString(b))f.ajax({url:b,dataType:"xml",
success:function(j){d=j;i()},error:h});else d=b;if(o.isString(e))f.ajax({url:e,dataType:"xsl",success:function(j){g=j;i()},error:h});else g=e}else{g=d=b;i()}}});
