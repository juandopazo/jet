/**
 * @module io
 * @requires deferred
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(g){function o(){o.superclass.constructor.apply(this,arguments)}var k=g.config.win,l=g.Lang,r=g.Object,u=!!k.ActiveXObject,z=!!k.XMLHttpRequest,m=function(c){return new k.ActiveXObject(c)},v=function(c){var a=[];r.each(c,function(b,d){a.push(b+"="+d)});return a.join("&")},p=function(c){var a;try{a=m("Msxml2.DOMDocument.6.0");p=function(e){return e=="xsl"?m("Msxml2.FreeThreadedDOMDocument.6.0"):m("Msxml2.DOMDocument.6.0")}}catch(b){try{a=m("Msxml2.DOMDocument.3.0");p=function(e){return e==
"xsl"?m("Msxml2.FreeThreadedDOMDocument.3.0"):m("Msxml2.DOMDocument.3.0")}}catch(d){}}return p(c)},s=function(){var c=location.host;s=u&&(!z||location.protocol=="file:"||c=="localhost"||c=="127.0.0.1")?function(){return m("Microsoft.XMLHTTP")}:function(){return new XMLHttpRequest};return s()},w=function(c,a,b){a=a||c.getResponseHeader("Content-type");switch(a){case "application/xml":case "xml":case "xsl":var d=null;if(c.responseXML)d=c.responseXML;else if(k.DOMParser){d=new k.DOMParser;d=d.parseFromString(c.responseText||
c,"text/xml")}else if(u){d=p(a);d.async=false;d.loadXML(c.responseText||c);d.parseError.errorCode!==0&&b("Bad status",d.parseError)}else b(0,{reason:"Can't find a suitable XML parser",srcText:c});return d;case "json":try{return g.JSON.parse(c.responseText)}catch(e){g.error(e)}break;default:return c.responseText}},t=jet.namespace("IO");if(!t.jsonpCallbacks)t.jsonpCallbacks=[];var q=function(c,a,b){b=b||{};if(k.XSLTProcessor)q=function(d,e,f){var h=new window.XSLTProcessor,j;h.importStylesheet(e);for(j in f)f.hasOwnProperty(j)&&
h.setParameter(null,j,f[j]);return g(h.transformToFragment(d,g.context))};else if(k.ActiveXObject)q=function(d,e,f){var h=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),j;h.stylesheet=e;e=h.createProcessor();e.input=d;for(j in f)f.hasOwnProperty(j)&&e.addParameter(j,f[j]);e.transform();return g(e.output)};return q(c,a,b)};g.extend(o,g.Promise,{abort:function(){this._request&&this._request.abort&&this._request.abort();return this.reject()}},{addMethod:function(c,a){o.prototype[c]=function(b,d){var e=
!l.isObject(d)||l.isFunction(d)?{}:d,f=e.on||(e.on={}),h=f.success,j=f.failure;if(l.isFunction(d))h=d;return this.defer(function(i){f.success=g.bind(i.resolve,i);f.failure=g.bind(i.reject,i);this._request=a(b,e)}).then(h,j)}}});g.Request=o;var y={ajax:function(c,a){var b=s(),d=a.success,e=null,f=a.dataType,h=a.timeout||1E4,j=a.method||"GET",i=a.async||true,x=a.complete||function(){},A=function(){d&&d.apply(g,arguments);x.apply(g,arguments)},n=function(B,C,D){a.failure&&a.failure(B,C,D);x.apply(g,
arguments)};if(b){if(f&&(f==="xml"||f==="xsl")&&b.overrideMimeType)b.overrideMimeType("text/xml");if(c){if(c.substr(c.length-1)!="?")c+="?";if(a.data)c+=v(a.data);if(i===true)b.onreadystatechange=function(){if(b.readyState===4)if(b.status===404)n("File not found",b.status,b);else if(b.status===408)n("timeout",b.status,b);else b.status===200||b.responseText||b.responseXML?A(w(b,f,n),b):n("Bad status",b.status,b)};try{b.open(j,c,i);b.send(null)}catch(E){n("Bad status",404,b)}if(i===false)e=w(b,f,n);
else setTimeout(function(){if(b.readyState!==4){b.abort();n("timeout",408,b)}},h)}}return e||g},jsonp:function(c,a){a=a||{};var b=a.jsonCallbackParam||"p",d=t.jsonpCallbacks,e=d.length,f=false;if(c){d[e]=function(h){f=true;a.success&&a.success(h);a.complete&&a.complete(h)};if(c.substr(c.length-1)!="?")c+="?";if(!a.data)a.data={};a.data[b]="jet.IO.jsonpCallbacks["+e+"]";setTimeout(function(){g.Get.script(c+v(a.data))},0);setTimeout(function(){if(!f){var h={message:"Request failed",reason:"Timeout"};
a.failure&&a.failure(h);a.complete&&a.complete(h)}},a.timeout||1E4)}},xslt:function(c,a,b){var d=b.params,e,f,h=function(i){b.failure&&b.failure(i);b.complete&&b.complete(i)},j=function(){if(e&&f){var i=q(e,f,d);b.success&&b.success(i);b.complete&&b.complete(i)}};if(l.isString(c)||l.isString(a)){if(l.isString(c))g.ajax({url:c,dataType:"xml",success:function(i){e=i;j()},error:h});else e=c;if(l.isString(a))g.ajax({url:a,dataType:"xsl",success:function(i){f=i;j()},error:h});else f=a}else{f=e=c;j()}}};
r.each(y,o.addMethod);r.each(y,function(c){g[c]=function(){var a=new g.Request;return a[c].apply(a,arguments)}})});
