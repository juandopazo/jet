/**
 * @module io
 * @requires deferred
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(h){function n(c){n.superclass.constructor.apply(this,arguments);this.resolved=!c}var k=h.win,o=h.Lang,y=h.Hash,t=!!k.ActiveXObject,z=!!k.XMLHttpRequest,l=function(c){return new k.ActiveXObject(c)},u=function(c){var b=[];y.each(c,function(a,d){b.push(a+"="+d)});return b.join("&")},p=function(c){var b;try{b=l("Msxml2.DOMDocument.6.0");p=function(e){return e=="xsl"?l("Msxml2.FreeThreadedDOMDocument.6.0"):l("Msxml2.DOMDocument.6.0")}}catch(a){try{b=l("Msxml2.DOMDocument.3.0");p=
function(e){return e=="xsl"?l("Msxml2.FreeThreadedDOMDocument.3.0"):l("Msxml2.DOMDocument.3.0")}}catch(d){}}return p(c)},r=function(){var c=location.host;r=t&&(!z||location.protocol=="file:"||c=="localhost"||c=="127.0.0.1")?function(){return l("Microsoft.XMLHTTP")}:function(){return new XMLHttpRequest};return r()},v=function(c,b,a){b=b||c.getResponseHeader("Content-type");switch(b){case "application/xml":case "xml":case "xsl":var d=null;if(c.responseXML)d=c.responseXML;else if(k.DOMParser){d=new k.DOMParser;
d=d.parseFromString(c.responseText||c,"text/xml")}else if(t){d=p(b);d.async=false;d.loadXML(c.responseText||c);d.parseError.errorCode!==0&&a("Bad status",d.parseError)}else a(0,{reason:"Can't find a suitable XML parser",srcText:c});return d;case "json":try{return h.JSON.parse(c.responseText)}catch(e){h.error(e)}break;default:return c.responseText}},s=jet.namespace("IO");if(!s.jsonpCallbacks)s.jsonpCallbacks=[];var q=function(c,b,a){a=a||{};if(k.XSLTProcessor)q=function(d,e,f){var g=new window.XSLTProcessor,
i;g.importStylesheet(e);for(i in f)f.hasOwnProperty(i)&&g.setParameter(null,i,f[i]);return h(g.transformToFragment(d,h.context))};else if(k.ActiveXObject)q=function(d,e,f){var g=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),i;g.stylesheet=e;e=g.createProcessor();e.input=d;for(i in f)f.hasOwnProperty(i)&&e.addParameter(i,f[i]);e.transform();return h(e.output)};return q(c,b,a)};h.Transaction=h.extend(n,Promise,{abort:function(){this._request&&this._request.abort&&this._request.abort();this.reject()}},
{addMethod:function(c,b){n.prototype[c]=function(){var a=SLICE.call(arguments),d=a.length>1?a.pop():{},e,f;d=d||{};e=d.success;f=d.failure;return this.defer(function(g){d.success=h.bind(g.resolve,g);d.failure=h.bind(g.reject,g);this._request=b.apply(this,a.concat([d]))}).then(e,f)}}});var x={ajax:function(c,b){var a=r(),d=b.success,e=null,f=b.dataType,g=b.timeout||1E4,i=b.method||"GET",j=b.async||true,w=b.complete||function(){},A=function(){d&&d.apply(h,arguments);w.apply(h,arguments)},m=function(B,
C,D){b.failure&&b.failure(B,C,D);w.apply(h,arguments)};if(a){if(f&&(f==="xml"||f==="xsl")&&a.overrideMimeType)a.overrideMimeType("text/xml");if(c){if(c.substr(c.length-1)!="?")c+="?";if(b.data)c+=u(b.data);if(j===true)a.onreadystatechange=function(){if(a.readyState===4)if(a.status===404)m("File not found",a.status,a);else if(a.status===408)m("timeout",a.status,a);else a.status===200||a.responseText||a.responseXML?A(v(a,f,m),a):m("Bad status",a.status,a)};try{a.open(i,c,j);a.send(null)}catch(E){m("Bad status",
404,a)}if(j===false)e=v(a,f,m);else setTimeout(function(){if(a.readyState!==4){a.abort();m("timeout",408,a)}},g)}}return e||h},jsonp:function(c,b){b=b||{};var a=b.jsonCallbackParam||"p",d=s.jsonpCallbacks,e=d.length,f=false;if(c){d[e]=function(g){f=true;b.success&&b.success(g);b.complete&&b.complete(g)};if(c.substr(c.length-1)!="?")c+="?";if(!b.data)b.data={};b.data[a]="jet.IO.jsonpCallbacks["+e+"]";setTimeout(function(){h.Get.script(c+u(b.data))},0);setTimeout(function(){if(!f){var g={message:"Request failed",
reason:"Timeout"};b.failure&&b.failure(g);b.complete&&b.complete(g)}},b.timeout||1E4)}},xslt:function(c,b,a){var d=a.params,e,f,g=function(j){a.failure&&a.failure(j);a.complete&&a.complete(j)},i=function(){if(e&&f){var j=q(e,f,d);a.success&&a.success(j);a.complete&&a.complete(j)}};if(o.isString(c)||o.isString(b)){if(o.isString(c))h.ajax({url:c,dataType:"xml",success:function(j){e=j;i()},error:g});else e=c;if(o.isString(b))h.ajax({url:b,dataType:"xsl",success:function(j){f=j;i()},error:g});else f=
b}else{f=e=c;i()}}};$Object.each(x,n.addMethod);$Object.each(x,function(c){h[c]=function(){var b=new h.Transaction(true);return b[c].apply(b,arguments)}})});
