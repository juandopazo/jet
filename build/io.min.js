/**
 * @module io
 * @requires deferred
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(g){function n(){n.superclass.constructor.apply(this,arguments);this.resolved=true}var k=g.win,o=g.Lang,t=g.Hash,u=!!k.ActiveXObject,y=!!k.XMLHttpRequest,l=function(c){return new k.ActiveXObject(c)},v=function(c){var b=[];t.each(c,function(a,d){b.push(a+"="+d)});return b.join("&")},p=function(c){var b;try{b=l("Msxml2.DOMDocument.6.0");p=function(e){return e=="xsl"?l("Msxml2.FreeThreadedDOMDocument.6.0"):l("Msxml2.DOMDocument.6.0")}}catch(a){try{b=l("Msxml2.DOMDocument.3.0");p=
function(e){return e=="xsl"?l("Msxml2.FreeThreadedDOMDocument.3.0"):l("Msxml2.DOMDocument.3.0")}}catch(d){}}return p(c)},r=function(){var c=location.host;r=u&&(!y||location.protocol=="file:"||c=="localhost"||c=="127.0.0.1")?function(){return l("Microsoft.XMLHTTP")}:function(){return new XMLHttpRequest};return r()},w=function(c,b,a){b=b||c.getResponseHeader("Content-type");switch(b){case "application/xml":case "xml":case "xsl":var d=null;if(c.responseXML)d=c.responseXML;else if(k.DOMParser){d=new k.DOMParser;
d=d.parseFromString(c.responseText||c,"text/xml")}else if(u){d=p(b);d.async=false;d.loadXML(c.responseText||c);d.parseError.errorCode!==0&&a("Bad status",d.parseError)}else a(0,{reason:"Can't find a suitable XML parser",srcText:c});return d;case "json":try{return g.JSON.parse(c.responseText)}catch(e){g.error(e)}break;default:return c.responseText}},s=jet.namespace("IO");if(!s.jsonpCallbacks)s.jsonpCallbacks=[];var q=function(c,b,a){a=a||{};if(k.XSLTProcessor)q=function(d,e,f){var h=new window.XSLTProcessor,
i;h.importStylesheet(e);for(i in f)f.hasOwnProperty(i)&&h.setParameter(null,i,f[i]);return g(h.transformToFragment(d,g.context))};else if(k.ActiveXObject)q=function(d,e,f){var h=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),i;h.stylesheet=e;e=h.createProcessor();e.input=d;for(i in f)f.hasOwnProperty(i)&&e.addParameter(i,f[i]);e.transform();return g(e.output)};return q(c,b,a)};g.IO=g.extend(n,Promise,{abort:function(){this.reject()}},{addMethod:function(c,b){n.prototype[c]=function(a,d){var e=
d.success,f=d.failure;return this.defer(function(h){d.success=g.bind(h.resolve,h);d.failure=g.bind(h.reject,h);b(a,opts)}).then(e,f)}}});t.each({ajax:function(c,b){var a=r(),d=b.success,e=null,f=b.dataType,h=b.timeout||1E4,i=b.method||"GET",j=b.async||true,x=b.complete||function(){},z=function(){d&&d.apply(g,arguments);x.apply(g,arguments)},m=function(A,B,C){b.failure&&b.failure(A,B,C);x.apply(g,arguments)};if(a){if(f&&(f==="xml"||f==="xsl")&&a.overrideMimeType)a.overrideMimeType("text/xml");if(c){if(c.substr(c.length-
1)!="?")c+="?";if(b.data)c+=v(b.data);if(j===true)a.onreadystatechange=function(){if(a.readyState===4)if(a.status===404)m("File not found",a.status,a);else if(a.status===408)m("timeout",a.status,a);else a.status===200||a.responseText||a.responseXML?z(w(a,f,m),a):m("Bad status",a.status,a)};try{a.open(i,c,j);a.send(null)}catch(D){m("Bad status",404,a)}if(j===false)e=w(a,f,m);else setTimeout(function(){if(a.readyState!==4){a.abort();m("timeout",408,a)}},h)}}return e||g},jsonp:function(c,b){b=b||{};
var a=b.jsonCallbackParam||"p",d=s.jsonpCallbacks,e=d.length,f=false;if(c){d[e]=function(h){f=true;b.success&&b.success(h);b.complete&&b.complete(h)};if(c.substr(c.length-1)!="?")c+="?";if(!b.data)b.data={};b.data[a]="jet.IO.jsonpCallbacks["+e+"]";setTimeout(function(){g.Get.script(c+v(b.data))},0);setTimeout(function(){if(!f){var h={message:"Request failed",reason:"Timeout"};b.failure&&b.failure(h);b.complete&&b.complete(h)}},b.timeout||1E4)}},xslt:function(c,b,a){var d=a.params,e,f,h=function(j){a.failure&&
a.failure(j);a.complete&&a.complete(j)},i=function(){if(e&&f){var j=q(e,f,d);a.success&&a.success(j);a.complete&&a.complete(j)}};if(o.isString(c)||o.isString(b)){if(o.isString(c))g.ajax({url:c,dataType:"xml",success:function(j){e=j;i()},error:h});else e=c;if(o.isString(b))g.ajax({url:b,dataType:"xsl",success:function(j){f=j;i()},error:h});else f=b}else{f=e=c;i()}}},n.addMethod);g.Array.forEach(["ajax","jsonp","xslt"],function(c){g[c]=function(b,a){return(new g.IO)[c](b,a)}})});
