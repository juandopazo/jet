/**
 * @module io
 * @requires deferred
 * 
 * Copyright (c) 2012, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("io",function(h){function o(){o.superclass.constructor.apply(this,arguments)}var k=h.config.win,l=h.Lang,s=h.Object,v=!!k.ActiveXObject,B=!!k.XMLHttpRequest,m=function(c){return new k.ActiveXObject(c)},w=function(c){var b=[];s.each(c,function(d,a){b.push(d+"="+a)});return b.join("&")},p=function(c){var b;try{b=m("Msxml2.DOMDocument.6.0");p=function(e){return e=="xsl"?m("Msxml2.FreeThreadedDOMDocument.6.0"):m("Msxml2.DOMDocument.6.0")}}catch(d){try{b=m("Msxml2.DOMDocument.3.0");p=function(e){return e==
"xsl"?m("Msxml2.FreeThreadedDOMDocument.3.0"):m("Msxml2.DOMDocument.3.0")}}catch(a){}}return p(c)},t=function(){var c=location.host;t=v&&(!B||location.protocol=="file:"||c=="localhost"||c=="127.0.0.1")?function(){return m("Microsoft.XMLHTTP")}:function(){return new XMLHttpRequest};return t()},x=function(c,b,d){b=b||c.getResponseHeader("Content-type");switch(b){case "application/xml":case "xml":case "xsl":var a=null;if(c.responseXML)a=c.responseXML;else if(k.DOMParser){a=new k.DOMParser;a=a.parseFromString(c.responseText||
c,"text/xml")}else if(v){a=p(b);a.async=false;a.loadXML(c.responseText||c);a.parseError.errorCode!==0&&d("Bad status",a.parseError)}else d(0,{reason:"Can't find a suitable XML parser",srcText:c});return a;case "json":try{return h.JSON.parse(c.responseText)}catch(e){h.error(e)}break;default:return c.responseText}},u=jet.namespace("IO");if(!u.jsonpCallbacks)u.jsonpCallbacks=[];var q=function(c,b,d){d=d||{};if(k.XSLTProcessor)q=function(a,e,f){var g=new window.XSLTProcessor,j;g.importStylesheet(e);for(j in f)f.hasOwnProperty(j)&&
g.setParameter(null,j,f[j]);return h(g.transformToFragment(a,h.config.doc))};else if(k.ActiveXObject)q=function(a,e,f){var g=new window.ActiveXObject("Msxml2.XSLTemplate.6.0"),j;g.stylesheet=e;e=g.createProcessor();e.input=a;for(j in f)f.hasOwnProperty(j)&&e.addParameter(j,f[j]);e.transform();return h(e.output)};return q(c,b,d)};h.extend(o,h.Promise,{abort:function(){this._request&&this._request.abort&&this._request.abort();return this.reject()}},{addMethod:function(c,b){o.prototype[c]=function(d,
a){var e=!l.isObject(a)||l.isFunction(a)?{}:a,f=e.on||(e.on={}),g=f.success,j=f.failure;if(l.isFunction(a))g=a;return this.defer(function(i){f.success=h.bind(i.resolve,i);f.failure=h.bind(i.reject,i);this._request=b(d,e)}).then(g,j)}}});h.Request=o;var A={ajax:function(c,b){var d=this,a=t(),e=null,f=b.dataType,g=b.timeout||1E4,j=b.method||"GET",i=b.async||true,r=b.on||{},y=r.complete||function(){},z=r.success,C=function(){z&&z.apply(d,arguments);y.apply(d,arguments)},n=function(D,E,F){r.failure&&
r.failure(D,E,F);y.apply(d,arguments)};if(a){if(f&&(f==="xml"||f==="xsl")&&a.overrideMimeType)a.overrideMimeType("text/xml");if(c){if(c.substr(c.length-1)!="?")c+="?";if(b.data)c+=w(b.data);if(i===true)a.onreadystatechange=function(){if(a.readyState===4)if(a.status===404)n("File not found",a.status,a);else if(a.status===408)n("timeout",a.status,a);else a.status===200||a.responseText||a.responseXML?C(x(a,f,n),a):n("Bad status",a.status,a)};try{a.open(j,c,i);a.send(null)}catch(G){n("Bad status",404,
a)}if(i===false)e=x(a,f,n);else setTimeout(function(){if(a.readyState!==4){a.abort();n("timeout",408,a)}},g)}}return e||h},jsonp:function(c,b){b=b||{};var d=b.jsonCallbackParam||"p",a=u.jsonpCallbacks,e=a.length,f=false;if(c){a[e]=function(g){f=true;b.success&&b.success(g);b.complete&&b.complete(g)};if(c.substr(c.length-1)!="?")c+="?";if(!b.data)b.data={};b.data[d]="jet.IO.jsonpCallbacks["+e+"]";setTimeout(function(){h.Get.script(c+w(b.data))},0);setTimeout(function(){if(!f){var g={message:"Request failed",
reason:"Timeout"};b.failure&&b.failure(g);b.complete&&b.complete(g)}},b.timeout||1E4)}},xslt:function(c,b,d){var a=d.params,e,f,g=function(i){d.failure&&d.failure(i);d.complete&&d.complete(i)},j=function(){if(e&&f){var i=q(e,f,a);d.success&&d.success(i);d.complete&&d.complete(i)}};if(l.isString(c)||l.isString(b)){if(l.isString(c))h.ajax({url:c,dataType:"xml",success:function(i){e=i;j()},error:g});else e=c;if(l.isString(b))h.ajax({url:b,dataType:"xsl",success:function(i){f=i;j()},error:g});else f=
b}else{f=e=c;j()}}};s.each(A,o.addMethod);s.each(A,function(c,b){h[c]=function(){var d=new h.Request;b.apply(d,arguments);return d}})});
