/**
 * @module widget-sandbox
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("widget-sandbox",function(c){function j(){this.frame=new c.Frame({linkedcss:this.get("extraCss")})}var h=c.Array,n=c.Hash,o=function(a,b){n.each(b,function(d,e){a=a.replace(new RegExp("{"+d+"}","g"),e)});return a},f=c.Frame=c.Base.create("frame",c.Base,[],{DEFAULT_CSS:"body { margin: 0; padding: 0; border: none; }",HTML:'<iframe border="0" frameBorder="0" marginWidth="0" marginHeight="0" leftMargin="0" topMargin="0" width="100%" height="100%"></iframe>',PAGE_HTML:'<html dir="{DIR}" lang="{LANG}"><head><title>{TITLE}</title>{META}{LINKED_CSS}<style id="editor_css">{DEFAULT_CSS}</style>{EXTRA_CSS}</head><body>{CONTENT}</body></html>',
getDocType:function(){var a=c.config.doc.doctype,b=f.DOC_TYPE;if(a)b="<!DOCTYPE "+a.name+(a.publicId?" "+a.publicId:"")+(a.systemId?" "+a.systemId:"")+">";else if(c.config.doc.all){a=c.config.doc.all[0];if(a.nodeType)if(a.nodeType===8)if(a.nodeValue)if(a.nodeValue.toLowerCase().indexOf("doctype")!==-1)b="<!"+a.nodeValue+">"}return b},DOC_TYPE:'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">',META:'<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>',
ATTRS:{title:{value:"Blank Page"},dir:{value:"ltr"},lang:{value:"en-US"},src:{value:"javascript"+(c.UA.ie?":false":":")+";"},content:{value:"",setter:"_setHTML",getter:"_getHTML"},use:{writeOnce:true,value:[]},container:{value:"body",setter:function(a){return c(a).item(0)}},node:{readOnly:true,value:null,getter:function(){return this._iframe}},id:{writeOnce:true,getter:function(a){a||(a="iframe-"+ ++jet.Widget._uid);return a}},linkedcss:{value:"",getter:"_getLinkedCSS",setter:"_setLinkedCSS"},extracss:{value:"",
setter:"_setExtraCSS"},rendered:{value:false}}},{_ready:null,_iframe:null,_instance:null,_create:function(a){var b;this._iframe=c("<div/>").html(f.HTML).first();this._iframe.css("visibility","hidden");this._iframe.attr("src",this.get("src"));this.get("container").append(this._iframe);this._iframe.css("height","100%");var d="";d=this.get("extracss")?'<style id="extra_css">'+this.get("extracss")+"</style>":"";d=o(f.PAGE_HTML,{DIR:this.get("dir"),LANG:this.get("lang"),TITLE:this.get("title"),META:f.META,
LINKED_CSS:this.get("linkedcss"),CONTENT:this.get("content"),DEFAULT_CSS:f.DEFAULT_CSS,EXTRA_CSS:d});if(c.config.doc.compatMode!="BackCompat")d=f.getDocType()+"\n"+d;b=this._resolveWinDoc();b.doc.open();b.doc.write(d);b.doc.close();if(b.doc.documentElement)a(b);else var e=setInterval(function(){if(b.doc&&b.doc.documentElement){a(b);clearInterval(e)}},1)},_resolveWinDoc:function(a){a=a?a:{};a.win=this._iframe._nodes[0].contentWindow;a.doc=this._iframe._nodes[0].contentWindow.document;if(!a.doc)a.doc=
c.config.doc;if(!a.win)a.win=c.config.win;return a},initializer:function(){},destructor:function(){var a=this.getInstance();a(a.config.doc).unbind();this._iframe.remove(true)},_onContentReady:function(a){if(!this._ready){this._ready=true;this._iframe.css("visibility","");var b=this.getInstance(),d=this.get("use");this.fire("contentReady");if(a)b.config.doc=a.target._nodes[0]||a.target;b.use.apply(b,d);b(b.config.doc.documentElement).addClass("jet-js-enabled")}},_getHTML:function(a){if(this._ready)a=
this.getInstance()("body").html();return a},_setHTML:function(a){this._ready?this.getInstance()("body").html(a):this.on("contentReady",c.bind(function(b){this.getInstance()("body").html(b)},this,a));return a},_getLinkedCSS:function(a){c.Lang.isArray(a)||(a=[a]);var b="";if(this._ready)b=a;else h.each(a,function(d){if(d!=="")b+='<link rel="stylesheet" href="'+d+'" type="text/css">'});return b},_setLinkedCSS:function(a){this._ready&&this.getInstance().Get.css(a);return a},_setExtraCSS:function(a){if(this._ready){var b=
this.getInstance();b.get("#extra_css").remove();b.one("head").append(c("<style/>").attr("id","extra_css").html(a))}return a},_instanceLoaded:function(a){this._instance=a;this._onContentReady()},getInstance:function(){return this._instance},render:function(a){if(this.get("rendered"))return this;this.set("rendered",true);a&&this.set("container",a);this._create(c.bind(function(b){var d,e,k=c.bind(function(g){g.config.win.jet_Config=g.config;g.config.win.jet=jet;this._instanceLoaded(g)},this),l=this.get("use"),
i={win:b.win,doc:b.doc},m=c.bind(function(){i=this._resolveWinDoc(i);d=jet(i);try{d.use("node",k);e&&clearInterval(e)}catch(g){e=setInterval(function(){m()},350)}},this);l.push(m);c.use.apply(c,l)},this));return this}});h=c.Array;c.WidgetSandbox=c.mix(j,{ATTRS:{extraScripts:{writeOnce:true,value:[]},extraCss:{writeOnce:true,value:[]}},EVENTS:{afterRender:function(){var a=this.frame;a.on("contentReady",this._onFrameReady,this);a.render(this.get("boundingBox"))}}});j.prototype={getInstance:function(){return this.frame.getInstance()},
_onFrameReady:function(){var a=this.frame.getInstance(),b=a.config.doc,d=b.body,e=this.get("contentBox");try{e.appendTo(d)}catch(k){b=b.importNode(e._nodes[0],true);d.appendChild(b);this.set("contentBox",b);e.remove()}h.each(this.get("extraScripts"),a.Get.script,a.Get);this.fire("ready")}}});
