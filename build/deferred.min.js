/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(f){function k(a){this._config=a=a||{};this._done=[];this._fail=[];this.rejected=this.resolved=false}var l=f.Lang,g=f.Array,i=Array.prototype,j=i.slice,m=i.push;g.spread=function(a){a=!a?[]:a.length?j.call(a):[a];for(var b=0;b<a.length;)if(l.isArray(a[b]))i.splice.apply(a,[b,1].concat(a[b]));else if(l.isValue(a[b]))b++;else a.splice(b,1);return a};k.prototype={then:function(a,b){a=g.spread(a);b=g.spread(b);var c=this.resolved,d=this.rejected;if(c)this._notify(a,this._args||
[],this);else d||m.apply(this._done,a);if(d)this._notify(b,this._args||[],this);else c||m.apply(this._fail,b);return this},done:function(){return this.then(arguments)},fail:function(){return this.then(null,arguments)},always:function(){return this.then(arguments,arguments)},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){this.resolved=true;this._args=b;return this._notify(this._done,b,a)},rejectWith:function(a,
b){this.rejected=true;this._args=b;return this.notify(this._fail,b,a)},_notify:function(a,b,c){for(var d=a.length,e=0;e<d;e++)a[e].apply(c,b);return this},defer:function(a,b){var c=new this.constructor(this._config,true);this.then(f.bind(a,b||this,c));return c}};f.defer=function(a,b){var c=new k;a.call(b,c);return c};f.when=function(){var a=g.spread(arguments),b=[],c=0,d=0,e=0;return f.defer(function(h){function n(){e>0?h.rejectWith(h,b):h.resolveWith(h,b)}function o(){b.push(j.call(arguments));d++;
d+e==a.length&&n()}function p(){b.push(j.call(arguments));e++;d+e==a.length&&n()}for(;c<a.length;){a[c].then(o,p);c++}})}});
