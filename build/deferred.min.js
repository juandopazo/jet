/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(e){function i(){this._done=[];this._fail=[];this.rejected=this.resolved=false}function k(){this._fail=[]}var l=e.Lang,h=e.Array,m=Array.prototype,f=m.slice,n=m.push;h._spread=function(a){a=l.isArray(a)?a:[a];for(var b=0;b<a.length;)if(l.isArray(a[b]))m.splice.apply(a,[b,1].concat(a[b]));else if(l.isValue(a[b]))b++;else a.splice(b,1);return a};i.prototype={then:function(a,b){a=h._spread(a);b=h._spread(b);if(this.resolved)this._notify(a,this._args||[],this);else this.rejected||
n.apply(this._done,a);if(this.rejected)this._notify(b,this._args||[],this);else this.resolved||n.apply(this._fail,b);return this},done:function(){return this.then(f.call(arguments))},fail:function(){return this.then(null,f.call(arguments))},always:function(){var a=f.call(arguments);return this.then(a,a)},resolve:function(){return this.resolveWith(this,f.call(arguments))},reject:function(){return this.rejectWith(this,f.call(arguments))},resolveWith:function(a,b){this.resolved=true;this._args=b;return this._notify(this._done,
b,a)},rejectWith:function(a,b){this.rejected=true;this._args=b;return this._notify(this._fail,b,a)},_notify:function(a,b,c){for(var d=0,g=a.length;d<g;d++)a[d].apply(c,b);return this},defer:function(a,b){var c=new this.constructor;this.then(e.bind(a,b||this,c));return c}};e.Promise=i;k.prototype={then:function(a,b){var c=this._next;if(a||b){a=YArray._spread(a);if(c){YArray.each(a,function(d,g){if(d.end)a[g]=function(){d.end()}});c.then(a,b)}else{a=YArray.filter(a,function(d){return!d.end});this._notify(a)}}return this},
_switchPromise:function(a){this._current=a},defer:function(a,b){b=b||this;var c=new i,d=e.bind(this._switchPromise,this,c);if(a){a=e.bind(a,b,c);c.fail(e.bind(this._notifyFailure,this));if(this._next)this._next.then([a,d],d);else{this._starter=a;this._current=c}}this._next=c;return this},end:function(a,b){this.then(a);this._fail.push.apply(this._fail,YArray._spread(b));this._starter&&this._starter();return this},resolveWith:function(a,b){var c=this._current;c&&c.resolve.apply(a,b);return this},rejectWith:function(a,
b){var c=this._current;c&&c.reject.apply(a,b);return this},isResolved:function(){return this._current.isResolved()},isRejected:function(){return this._current.isRejected()},_notifyFailure:function(){var a=arguments;YArray.each(this._fail,function(b){b.apply(this,a)},this);return this}};h.each(["done","fail","always","resolve","reject","_notify"],function(a){k.prototype[a]=i.prototype[a]});e.Deferred=k;e.defer=function(a,b){return(new e.Deferred).defer(a,b)};e.when=function(){var a=h._spread(f.call(arguments)),
b=[],c=0,d=0,g=0;return e.defer(function(j){function o(){g>0?j.rejectWith(j,b):j.resolveWith(j,b)}function p(){b.push(f.call(arguments));d++;d+g==a.length&&o()}function q(){b.push(f.call(arguments));g++;d+g==a.length&&o()}for(;c<a.length;){a[c].end(p,q);c++}})}});
