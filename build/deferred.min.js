/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(e){function i(a){this._config=a||{};this._done=[];this._fail=[];this._args=[];this.status=0}var j=e.Lang,c=e.Array,k=Array.prototype,l=k.push;c.flatten=function(a){var b=0;for(a=j.isArray(a)?a.concat():[a];b<a.length;)if(j.isArray(a[b]))k.splice.apply(a,[b,1].concat(a[b]));else b++;return a};e.mix(i.prototype,{then:function(a,b){if(a){a=c.flatten(a);this.status===1?c.each(a,function(d){d.apply(this,this._args)},this):l.apply(this._done,a)}if(b){b=c.flatten(b);this.status===
2?c.each(b,function(d){d.apply(this,this._args)},this):l.apply(this._fail,b)}return this},done:function(){return this.then(c(arguments))},fail:function(){return this.then(null,c(arguments))},always:function(){var a=c(arguments);return this.then(a,a)},resolve:function(){this.status=1;return this._notify(c(arguments))},reject:function(){this.status=2;return this._notify(c(arguments))},_notify:function(a){var b=[],d=this;if(this.status===1){b=this._done;this._done=[]}else if(this.status===2){b=this._fail;
this._fail=[]}c.each(b,function(f){f.apply(d,a)});return this},defer:function(a,b){var d=new this.constructor(this._config);this.then(e.bind(a,b||this,d));return d}});e.Promise=i;e.defer=function(a){var b=new e.Promise;a.call(e,b);return b};e.when=function(){var a=c.flatten(SLICE.call(arguments)),b=[],d=0,f=0,g=0;return e.defer(function(h){function m(){g>0?h.rejectWith(h,b):h.resolveWith(h,b)}function n(){b.push(SLICE.call(arguments));f++;f+g==a.length&&m()}function o(){b.push(SLICE.call(arguments));
g++;f+g==a.length&&m()}for(;d<a.length;){a[d].end(n,o);d++}})}});
