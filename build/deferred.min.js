/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function h(a,b){this._done=this._spread(a);this._fail=this._spread(b)}function i(){}var j=d.Lang,l=Array.prototype,e=l.slice,k=l.push;h.prototype={_spread:function(a){a=j.isArray(a)?a:[a];for(var b=0;b<a.length;)if(j.isArray(a[b])){k.apply(a,a[b]);a.splice(b,1)}else if(j.isValue(a[b]))b++;else a.splice(b,1);return a},then:function(a,b){k.apply(this._done,this._spread(a));k.apply(this._fail,this._spread(b));return this},done:function(){return this.then(e.call(arguments))},
fail:function(){return this.then(null,e.call(arguments))},resolve:function(){return this._notify(this._done,e.call(arguments))},reject:function(){return this._notify(this._fail,e.call(arguments))},resolveWith:function(a){return this._notify(this._done,e.call(arguments,1),a)},rejectWith:function(a){return this._notify(this._fail,e.call(arguments,1),a)},_notify:function(a,b,c){for(var f=0,g=a.length;f<g;f++)a[f].apply(c||this,b);return this}};i.prototype={then:function(a,b){this._promise?this._promise.then(a,
b):this._notify(a);return this},done:h.prototype.done,fail:h.prototype.fail,promise:function(a){function b(){f._currPromise=c}var c=new h,f=this;if(this._promise)this._promise.then([d.bind(a,c,c),b],b);else{a.call(c,c);this._currPromise=c}this._promise=c;return this},resolve:function(){var a=this._currPromise;a&&a.resolve.apply(a,arguments)},reject:function(){var a=this._currPromise;a&&a.reject.apply(a,arguments)},_notify:h.prototype._notify};d.Deferred=i;d.when=function(){var a=e.call(arguments),
b=[],c=0,f=0,g=0;return(new i).promise(function(m){function n(){g>0?m.reject(b):m.resolve(b)}function p(){b.push(e.call(arguments));f++;f+g==a.length&&n()}function q(){b.push(e.call(arguments));g++;f+g==a.length&&n()}for(;c<a.length;){a[c].then(p,q);c++}})};if(d.ajax){var r=d.ajax,o=function(a){this.promise(function(b){a.success=d.bind(b.resolve,b);a.failure=d.bind(b.reject,b);r(a)})};d.extend(o,i,{abort:function(){this.reject()}});d.ajax=function(a){a=a||{};var b=a.success,c=a.failure;a=new o(a);
a.then(b,c);return a}}});
