/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function m(a,b){this._done=f.spread(a);this._fail=f.spread(b);this._rejected=this._resolved=false}function j(){}var n=d.Lang,f=d.Array,k=Array.prototype,l=k.slice,o=k.push,i;f.spread=function(a){a=!a?[]:a.length?l.call(a):[a];for(var b=0;b<a.length;)if(n.isArray(a[b]))k.splice.apply(a,[b,1].concat(a[b]));else if(n.isValue(a[b]))b++;else a.splice(b,1);return a};i=m.prototype={then:function(a,b){o.apply(this._done,f.spread(a));o.apply(this._fail,f.spread(b));return this},
done:function(){return this.then(arguments)},fail:function(){return this.then(null,arguments)},always:function(){return this.then(arguments,arguments)},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){return this.notify(true,b,a)},rejectWith:function(a,b){return this.notify(false,b,a)},notify:function(a,b,c){if(!this._resolved&&!this._rejected){var g=a?this._done:this._fail,h=g.length,e=0;for(this[a?"_resolved":
"_rejected"]=true;e<h;e++)g[e].apply(c,b)}return this},isResolved:function(){return this._resolved},isRejected:function(){return this._rejected}};j.prototype={then:function(a,b){if(a||b)this._promise?this._promise.then(a,b):this._notify(a);return this},done:i.done,fail:i.fail,always:i.always,promise:function(a){var b=new m,c=d.bind(function(){this._currPromise=b},this);if(a)if(this._promise)this._promise.then([d.bind(a,b,this),c],c);else{a.call(b,b);this._currPromise=b}this._promise=b;return this},
resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){var c=this._currPromise;c&&c.resolve.apply(a,b);return this},rejectWith:function(a,b){var c=this._currPromise;c&&c.reject.apply(a,b);return this},_notify:i.notify,isResolved:function(){return this._currPromise.isResolved()},isRejected:function(){return this._currPromise.isRejected()}};d.Deferred=j;d.defer=function(a){return(new j).promise(a)};d.when=function(){var a=
f.spread(arguments),b=[],c=0,g=0,h=0;return d.defer(function(e){function p(){h>0?e.reject.apply(e,b):e.resolve.apply(e,b)}function r(){b.push(l.call(arguments));g++;g+h==a.length&&p()}function s(){b.push(l.call(arguments));h++;g+h==a.length&&p()}for(;c<a.length;){a[c].then(r,s);c++}})};if(d.ajax){var t=d.ajax,q=function(a){this.config=a||{}};d.extend(q,j,{send:function(){var a=this.config;return this.promise(function(b){a.success=d.bind(b.resolve,b);a.failure=d.bind(b.reject,b);t(a)})},abort:function(){this.reject()}});
d.ajax=function(a){a=a||{};var b=a.success,c=a.failure;return(new q(a)).send().then(b,c)}}});
