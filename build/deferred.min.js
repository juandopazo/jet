/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function i(a,b){this._done=this._spread(a);this._fail=this._spread(b)}function j(){}var k=d.Lang,p=Array.prototype,g=p.slice,m=p.push;i.prototype={_spread:function(a){a=k.isArray(a)?a:[a];for(var b=0;b<a.length;)if(k.isArray(a[b])){m.apply(a,a[b]);a.splice(b,1)}else if(k.isValue(a[b]))b++;else a.splice(b,1);return a},then:function(a,b){m.apply(this._done,this._spread(a));m.apply(this._fail,this._spread(b));return this},done:function(){return this.then(g.call(arguments))},
fail:function(){return this.then(null,g.call(arguments))},resolve:function(){return this._notify(this._done,g.call(arguments))},reject:function(){return this._notify(this._fail,g.call(arguments))},resolveWith:function(a){return this._notify(this._done,g.call(arguments,1),a)},rejectWith:function(a){return this._notify(this._fail,g.call(arguments,1),a)},_notify:function(a,b,c){for(var e=0,f=a.length;e<f;e++)a[e].apply(c||this,b);return this}};j.prototype={then:function(a,b){this._promise?this._promise.then(a,
b):this._notify(a);return this},done:i.prototype.done,fail:i.prototype.fail,promise:function(a){function b(){e._currPromise=c}var c=new i,e=this;if(this._promise)this._promise.then([d.bind(a,c,c),b],b);else{a.call(c,c);this._currPromise=c}this._promise=c;return this},resolve:function(){var a=this._currPromise;a&&a.resolve.apply(a,arguments)},reject:function(){var a=this._currPromise;a&&a.reject.apply(a,arguments)},_notify:i.prototype._notify};d.Deferred=j;d.when=function(){function a(){l>0?n.reject(f):
n.resolve(f)}function b(){o++;o+l==e.length&&a()}function c(){l++;o+l==e.length&&a()}for(var e=g.call(arguments),f=[],h=0,o=0,l=0,n=new j;h<e.length;)if(f[h]&&k.isFunction(f[h].then)){f[h].then(b,c);h++}else f.splice(h,1);return n};if(d.ajax){var r=d.ajax,q=function(a){this.promise(function(b){a.success=d.bind(b.resolve,b);a.failure=d.bind(b.reject,b);r(a)})};d.extend(q,j,{abort:function(){this.reject()}});d.ajax=function(a){a=a||{};var b=a.success,c=a.failure;a=new q(a);a.then(b,c);return a}}});
