/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function f(a,b){this._done=this._spread(a);this._fail=this._spread(b)}function h(){}var m=d.Lang,i=d.Array,k=Array.prototype,l=k.slice,n=k.push;i.spread=function(a){a=!a?[]:a.length?l.call(a):[a];for(var b=0;b<a.length;)if(m.isArray(a[b]))k.splice.apply(a,[b,1].concat(a[b]));else if(m.isValue(a[b]))b++;else a.splice(b,1);return a};f.prototype={then:function(a,b){n.apply(this._done,i.spread(a));n.apply(this._fail,i.spread(b));return this},done:function(){return this.then(arguments)},
fail:function(){return this.then(null,arguments)},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){return this.notify(true,b,a)},rejectWith:function(a,b){return this.notify(false,b,a)},notify:function(a,b,c){a=a?this._done:this._fail;for(var g=a.length,e=0;e<g;e++)a[e].apply(c,b);return this}};h.prototype={then:function(a,b){this._promise?this._promise.then(a,b):this._notify(a);return this},done:f.prototype.done,
fail:f.prototype.fail,promise:function(a){var b=new f,c=d.bind(function(){this._currPromise=b},this);if(a)if(this._promise)this._promise.then([d.bind(a,b,this),c],c);else{a.call(b,b);this._currPromise=b}this._promise=b;return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){var c=this._currPromise;c&&c.resolve.apply(a,b);return this},rejectWith:function(a,b){var c=this._currPromise;c&&c.reject.apply(a,
b);return this},_notify:f.prototype.notify};d.Deferred=h;d.when=function(){var a=i.spread(arguments),b=[],c=0,g=0,e=0;return(new h).promise(function(j){function o(){e>0?j.reject.apply(j,b):j.resolve.apply(j,b)}function q(){b.push(l.call(arguments));g++;g+e==a.length&&o()}function r(){b.push(l.call(arguments));e++;g+e==a.length&&o()}for(;c<a.length;){a[c].then(q,r);c++}})};if(d.ajax){var s=d.ajax,p=function(a){this.config=a||{}};d.extend(p,h,{send:function(){var a=this.config;return this.promise(function(b){a.success=
d.bind(b.resolve,b);a.failure=d.bind(b.reject,b);s(a)})},abort:function(){this.reject()}});d.ajax=function(a){a=a||{};var b=a.success,c=a.failure;return(new p(a)).send().then(b,c)}}});
