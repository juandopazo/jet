/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function i(a){this._config=a=a||{};this._done=[];this._fail=[];this.rejected=this.resolved=false}function l(){}var m=d.Lang,g=d.Array,j=Array.prototype,k=j.slice,n=j.push;g.spread=function(a){a=!a?[]:a.length?k.call(a):[a];for(var b=0;b<a.length;)if(m.isArray(a[b]))j.splice.apply(a,[b,1].concat(a[b]));else if(m.isValue(a[b]))b++;else a.splice(b,1);return a};i.prototype={then:function(a,b){a=g.spread(a);b=g.spread(b);var c=this.resolved,e=this.rejected;if(c)this._notify(a,
this._args||[],this);else e||n.apply(this._done,a);if(e)this._notify(b,this._args||[],this);else c||n.apply(this._fail,b);return this},done:function(){return this.then(arguments)},fail:function(){return this.then(null,arguments)},always:function(){return this.then(arguments,arguments)},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){this.resolved=true;this._args=b;return this._notify(this._done,b,a)},rejectWith:function(a,
b){this.rejected=true;this._args=b;return this.notify(this._fail,b,a)},_notify:function(a,b,c){for(var e=a.length,f=0;f<e;f++)a[f].apply(c,b);return this},defer:function(a,b){var c=new this.constructor(this._config,true);this.then(d.bind(a,b||this,c));return c}};l.prototype={then:function(a,b){if(a||b)this._promise?this._promise.then(a,b):this._notify(a);return this},done:PROMISE_PROTO.done,fail:PROMISE_PROTO.fail,always:PROMISE_PROTO.always,promise:function(a){var b=new i,c=d.bind(function(){this._currPromise=
b},this);if(a)if(this._promise)this._promise.then([d.bind(a,b,this),c],c);else{a.call(b,b);this._currPromise=b}this._promise=b;return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},resolveWith:function(a,b){var c=this._currPromise;c&&c.resolve.apply(a,b);return this},rejectWith:function(a,b){var c=this._currPromise;c&&c.reject.apply(a,b);return this},_notify:PROMISE_PROTO.notify,isResolved:function(){return this._currPromise.isResolved()},
isRejected:function(){return this._currPromise.isRejected()}};d.Deferred=l;d.defer=function(a,b){var c=new i;a.call(b,c);return c};d.when=function(){var a=g.spread(arguments),b=[],c=0,e=0,f=0;return d.defer(function(h){function o(){f>0?h.rejectWith(h,b):h.resolveWith(h,b)}function p(){b.push(k.call(arguments));e++;e+f==a.length&&o()}function q(){b.push(k.call(arguments));f++;e+f==a.length&&o()}for(;c<a.length;){a[c].then(p,q);c++}})}});
