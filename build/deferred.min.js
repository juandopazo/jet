/**
 * @module deferred
 * @requires oop
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("deferred",function(d){function j(a){this._config=a||{};this._done=[];this._fail=[];this._args=[];this.status=0}var i=d.Lang,e=d.Array,k=Array.prototype,l=k.push;e.flatten=function(a){var b=0;for(a=i.isArray(a)?a.concat():[a];b<a.length;)if(i.isArray(a[b]))k.splice.apply(a,[b,1].concat(a[b]));else b++;return a};d.mix(j.prototype,{then:function(a,b){if(a){a=e.flatten(a);this.status===1?e.each(a,function(c){c.apply(this,this._args)},this):l.apply(this._done,a)}if(b){b=e.flatten(b);this.status===
2?e.each(b,function(c){c.apply(this,this._args)},this):l.apply(this._fail,b)}return this},done:function(){return this.then(e(arguments))},fail:function(){return this.then(null,e(arguments))},always:function(){var a=e(arguments);return this.then(a,a)},resolve:function(){this.status=1;return this._notify(e(arguments))},reject:function(){this.status=2;return this._notify(e(arguments))},_notify:function(a){var b=[],c=this;if(this.status===1){b=this._done;this._done=[]}else if(this.status===2){b=this._fail;
this._fail=[]}e.each(b,function(f){f.apply(c,a)});return this},defer:function(a,b){var c=new this.constructor(this._config);this.then(d.bind(a,b||this,c));return c}});d.Promise=j;d.defer=function(a){var b=new d.Promise;a.call(d,b);return b};d.delay=d.Promise.prototype.delay=function(a){return this.defer(function(b){setTimeout(function(){b.resolve()},a)})};d.queue=function(a,b){b=b||10;i.isArray(a)||(a=[a]);var c=this;e.forEach(a,function(f){c=c.delay(b).then(f)});return c};d.when=d.Promise.prototype.when=
function(){var a=e.flatten(SLICE.call(arguments)),b=[],c=0,f=0,g=0;return this.defer(function(h){function m(){g>0?h.rejectWith(h,b):h.resolveWith(h,b)}function n(){b.push(SLICE.call(arguments));f++;f+g==a.length&&m()}function o(){b.push(SLICE.call(arguments));g++;f+g==a.length&&m()}for(;c<a.length;){a[c].end(n,o);c++}})}});
