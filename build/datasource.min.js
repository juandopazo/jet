/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datasource",function(h){var r=h.Lang,n=h.Array;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var v=function(a){var b=jet.Record.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(e){return a[e]}};r.isRecord=function(a){return a instanceof v};var w=function(a,b,e){if(a.length<=1)return a;for(var i=[],d=[],f=a.splice(Math.round(a.length/2),1)[0],c=a.length,g=0;g<c;g++)if(e=="asc")if(a[g].get(b)<=f.get(b))i[i.length]=a[g];else d[d.length]=
a[g];else if(a[g].get(b)<=f.get(b))d[d.length]=a[g];else i[i.length]=a[g];return w(i,b,e).concat([f]).concat(w(d,b,e))},p=function(a){p.superclass.constructor.call(this);var b=[],e=false,i,d=this;n.each(a,function(c){b[b.length]=new v(c)});d.getRecords=function(){return b};d.getCount=function(){return b.length};d.sortBy=function(c,g){if(b.length>1){b=w(b,c,g);e=c;i=g}return this};var f=function(c){if(r.isRecordSet(c))c=c.getRecords();else r.isArray(c)||(c=[c]);return c};d.replace=function(c){c=f(c);
d.fire("replace",c);return e?d.sortBy(e,i):d};d.push=function(c){b=b.concat(f(c));d.fire("push",b,c);return e?d.sortBy(e,i):d};d.getRecordById=function(c){var g;n.each(b,function(t){if(t.getId()==c){g=t;return false}});return g}};h.extend(p,h.EventTarget);r.isRecordSet=function(a){return a instanceof p};var o=function(){o.superclass.constructor.apply(this,arguments);var a=new p([]),b=this.addAttrs({recordSet:{readOnly:true,getter:function(){return a}},responseType:{required:true},responseSchema:{required:true},
requestLogic:{writeOnce:true}}),e=new h.EventTarget,i=function(d){var f=b.get("responseType"),c=b.get("responseSchema"),g=[];if(f=="text"){d=d.split(c.recordDelim);n.each(d,function(l,m){d[m]=l.split(c.fieldDelim)});f="jsarray"}if(f=="jsarray"){var t=c.fields;n.each(d,function(l,m){g[m]={};n.each(t,function(k,j){g[m][k]=d[m][j]})})}else if(f=="json"){var C=true,u=d;if(c.resultList){f=c.resultList.split(".");n.each(f,function(l){if(u[l])u=u[l];else C=false})}C?n.each(u,function(l,m){g[m]={};n.each(c.fields,
function(k){var j=k.key.split("."),q=null;n.each(j,function(s){if(l[s])q=l[s]});g[m][k.key]=q})}):b.fire("parserError","Result list not found")}else if(f=="xml"){f=h.context;var x=d.documentElement;(x.nodeName==c.resultNode?h(x):h(x).find(c.resultNode).eq(0)).children().each(function(l){var m={};n.each(c.fields,function(k){var j=l.nodeName!=k.node?h(l).find(k.node)[0]:l,q;if(j){if(k.attr)j=j.getAttribute(k.attr);else if(k.children){q=[];h(j).children().each(function(s){s.firstChild&&q.push(s.firstChild.nodeValue)});
j=q}else j=j.firstChild?j.firstChild.nodeValue:"";if(k.parser)switch(k.parser.toLowerCase()){case "float":j=parseFloat(j);break;case "10":j=parseInt(j,10);break}}m[k.key]=j});g[g.length]=m});h.context=f}return new p(g)};b.sendRequest=function(d){b.get("requestLogic")(d,function(f){b.set("tempData",f);var c=f;if(e.fire("beforeParse",f))c=i(b.get("tempData"));a=c;b.fire("update",c)},function(f){b.fire("error",{message:"Request failed",reason:f})});return b};b.onBeforeParse=function(d){e.on("beforeParse",
function(f,c){b.set("tempData",d(c))});return b}};h.extend(o,h.Utility);var y=function(){y.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,e,i){h.ajax({url:a.get("url"),data:b,dataType:a.get("responseType"),success:e,error:i})});a.sendRequest(a.get("initialRequest"))};h.extend(y,o);var z=function(){z.superclass.constructor.apply(this,arguments);var a=this.addAttrs({jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true,
setter:function(b){return b.substr(b.length-1)=="?"?b:b+"?"}}});a.set("requestLogic",function(b,e,i){h.jsonp({url:a.get("url"),data:b,success:e,jsonCallbackParam:a.get("jsonCallbackParam"),error:i,timeout:a.get("timeout")})});a.sendRequest(a.get("initialRequest"))};h.extend(z,o);var A=function(){A.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,e,i){a.get("responseType");IO.flajax({url:a.get("url"),data:b,dataType:a.get("responseType"),
success:e,error:i})});a.sendRequest(a.get("initialRequest"))};h.extend(A,o);var B=function(){B.superclass.constructor.apply(this,arguments);var a=this.addAttr("localData",{required:true});a.set("requestLogic",function(b,e){var i=a.get("localData");r.isFunction(i)?e(i(b)):e(i)});a.sendRequest(a.get("initialRequest"))};h.extend(B,o);h.mix(o,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"},Ajax:y,Get:z,Local:B,XDR:A});h.add({DataSource:o,Record:v,RecordSet:p})});
