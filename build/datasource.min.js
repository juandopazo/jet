jet().add("datasource",function(h){if(!jet.DataSource)jet.DataSource={};if(!jet.DataSource.jsonpCallbacks)jet.DataSource.jsonpCallbacks=[];var v=h.Lang,A=h.Hash,m=h.Array;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var w=function(a){var b=jet.Record.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(f){return a[f]}},r=function(a,b,f){if(a.length<=1)return a;for(var e=[],c=[],d=a.splice(Math.round(a.length/2),1)[0],g=a.length,n=0;n<g;n++)if(f==
"asc")if(a[n].get(b)<=d.get(b))e[e.length]=a[n];else c[c.length]=a[n];else if(a[n].get(b)<=d.get(b))c[c.length]=a[n];else e[e.length]=a[n];return r(e,b,f).concat([d]).concat(r(c,b,f))},p=function(a){var b=[],f=false,e,c=this;m.each(a,function(d){b[b.length]=new w(d)});c.getRecords=function(){return b};c.getCount=function(){return recods.length};c.sortBy=function(d,g){if(b.length>1){b=r(b,d,g);f=d;e=g}return this};c.push=function(d){if(d instanceof p)d=d.getRecords();else lang.isArray(d)||(d=[d]);
b=b.concat(d);return f?c.sortBy(f,e):c}},o=function(){o.superclass.constructor.apply(this,arguments);var a=new p([]),b=this.addAttrs({recordSet:{readOnly:true,getter:function(){return a}},responseType:{required:true},responseSchema:{required:true},requestLogic:{writeOnce:true},internalEvents:{readOnly:true,value:new h.EventTarget}}),f=function(e){var c=b.get("responseType"),d=b.get("responseSchema"),g=[];if(c==4){e=e.split(d.recordDelim);m.each(e,function(j,l){e[l]=j.split(d.fieldDelim)});c=3}if(c==
3){var n=d.fields;m.each(e,function(j,l){g[l]={};m.each(n,function(k,i){g[l][k]=e[l][i]})})}else if(c==1){var x=true,q=e;if(d.resultList){c=d.resultList.split(".");m.each(c,function(j){if(q[j])q=q[j];else x=false})}x?m.each(q,function(j,l){g[l]={};m.each(d.fields,function(k){var i=k.key.split("."),y=null;m.each(i,function(z){if(j[z])y=j[z]});g[l][k.key]=y})}):b.fire("parserError","Result list not found")}else if(c==2){c=h(e).find(d.resultNode)._nodes[0];m.each(c.children()._nodes,function(j){var l=
{};m.each(d.fields,function(k){var i;i=j._node.nodeName!=k.node?j.find(k.node)._DOMNodes[0]:j._node;i=k.attr?i.getAttribute(k.attr):i.firstChild.nodeValue;if(k.parser)switch(k.parser.toLowerCase()){case "float":i=parseFloat(i);break;case "10":i=parseInt(i,10);break}l[k.key]=i});g[g.length]=l})}return new p(g)};b.sendRequest=function(e){b.get("requestLogic")(e,function(c){b.set("tempData",c);var d=c;if(b.get("internalEvents").fire("beforeParse",c))d=f(b.get("tempData"));a=d;b.fire("update",d)},function(c){b.fire("error",
{message:"Request failed",reason:c})})};b.onBeforeParse=function(e){b.get("internalEvents").on("beforeParse",function(c,d){b.set("tempData",e(d))})}};h.extend(o,h.Utility);var s=function(){s.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,f,e){var c=a.get("responseType");h.ajax({url:a.get("url"),data:b,dataType:c==2?"xml":c==4?"text":"json",success:f,error:e})});a.sendRequest(a.get("initialRequest"))};h.extend(s,o);var t=function(){t.superclass.constructor.apply(this,
arguments);var a=this.addAttrs({jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true}}),b=function(f){var e=[];if(v.isHash(f)){A.each(f,function(c,d){e[e.length]=c+"="+d});f=e.join("&")}return f};a.set("requestLogic",function(f,e){var c=jet.DataSource.jsonpCallbacks.length,d=false;jet.DataSource.jsonpCallbacks[c]=function(g){d=true;e(g)};h.Get.script(a.get("url")+b(f)+"&"+a.get("jsonCallbackParam")+"=jet.DataSource.jsonpCallbacks["+c+"]");setTimeout(function(){d||a.fire("error",{message:"Request failed",
reason:"timeout"})},a.get("timeout"))});a.sendRequest(a.get("initialRequest"))};h.extend(t,o);var u=function(){u.superclass.constructor.apply(this,arguments);var a=this.addAttr("localData",{required:true});a.set("requestLogic",function(b,f){var e=a.get("localData");v.isFunction(e)?f(e(b)):f(e)});a.sendRequest(a.get("initialRequest"))};h.extend(u,o);h.add({DataSource:{responseType:{JSON:1,XML:2,TEXT:4,JSARRAY:3},Ajax:s,Get:t,Local:u},Record:w,RecordSet:p})});
