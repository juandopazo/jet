/**
 * @module datasource
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("datasource",function(g){var u=g.Lang,m=g.Array,r=g.Base;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var t=function(b){var a=jet.Record.ids++;this.getId=function(){return a};this.getData=function(){return b};this.get=function(c){return b[c]}};t.hasInstance=function(b){return b instanceof t};var p=function(b){p.superclass.constructor.call(this);var a=[],c=false,d,f=this;m.each(b,function(e){a[a.length]=new t(e)});f.getRecords=function(){return a};this.sortBy=function(e,
i){if(a.length>1){a=f._quicksortSet(a,e,i);c=e;d=i}return f};var o=function(e){if(p.hasInstance(e))e=e.getRecords();else u.isArray(e)||(e=[e]);return e};this.replace=function(e){e=o(e);f.fire("replace",e);return c?f.sortBy(c,d):f};this.push=function(e){a=a.concat(o(e));f.fire("push",a,e);return c?f.sortBy(c,d):f}};g.extend(p,g.EventTarget,{_quicksortSet:function(b,a,c){if(b.length<=1)return b;for(var d=[],f=[],o=b.splice(Math.round(b.length/2),1)[0],e=b.length,i=0;i<e;i++)if(c=="asc")if(b[i].get(a)<=
o.get(a))d[d.length]=b[i];else f[f.length]=b[i];else if(b[i].get(a)<=o.get(a))f[f.length]=b[i];else d[d.length]=b[i];return this._quicksortSet(d,a,c).concat([o]).concat(this._quicksortSet(f,a,c))},getCount:function(){return this.getRecords().length},getRecordById:function(b){var a,c=this.getRecords();m.each(c,function(d){if(d.getId()==b){a=d;return false}});return a}});p.hasInstance=function(b){return b instanceof p};var n=r.create("datasource",g.Utility,[],{ATTRS:{recordSet:{writeOnce:true},responseType:{required:true},
responseSchema:{required:true},initialRequest:{value:{}}}},{_parser:function(b){var a=this.get("responseType"),c=this.get("responseSchema"),d=[];if(a=="text"){b=b.split(c.recordDelim);m.each(b,function(k,l){b[l]=k.split(c.fieldDelim)});a="jsarray"}if(a=="jsarray"){var f=c.fields;m.each(b,function(k,l){d[l]={};m.each(f,function(j,h){d[l][j]=b[l][h]})})}else if(a=="json"){var o=true,e=b;if(c.resultList){a=c.resultList.split(".");m.each(a,function(k){if(e[k])e=e[k];else o=false})}o?m.each(e,function(k,
l){d[l]={};m.each(c.fields,function(j){var h=j.key.split("."),q=null;m.each(h,function(s){if(u.isValue(k[s]))q=k[s]});d[l][j.key]=q})}):this.fire("parserError","Result list not found")}else if(a=="xml"){a=g.context;var i=b.documentElement;(i.nodeName==c.resultNode?g(i):g(i).find(c.resultNode).eq(0)).children().each(function(k){var l={};m.each(c.fields,function(j){var h=k.nodeName!=j.node?g(k).find(j.node)[0]:k,q;if(h){if(j.attr)h=h.getAttribute(j.attr);else if(j.children){q=[];g(h).children().each(function(s){s.firstChild&&
q.push(s.firstChild.nodeValue)});h=q}else h=h.firstChild?h.firstChild.nodeValue:"";if(j.parser)switch(j.parser.toLowerCase()){case "float":h=parseFloat(h);break;case "10":h=parseInt(h,10);break}}l[j.key]=h});d[d.length]=l});g.context=a}return new p(d)},sendRequest:function(b){var a=this,c=this._events;this.handleRequest(b,function(d){a.set("tempData",d);var f=d;if(c.fire("beforeParse",d))f=a._parser(a.get("tempData"));a.set("recordSet",f);a.fire("update",f)},function(d){a.fire("error",{message:"Request failed",
reason:d})});return this},handleRequest:function(b,a){a(b)},onBeforeParse:function(b){var a=this;this._events.on("beforeParse",function(c,d){a.set("tempData",b(d))});return this},initializer:function(){this._events=new g.EventTarget;this.sendRequest(this.get("initialRequest"))}});n.Get=r.create("datasource-get",n,[],{ATTRS:{jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true,setter:function(b){return b.substr(b.length-1)=="?"?b:b+"?"}}}},{handleRequest:function(b,a,c){g.jsonp({url:this.get("url"),
data:b,success:a,jsonCallbackParam:this.get("jsonCallbackParam"),error:c,timeout:this.get("timeout")})}});n.Ajax=r.create("datasource-ajax",n,[],{ATTRS:{url:{required:true}}},{handleRequest:function(b,a,c){g.ajax({url:this.get("url"),data:b,dataType:this.get("responseType"),success:a,error:c})}});n.XDR=r.create("datasource-xdr",n,[],{ATTRS:{url:{required:true}}},{handleRequest:function(b,a,c){this.get("responseType");g.flajax({url:this.get("url"),data:b,dataType:this.get("responseType"),success:a,
error:c})}});n.Local=r.create("datasource-local",n,[],{ATTRS:{localData:{required:true}}},{handleRequest:function(b,a){var c=this.get("localData");u.isFunction(c)?a(c(b)):a(c)}});g.mix(n,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"}});g.add({DataSource:n,Record:t,RecordSet:p})});
