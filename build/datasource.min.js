/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datasource",function(h){if(!jet.DataSource)jet.DataSource={};if(!jet.DataSource.jsonpCallbacks)jet.DataSource.jsonpCallbacks=[];var p=h.Lang,E=h.Hash,n=h.Array,C=h.IO;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var v=function(a){var b=jet.Record.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(e){return a[e]}};p.isRecord=function(a){return a instanceof v};var w=function(a,b,e){if(a.length<=1)return a;for(var g=[],d=[],f=a.splice(Math.round(a.length/
2),1)[0],c=a.length,i=0;i<c;i++)if(e=="asc")if(a[i].get(b)<=f.get(b))g[g.length]=a[i];else d[d.length]=a[i];else if(a[i].get(b)<=f.get(b))d[d.length]=a[i];else g[g.length]=a[i];return w(g,b,e).concat([f]).concat(w(d,b,e))},q=function(a){q.superclass.constructor.call(this);var b=[],e=false,g,d=this;n.each(a,function(c){b[b.length]=new v(c)});d.getRecords=function(){return b};d.getCount=function(){return b.length};d.sortBy=function(c,i){if(b.length>1){b=w(b,c,i);e=c;g=i}return this};var f=function(c){if(p.isRecordSet(c))c=
c.getRecords();else p.isArray(c)||(c=[c]);return c};d.replace=function(c){c=f(c);d.fire("replace",c);return e?d.sortBy(e,g):d};d.push=function(c){b=b.concat(f(c));d.fire("push",b,c);return e?d.sortBy(e,g):d};d.getRecordById=function(c){var i;n.each(b,function(t){if(t.getId()==c){i=t;return false}});return i}};h.extend(q,h.EventTarget);p.isRecordSet=function(a){return a instanceof q};var o=function(){o.superclass.constructor.apply(this,arguments);var a=new q([]),b=this.addAttrs({recordSet:{readOnly:true,
getter:function(){return a}},responseType:{required:true},responseSchema:{required:true},requestLogic:{writeOnce:true}}),e=new h.EventTarget,g=function(d){var f=b.get("responseType"),c=b.get("responseSchema"),i=[];if(f=="text"){d=d.split(c.recordDelim);n.each(d,function(l,m){d[m]=l.split(c.fieldDelim)});f="jsarray"}if(f=="jsarray"){var t=c.fields;n.each(d,function(l,m){i[m]={};n.each(t,function(k,j){i[m][k]=d[m][j]})})}else if(f=="json"){var D=true,u=d;if(c.resultList){f=c.resultList.split(".");n.each(f,
function(l){if(u[l])u=u[l];else D=false})}D?n.each(u,function(l,m){i[m]={};n.each(c.fields,function(k){var j=k.key.split("."),r=null;n.each(j,function(s){if(l[s])r=l[s]});i[m][k.key]=r})}):b.fire("parserError","Result list not found")}else if(f=="xml"){f=h.context;var x=d.documentElement;(x.nodeName==c.resultNode?h(x):h(x).find(c.resultNode).eq(0)).children().each(function(l){var m={};n.each(c.fields,function(k){var j=l.nodeName!=k.node?h(l).find(k.node)[0]:l,r;if(j){if(k.attr)j=j.getAttribute(k.attr);
else if(k.children){r=[];h(j).children().each(function(s){s.firstChild&&r.push(s.firstChild.nodeValue)});j=r}else j=j.firstChild?j.firstChild.nodeValue:"";if(k.parser)switch(k.parser.toLowerCase()){case "float":j=parseFloat(j);break;case "10":j=parseInt(j,10);break}}m[k.key]=j});i[i.length]=m});h.context=f}return new q(i)};b.sendRequest=function(d){b.get("requestLogic")(d,function(f){b.set("tempData",f);var c=f;if(e.fire("beforeParse",f))c=g(b.get("tempData"));a=c;b.fire("update",c)},function(f){b.fire("error",
{message:"Request failed",reason:f})});return b};b.onBeforeParse=function(d){e.on("beforeParse",function(f,c){b.set("tempData",d(c))});return b}};h.extend(o,h.Utility);var y=function(){y.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,e,g){C.ajax({url:a.get("url"),data:b,dataType:a.get("responseType"),success:e,error:g})});a.sendRequest(a.get("initialRequest"))};h.extend(y,o);var z=function(){z.superclass.constructor.apply(this,
arguments);var a=this.addAttrs({jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true,setter:function(e){return e.substr(e.length-1)=="?"?e:e+"?"}}}),b=function(e){var g=[];if(p.isHash(e)){E.each(e,function(d,f){g[g.length]=encodeURIComponent(d)+"="+encodeURIComponent(f)});e=g.join("&")}return e};a.set("requestLogic",function(e,g){var d=jet.DataSource.jsonpCallbacks.length,f=false;jet.DataSource.jsonpCallbacks[d]=function(c){f=true;g(c)};h.Get.script(a.get("url")+b(e)+"&"+a.get("jsonCallbackParam")+
"=jet.DataSource.jsonpCallbacks["+d+"]");setTimeout(function(){f||a.fire("error",{message:"Request failed",reason:"timeout"})},a.get("timeout"))});a.sendRequest(a.get("initialRequest"))};h.extend(z,o);var A=function(){A.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,e,g){a.get("responseType");C.flajax({url:a.get("url"),data:b,dataType:a.get("responseType"),success:e,error:g})});a.sendRequest(a.get("initialRequest"))};h.extend(A,
o);var B=function(){B.superclass.constructor.apply(this,arguments);var a=this.addAttr("localData",{required:true});a.set("requestLogic",function(b,e){var g=a.get("localData");p.isFunction(g)?e(g(b)):e(g)});a.sendRequest(a.get("initialRequest"))};h.extend(B,o);h.mix(o,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"},Ajax:y,Get:z,Local:B,XDR:A});h.add({DataSource:o,Record:v,RecordSet:q})});
