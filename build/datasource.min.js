jet().add("datasource",function(h){if(!jet.DataSource)jet.DataSource={};if(!jet.DataSource.jsonpCallbacks)jet.DataSource.jsonpCallbacks=[];var p=h.Lang,A=h.Hash,n=h.Array,B=h.IO;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var s=function(a){var c=jet.Record.ids++;this.getId=function(){return c};this.getData=function(){return a};this.get=function(g){return a[g]}};p.isRecord=function(a){return a instanceof s};var t=function(a,c,g){if(a.length<=1)return a;for(var d=[],b=[],f=a.splice(Math.round(a.length/
2),1)[0],e=a.length,i=0;i<e;i++)if(g=="asc")if(a[i].get(c)<=f.get(c))d[d.length]=a[i];else b[b.length]=a[i];else if(a[i].get(c)<=f.get(c))b[b.length]=a[i];else d[d.length]=a[i];return t(d,c,g).concat([f]).concat(t(b,c,g))},q=function(a){q.superclass.constructor.call(this);var c=[],g=false,d,b=this;n.each(a,function(e){c[c.length]=new s(e)});b.getRecords=function(){return c};b.getCount=function(){return c.length};b.sortBy=function(e,i){if(c.length>1){c=t(c,e,i);g=e;d=i}return this};var f=function(e){if(p.isRecordSet(e))e=
e.getRecords();else p.isArray(e)||(e=[e]);return e};b.replace=function(e){e=f(e);b.fire("replace",e);return g?b.sortBy(g,d):b};b.push=function(e){c=c.concat(f(e));b.fire("push",c,e);return g?b.sortBy(g,d):b}};h.extend(q,h.EventTarget);p.isRecordSet=function(a){return a instanceof q};var o=function(){o.superclass.constructor.apply(this,arguments);var a=new q([]),c=this.addAttrs({recordSet:{readOnly:true,getter:function(){return a}},responseType:{required:true},responseSchema:{required:true},requestLogic:{writeOnce:true},
internalEvents:{readOnly:true,value:new h.EventTarget}}),g=function(d){var b=c.get("responseType"),f=c.get("responseSchema"),e=[];if(b==4){d=d.split(f.recordDelim);n.each(d,function(k,m){d[m]=k.split(f.fieldDelim)});b=3}if(b==3){var i=f.fields;n.each(d,function(k,m){e[m]={};n.each(i,function(l,j){e[m][l]=d[m][j]})})}else if(b==1){var x=true,r=d;if(f.resultList){b=f.resultList.split(".");n.each(b,function(k){if(r[k])r=r[k];else x=false})}x?n.each(r,function(k,m){e[m]={};n.each(f.fields,function(l){var j=
l.key.split("."),y=null;n.each(j,function(z){if(k[z])y=k[z]});e[m][l.key]=y})}):c.fire("parserError","Result list not found")}else if(b==2){b=h(d).find(f.resultNode)[0];n.each(b.children(),function(k){var m={};n.each(f.fields,function(l){var j;j=k[0].nodeName!=l.node?k.find(l.node)[0]:k[0];j=l.attr?j.getAttribute(l.attr):j.firstChild.nodeValue;if(l.parser)switch(l.parser.toLowerCase()){case "float":j=parseFloat(j);break;case "10":j=parseInt(j,10);break}m[l.key]=j});e[e.length]=m})}return new q(e)};
c.sendRequest=function(d){c.get("requestLogic")(d,function(b){c.set("tempData",b);var f=b;if(c.get("internalEvents").fire("beforeParse",b))f=g(c.get("tempData"));a=f;c.fire("update",f)},function(b){c.fire("error",{message:"Request failed",reason:b})});return c};c.onBeforeParse=function(d){c.get("internalEvents").on("beforeParse",function(b,f){c.set("tempData",d(f))});return c}};h.extend(o,h.Utility);var u=function(){u.superclass.constructor.apply(this,arguments);var a=this.addAttrs({url:{required:true}});
a.set("requestLogic",function(c,g,d){var b=a.get("responseType");B.ajax({url:a.get("url"),data:c,dataType:b==2?"xml":b==4?"text":"json",success:g,error:d})});a.sendRequest(a.get("initialRequest"))};h.extend(u,o);var v=function(){v.superclass.constructor.apply(this,arguments);var a=this.addAttrs({jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true}}),c=function(g){var d=[];if(p.isHash(g)){A.each(g,function(b,f){d[d.length]=b+"="+f});g=d.join("&")}return g};a.set("requestLogic",function(g,
d){var b=jet.DataSource.jsonpCallbacks.length,f=false;jet.DataSource.jsonpCallbacks[b]=function(e){f=true;d(e)};h.Get.script(a.get("url")+c(g)+"&"+a.get("jsonCallbackParam")+"=jet.DataSource.jsonpCallbacks["+b+"]");setTimeout(function(){f||a.fire("error",{message:"Request failed",reason:"timeout"})},a.get("timeout"))});a.sendRequest(a.get("initialRequest"))};h.extend(v,o);var w=function(){w.superclass.constructor.apply(this,arguments);var a=this.addAttr("localData",{required:true});a.set("requestLogic",
function(c,g){var d=a.get("localData");p.isFunction(d)?g(d(c)):g(d)});a.sendRequest(a.get("initialRequest"))};h.extend(w,o);h.mix(o,{responseType:{JSON:1,XML:2,TEXT:4,JSARRAY:3},Ajax:u,Get:v,Local:w});h.add({DataSource:o,Record:s,RecordSet:q})});
