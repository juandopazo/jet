/*
 Copyright (c) 2010, Juan Ignacio Dopazo. All rights reserved.
 Code licensed under the BSD License
 http://code.google.com/p/jet-js/wiki/Licence
*/
jet().add("datasource",function(h){if(!jet.DataSource)jet.DataSource={};if(!jet.DataSource.jsonpCallbacks)jet.DataSource.jsonpCallbacks=[];var p=h.Lang,D=h.Hash,n=h.Array,z=h.IO;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var t=function(a){var b=jet.Record.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(e){return a[e]}};p.isRecord=function(a){return a instanceof t};var u=function(a,b,e){if(a.length<=1)return a;for(var g=[],d=[],f=a.splice(Math.round(a.length/
2),1)[0],c=a.length,i=0;i<c;i++)if(e=="asc")if(a[i].get(b)<=f.get(b))g[g.length]=a[i];else d[d.length]=a[i];else if(a[i].get(b)<=f.get(b))d[d.length]=a[i];else g[g.length]=a[i];return u(g,b,e).concat([f]).concat(u(d,b,e))},q=function(a){q.superclass.constructor.call(this);var b=[],e=false,g,d=this;n.each(a,function(c){b[b.length]=new t(c)});d.getRecords=function(){return b};d.getCount=function(){return b.length};d.sortBy=function(c,i){if(b.length>1){b=u(b,c,i);e=c;g=i}return this};var f=function(c){if(p.isRecordSet(c))c=
c.getRecords();else p.isArray(c)||(c=[c]);return c};d.replace=function(c){c=f(c);d.fire("replace",c);return e?d.sortBy(e,g):d};d.push=function(c){b=b.concat(f(c));d.fire("push",b,c);return e?d.sortBy(e,g):d}};h.extend(q,h.EventTarget);p.isRecordSet=function(a){return a instanceof q};var o=function(){o.superclass.constructor.apply(this,arguments);var a=new q([]),b=this.addAttrs({recordSet:{readOnly:true,getter:function(){return a}},responseType:{required:true},responseSchema:{required:true},requestLogic:{writeOnce:true}}),
e=new h.EventTarget,g=function(d){var f=b.get("responseType"),c=b.get("responseSchema"),i=[];if(f=="text"){d=d.split(c.recordDelim);n.each(d,function(k,m){d[m]=k.split(c.fieldDelim)});f="jsarray"}if(f=="jsarray"){var E=c.fields;n.each(d,function(k,m){i[m]={};n.each(E,function(l,j){i[m][l]=d[m][j]})})}else if(f=="json"){var A=true,s=d;if(c.resultList){f=c.resultList.split(".");n.each(f,function(k){if(s[k])s=s[k];else A=false})}A?n.each(s,function(k,m){i[m]={};n.each(c.fields,function(l){var j=l.key.split("."),
B=null;n.each(j,function(C){if(k[C])B=k[C]});i[m][l.key]=B})}):b.fire("parserError","Result list not found")}else if(f=="xml"){f=h.context;var r=d.documentElement;r=r.nodeName==c.resultNode?h(r):h(r).find(c.resultNode).eq(0);n.each(r.children()._nodes,function(k){var m={};n.each(c.fields,function(l){var j=k.nodeName!=l.node?h(k).find(l.node)._nodes[0]:k;if(j){j=l.attr?j.getAttribute(l.attr):j.firstChild?j.firstChild.nodeValue:"";if(l.parser)switch(l.parser.toLowerCase()){case "float":j=parseFloat(j);
break;case "10":j=parseInt(j,10);break}}m[l.key]=j});i[i.length]=m});h.context=f}return new q(i)};b.sendRequest=function(d){b.get("requestLogic")(d,function(f){b.set("tempData",f);var c=f;if(e.fire("beforeParse",f))c=g(b.get("tempData"));a=c;b.fire("update",c)},function(f){b.fire("error",{message:"Request failed",reason:f})});return b};b.onBeforeParse=function(d){e.on("beforeParse",function(f,c){b.set("tempData",d(c))});return b}};h.extend(o,h.Utility);var v=function(){v.superclass.constructor.apply(this,
arguments);var a=this.addAttrs({url:{required:true}});a.set("requestLogic",function(b,e,g){var d=a.get("responseType");z.ajax({url:a.get("url"),data:b,dataType:d=="xml"?"xml":d=="text"?"text":"json",success:e,error:g})});a.sendRequest(a.get("initialRequest"))};h.extend(v,o);var w=function(){w.superclass.constructor.apply(this,arguments);var a=this.addAttrs({jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true}}),b=function(e){var g=[];if(p.isHash(e)){D.each(e,function(d,f){g[g.length]=
d+"="+f});e=g.join("&")}return e};a.set("requestLogic",function(e,g){var d=jet.DataSource.jsonpCallbacks.length,f=false;jet.DataSource.jsonpCallbacks[d]=function(c){f=true;g(c)};h.Get.script(a.get("url")+b(e)+"&"+a.get("jsonCallbackParam")+"=jet.DataSource.jsonpCallbacks["+d+"]");setTimeout(function(){f||a.fire("error",{message:"Request failed",reason:"timeout"})},a.get("timeout"))});a.sendRequest(a.get("initialRequest"))};h.extend(w,o);var x=function(){x.superclass.constructor.apply(this,arguments);
var a=this.addAttrs({url:{required:true},dataType:{value:"text"}});a.set("requestLogic",function(b,e,g){a.get("responseType");z.flajax({url:a.get("url"),data:b,dataType:a.get("dataType"),success:e,error:g})});a.sendRequest(a.get("initialRequest"))};h.extend(x,o);var y=function(){y.superclass.constructor.apply(this,arguments);var a=this.addAttr("localData",{required:true});a.set("requestLogic",function(b,e){var g=a.get("localData");p.isFunction(g)?e(g(b)):e(g)});a.sendRequest(a.get("initialRequest"))};
h.extend(y,o);h.mix(o,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"},Ajax:v,Get:w,Local:y,XDR:x});h.add({DataSource:o,Record:t,RecordSet:q})});
