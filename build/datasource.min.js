/**
 * @module datasource
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("datasource",function(e){var v=e.Lang,l=e.Array,p=e.Base,u=jet.namespace("Record");if(!u.ids)u.ids=0;var q=function(a){var b=u.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(c){return a[c]}};q.hasInstance=function(a){return a instanceof q};var r=function(a){r.superclass.constructor.call(this);this._sortedBy=false;this._order=null;this._items=l.map(e.Lang.isArray(a)?a:a?[a]:[],function(b){return e.instanceOf(b,q)?b:new q(b)})};e.extend(r,e.EventTarget,
{_sort:function a(b,c){var d=this._items;if(d.length<=1)return d;for(var i=[],m=[],n=d.splice(Math.round(d.length/2),1)[0],s=d.length,f=0;f<s;f++)if(c=="asc")if(d[f].get(b)<=n.get(b))i[i.length]=d[f];else m[m.length]=d[f];else if(d[f].get(b)<=n.get(b))m[m.length]=d[f];else i[i.length]=d[f];return a(i,b,c).concat([n]).concat(a(m,b,c))},replace:function(a){if(this.fire("replace",{data:a})){this._items=a._items?a._items:e.Lang.isArray(a)?a:[a];this._sortedBy&&this.sortBy(this._sortedBy,this._order);
this.fire("afterReplace",{data:this._items})}return this},getRecords:function(){return this._items},sortBy:function(a,b){if(this.size()>1){this._items=this._sort(a,b);this._sortedBy=a;this._order=b}return this},getRecordById:function(a){var b;this.forEach(function(c){if(c.getId()===a)b=c});return b}});e.mix(r.prototype,e.ArrayList.prototype);var k=p.create("datasource",e.Utility,[],{ATTRS:{recordSet:{writeOnce:true},responseType:{required:true},responseSchema:{required:true},initialRequest:{value:{}}}},
{_parser:function(a){var b=this.get("responseType"),c=this.get("responseSchema"),d=[];if(b=="text"){a=a.split(c.recordDelim);l.each(a,function(f,j){a[j]=f.split(c.fieldDelim)});b="jsarray"}if(b=="jsarray"){var i=c.fields;l.each(a,function(f,j){d[j]={};l.each(i,function(h,g){d[j][h]=a[j][g]})})}else if(b=="json"){var m=true,n=a;if(c.resultList){b=c.resultList.split(".");l.each(b,function(f){if(n[f])n=n[f];else m=false})}m?l.each(n,function(f,j){d[j]={};l.each(c.fields,function(h){var g=h.key.split("."),
o=null;l.each(g,function(t){if(v.isValue(f[t]))o=f[t]});d[j][h.key]=o})}):this.fire("parserError",{message:"Result list not found"})}else if(b=="xml"){b=e.config.doc;var s=a.documentElement;(s.nodeName==c.resultNode?e(s):e(s).find(c.resultNode).eq(0)).children().each(function(f){var j={};l.each(c.fields,function(h){var g=f.nodeName!=h.node?e(f).find(h.node)[0]:f,o;if(g){if(h.attr)g=g.getAttribute(h.attr);else if(h.children){o=[];e(g).children().each(function(t){t.firstChild&&o.push(t.firstChild.nodeValue)});
g=o}else g=g.firstChild?g.firstChild.nodeValue:"";if(h.parser)switch(h.parser.toLowerCase()){case "float":g=parseFloat(g);break;case "10":g=parseInt(g,10);break}}j[h.key]=g});d[d.length]=j});e.config.doc=b}return new r(d)},sendRequest:function(a){var b=this,c=this._dsEvents;this.handleRequest(a,function(d){b.set("tempData",d);var i=d;if(c.fire("beforeParse",{data:d}))i=b._parser(b.get("tempData"));b.set("recordSet",i);b.fire("update",{data:i,request:a})},function(d){b.fire("error",{message:"Request failed",
reason:d})});return this},handleRequest:function(a,b){b(a)},onBeforeParse:function(a){var b=this;this._dsEvents.on("beforeParse",function(c){b.set("tempData",a(c.data))});return this},initializer:function(){this._dsEvents=new e.EventTarget;this.sendRequest(this.get("initialRequest"))}});k.Get=p.create("datasource-get",k,[],{ATTRS:{jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true,setter:function(a){return a.substr(a.length-1)=="?"?a:a+"?"}}}},{handleRequest:function(a,b,c){e.jsonp({url:this.get("url"),
data:a,success:b,jsonCallbackParam:this.get("jsonCallbackParam"),error:c,timeout:this.get("timeout")})}});k.Ajax=p.create("datasource-ajax",k,[],{ATTRS:{url:{required:true}}},{handleRequest:function(a,b,c){e.ajax({url:this.get("url"),data:a,dataType:this.get("responseType"),success:b,error:c})}});k.XDR=p.create("datasource-xdr",k,[],{ATTRS:{url:{required:true}}},{handleRequest:function(a,b,c){this.get("responseType");e.flajax({url:this.get("url"),data:a,dataType:this.get("responseType"),success:b,
error:c})}});k.Local=p.create("datasource-local",k,[],{ATTRS:{localData:{required:true}}},{handleRequest:function(a,b){var c=this.get("localData");v.isFunction(c)?b(c(a)):b(c)}});e.mix(k,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"}});e.add({DataSource:k,Record:q,RecordSet:r})});
