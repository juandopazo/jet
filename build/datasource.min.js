/**
 * @module datasource
 * @requires base
 * 
 * Copyright (c) 2011, Juan Ignacio Dopazo. All rights reserved.
 * Code licensed under the BSD License
 * https://github.com/juandopazo/jet/blob/master/LICENSE.md
*/
jet.add("datasource",function(g){var u=g.Lang,m=g.Array,r=g.Base;if(!jet.Record)jet.Record={};if(!jet.Record.ids)jet.Record.ids=0;var t=function(a){var b=jet.Record.ids++;this.getId=function(){return b};this.getData=function(){return a};this.get=function(c){return a[c]}};t.hasInstance=function(a){return a instanceof t};var p=function(a){p.superclass.constructor.call(this);var b=[],c=false,d,f=this;m.each(a,function(e){b[b.length]=new t(e)});f.getRecords=function(){return b};this.sortBy=function(e,
i){if(b.length>1){b=f._quicksortSet(b,e,i);c=e;d=i}return f};var o=function(e){if(p.hasInstance(e))e=e.getRecords();else u.isArray(e)||(e=[e]);return e};this.replace=function(e){e=o(e);f.fire("replace",{data:e});return c?f.sortBy(c,d):f};this.push=function(e){b=b.concat(o(e));f.fire("push",{records:b,data:e});return c?f.sortBy(c,d):f}};g.extend(p,g.EventTarget,{_quicksortSet:function(a,b,c){if(a.length<=1)return a;for(var d=[],f=[],o=a.splice(Math.round(a.length/2),1)[0],e=a.length,i=0;i<e;i++)if(c==
"asc")if(a[i].get(b)<=o.get(b))d[d.length]=a[i];else f[f.length]=a[i];else if(a[i].get(b)<=o.get(b))f[f.length]=a[i];else d[d.length]=a[i];return this._quicksortSet(d,b,c).concat([o]).concat(this._quicksortSet(f,b,c))},getCount:function(){return this.getRecords().length},getRecordById:function(a){var b,c=this.getRecords();m.each(c,function(d){if(d.getId()==a){b=d;return false}});return b}});p.hasInstance=function(a){return a instanceof p};var n=r.create("datasource",g.Utility,[],{ATTRS:{recordSet:{writeOnce:true},
responseType:{required:true},responseSchema:{required:true},initialRequest:{value:{}}}},{_parser:function(a){var b=this.get("responseType"),c=this.get("responseSchema"),d=[];if(b=="text"){a=a.split(c.recordDelim);m.each(a,function(k,l){a[l]=k.split(c.fieldDelim)});b="jsarray"}if(b=="jsarray"){var f=c.fields;m.each(a,function(k,l){d[l]={};m.each(f,function(j,h){d[l][j]=a[l][h]})})}else if(b=="json"){var o=true,e=a;if(c.resultList){b=c.resultList.split(".");m.each(b,function(k){if(e[k])e=e[k];else o=
false})}o?m.each(e,function(k,l){d[l]={};m.each(c.fields,function(j){var h=j.key.split("."),q=null;m.each(h,function(s){if(u.isValue(k[s]))q=k[s]});d[l][j.key]=q})}):this.fire("parserError",{message:"Result list not found"})}else if(b=="xml"){b=g.context;var i=a.documentElement;(i.nodeName==c.resultNode?g(i):g(i).find(c.resultNode).eq(0)).children().each(function(k){var l={};m.each(c.fields,function(j){var h=k.nodeName!=j.node?g(k).find(j.node)[0]:k,q;if(h){if(j.attr)h=h.getAttribute(j.attr);else if(j.children){q=
[];g(h).children().each(function(s){s.firstChild&&q.push(s.firstChild.nodeValue)});h=q}else h=h.firstChild?h.firstChild.nodeValue:"";if(j.parser)switch(j.parser.toLowerCase()){case "float":h=parseFloat(h);break;case "10":h=parseInt(h,10);break}}l[j.key]=h});d[d.length]=l});g.context=b}return new p(d)},sendRequest:function(a){var b=this,c=this._dsEvents;this.handleRequest(a,function(d){b.set("tempData",d);var f=d;if(c.fire("beforeParse",{data:d}))f=b._parser(b.get("tempData"));b.set("recordSet",f);
b.fire("update",{data:f,request:a})},function(d){b.fire("error",{message:"Request failed",reason:d})});return this},handleRequest:function(a,b){b(a)},onBeforeParse:function(a){var b=this;this._dsEvents.on("beforeParse",function(c){b.set("tempData",a(c.data))});return this},initializer:function(){this._dsEvents=new g.EventTarget;this.sendRequest(this.get("initialRequest"))}});n.Get=r.create("datasource-get",n,[],{ATTRS:{jsonCallbackParam:{value:"p"},timeout:{value:1E4},url:{required:true,setter:function(a){return a.substr(a.length-
1)=="?"?a:a+"?"}}}},{handleRequest:function(a,b,c){g.jsonp({url:this.get("url"),data:a,success:b,jsonCallbackParam:this.get("jsonCallbackParam"),error:c,timeout:this.get("timeout")})}});n.Ajax=r.create("datasource-ajax",n,[],{ATTRS:{url:{required:true}}},{handleRequest:function(a,b,c){g.ajax({url:this.get("url"),data:a,dataType:this.get("responseType"),success:b,error:c})}});n.XDR=r.create("datasource-xdr",n,[],{ATTRS:{url:{required:true}}},{handleRequest:function(a,b,c){this.get("responseType");
g.flajax({url:this.get("url"),data:a,dataType:this.get("responseType"),success:b,error:c})}});n.Local=r.create("datasource-local",n,[],{ATTRS:{localData:{required:true}}},{handleRequest:function(a,b){var c=this.get("localData");u.isFunction(c)?b(c(a)):b(c)}});g.mix(n,{responseType:{JSON:"json",XML:"xml",TEXT:"text",JSARRAY:"jsarray"}});g.add({DataSource:n,Record:t,RecordSet:p})});
